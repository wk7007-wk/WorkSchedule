<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ê·¼ë¬´í‘œ</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{font-size:14px;-webkit-tap-highlight-color:transparent;}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans KR',sans-serif;
  background:#1A1A30;
  color:#E0E0EC;
  min-height:100vh;
}
::-webkit-scrollbar{height:6px;width:6px;}
::-webkit-scrollbar-track{background:#1A1A30;}
::-webkit-scrollbar-thumb{background:#2E2E52;border-radius:3px;}

/* ===== Header ===== */
.header{
  z-index:100;
  position:sticky;top:0;
  background:#1A1A30;
  border-bottom:1px solid #2E2E52;
  padding:8px 12px;
  display:flex;align-items:center;justify-content:space-between;
  gap:6px;
}
.header-left{display:flex;align-items:center;gap:6px;}
.header h1{font-size:1.2rem;font-weight:700;color:#E0E0EC;white-space:nowrap;}
.header-center{display:flex;align-items:center;gap:6px;}
.date-display{
  font-size:1.05rem;font-weight:600;color:#FFD700;
  min-width:110px;text-align:center;white-space:nowrap;
}
.header-right{display:flex;align-items:center;gap:6px;}

/* ===== Buttons ===== */
.btn{
  display:inline-flex;align-items:center;justify-content:center;
  border:1px solid #2E2E52;background:#242444;color:#E0E0EC;
  border-radius:8px;cursor:pointer;font-size:.9rem;
  min-width:44px;min-height:44px;padding:8px 12px;
  transition:background .15s,border-color .15s;
  user-select:none;-webkit-user-select:none;
  white-space:nowrap;
}
.btn:active{background:#2E2E52;}
.btn-accent{background:#2ECC71;color:#121225;border-color:#2ECC71;font-weight:600;}
.btn-accent:active{background:#27ae60;}
.btn-danger{background:#E74C3C;color:#fff;border-color:#E74C3C;}
.btn-danger:active{background:#c0392b;}
.btn-gold{background:transparent;border-color:#FFD700;color:#FFD700;}
.btn-gold:active{background:#FFD70022;}
.btn-warning{background:#E67E22;color:#fff;border-color:#E67E22;}
.btn-sm{min-width:36px;min-height:36px;padding:6px 10px;font-size:.8rem;border-radius:6px;}
.nav-btn{font-size:1.1rem;padding:6px 10px;font-weight:700;}
.emp-mgr-btn{font-size:.75rem;padding:4px 10px;min-height:32px;min-width:auto;border-radius:6px;color:#9090A8;border-color:#2E2E52;}

/* ===== Timeline Container ===== */
.timeline-section{
  background:#242444;
}
#timelineScroll{}
#timelineContent{}

/* Vertical Timeline â€” Fit to screen */
.vt-header{
  display:flex;
  background:#1e1e3a;
  border-bottom:2px solid #2E2E52;
}
.vt-time-hdr{
  min-width:44px;max-width:44px;
  display:flex;align-items:center;justify-content:center;
  font-size:.7rem;color:#9090A8;
  border-right:1px solid #2E2E52;
  padding:4px 0;
}
.vt-emp-hdr{
  flex:1;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:4px 1px;
  border-right:1px solid #2E2E5230;
  min-height:36px;
}
.vt-emp-hdr:last-child{border-right:none;}
.vt-emp-hdr .vt-dot{width:8px;height:8px;border-radius:50%;margin-bottom:1px;}
.vt-emp-hdr .vt-name{font-size:.6rem;color:#E0E0EC;font-weight:600;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%;}

.vt-wrapper{
  position:relative;
  height:75vh;
  overflow:hidden;
}
.vt-body{
  display:flex;
  position:relative;
  height:100%;
}
.vt-time-col{
  min-width:44px;max-width:44px;
  border-right:1px solid #2E2E52;
  flex-shrink:0;
  position:relative;
}
.vt-hour-tick{
  position:absolute;left:0;right:0;
  display:flex;align-items:flex-start;justify-content:center;
  font-size:.7rem;color:#9090A8;
  pointer-events:none;
}
.vt-hour-tick .vt-wx{
  font-size:.55rem;color:#9090A8;
  display:block;text-align:center;line-height:1.1;
}
.vt-emp-col{
  flex:1;
  position:relative;
  border-right:1px solid #2E2E5215;
  touch-action:none;
}
.vt-emp-col:last-child{border-right:none;}
.vt-grid-line{
  position:absolute;left:0;right:0;
  border-bottom:1px solid #2E2E5220;
  pointer-events:none;
}
.vt-shift{
  position:absolute;left:1px;right:1px;
  border-radius:3px;
  z-index:2;
  display:flex;align-items:center;justify-content:center;
  flex-direction:column;
  overflow:hidden;
  transition:opacity .15s;
}
.vt-shift:active{opacity:.7;}
.vt-shift .vt-role{font-size:.6rem;font-weight:700;}
.vt-shift .vt-time-label{font-size:.55rem;opacity:.8;}

/* Drag preview */
.vt-drag{
  position:absolute;left:1px;right:1px;
  background:#2ECC7140;
  border:1px dashed #2ECC71;
  border-radius:3px;
  z-index:3;
  pointer-events:none;
  display:flex;align-items:center;justify-content:center;
  font-size:.65rem;color:#2ECC71;font-weight:600;
}

/* Summary row */
.vt-summary{
  display:flex;
  border-top:2px solid #2E2E52;
  background:#1e1e3a;
}
.vt-summary-time{
  min-width:44px;max-width:44px;
  display:flex;align-items:center;justify-content:center;
  font-size:.65rem;color:#FFD700;font-weight:700;
  border-right:1px solid #2E2E52;
  min-height:26px;
}
.vt-summary-cell{
  flex:1;
  display:flex;align-items:center;justify-content:center;
  font-size:.6rem;font-weight:700;color:#FFFFFF;
  min-height:26px;
  border-right:1px solid #2E2E5215;
}
.vt-summary-cell:last-child{border-right:none;}

/* ===== Week Overview ===== */
.week-section{
  margin:8px;
  border:1px solid #2E2E52;
  border-radius:10px;
  overflow:hidden;
  background:#242444;
}
.week-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;
  background:#1e1e3a;
  border-bottom:1px solid #2E2E52;
  cursor:pointer;user-select:none;
  min-height:44px;
}
.week-header h3{font-size:.9rem;color:#9090A8;font-weight:600;}
.week-header .arrow{color:#9090A8;transition:transform .2s;font-size:.8rem;}
.week-header .arrow.open{transform:rotate(180deg);}
.week-body{
  max-height:0;overflow:hidden;
  transition:max-height .3s ease;
}
.week-body.open{max-height:500px;}

.week-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:1px;
  padding:8px;
}
.week-day{
  background:#1A1A30;
  border:1px solid #2E2E52;
  border-radius:6px;
  padding:6px 4px;
  text-align:center;
  cursor:pointer;
  transition:background .15s;
  min-height:60px;
}
.week-day:active{background:#2A2A45;}
.week-day.today{border-color:#FFD700;}
.week-day .day-label{font-size:.7rem;color:#707088;margin-bottom:2px;}
.week-day .day-date{font-size:.8rem;font-weight:600;color:#E0E0EC;margin-bottom:4px;}
.week-day .day-date.sun{color:#E74C3C;}
.week-day .day-date.sat{color:#4A9EFF;}
.week-day .day-dots{display:flex;flex-wrap:wrap;justify-content:center;gap:3px;}
.week-day .day-dots .wdot{width:8px;height:8px;border-radius:50%;}
.week-day .day-count{font-size:.65rem;color:#9090A8;margin-top:3px;}

.week-offs{
  padding:8px 14px;
  border-top:1px solid #2E2E52;
  display:flex;flex-wrap:wrap;gap:8px;
  font-size:.75rem;color:#9090A8;
}
.week-offs .off-chip{
  display:flex;align-items:center;gap:4px;
  background:#1A1A30;
  padding:3px 8px;
  border-radius:4px;
}
.week-offs .off-chip .odot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.week-offs .off-chip .off-text{color:#E0E0EC;}

/* Sections below timeline */

/* ===== Info Bar ===== */
.info-section-inner{
  margin:8px;
  border:1px solid #2E2E52;
  border-radius:10px;
  overflow:hidden;
  background:#242444;
}
.info-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;
  background:#1e1e3a;
  border-bottom:1px solid #2E2E52;
  cursor:pointer;user-select:none;
  min-height:44px;
}
.info-header h3{font-size:.9rem;color:#9090A8;font-weight:600;}
.info-header .arrow{color:#9090A8;transition:transform .2s;font-size:.8rem;}
.info-header .arrow.open{transform:rotate(180deg);}
.info-body{
  max-height:0;overflow:hidden;
  transition:max-height .3s ease;
}
.info-body.open{max-height:400px;}
.info-body-inner{padding:12px 14px;}

.info-row{
  display:flex;align-items:center;gap:10px;
  padding:8px 0;
  border-bottom:1px solid #2E2E5240;
  font-size:.85rem;
}
.info-row:last-child{border-bottom:none;}
.info-icon{font-size:1.1rem;flex-shrink:0;width:28px;text-align:center;}
.info-label{color:#9090A8;flex-shrink:0;min-width:60px;}
.info-value{color:#E0E0EC;flex:1;}
.info-placeholder{color:#707088;font-style:italic;font-size:.8rem;}

/* ===== Share Section ===== */
.share-section{
  margin:8px;
  border:1px solid #2E2E52;
  border-radius:10px;
  overflow:hidden;
}
.share-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;
  background:#242444;
  cursor:pointer;user-select:none;
  min-height:44px;
}
.share-header h3{font-size:.9rem;color:#9090A8;font-weight:600;}
.share-header .arrow{color:#9090A8;transition:transform .2s;font-size:.8rem;}
.share-header .arrow.open{transform:rotate(180deg);}
.share-body{
  max-height:0;overflow:hidden;padding:0;
  transition:max-height .3s ease,padding .3s ease;
  background:#1A1A35;
}
.share-body.open{max-height:200px;padding:12px 14px;}
.share-btns{display:flex;gap:10px;flex-wrap:wrap;}

/* ===== Modals ===== */
.modal-overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,.65);
  z-index:200;
  display:flex;align-items:flex-end;justify-content:center;
  opacity:0;pointer-events:none;
  transition:opacity .2s;
}
.modal-overlay.active{opacity:1;pointer-events:auto;}
.modal-content{
  background:linear-gradient(180deg,#242444,#1A1A35);
  border:1px solid #2E2E52;
  border-radius:16px 16px 0 0;
  width:100%;max-width:480px;
  max-height:85vh;
  overflow-y:auto;
  padding:20px;
  transform:translateY(100%);
  transition:transform .3s cubic-bezier(.22,.68,0,1);
  position:relative;
}
.modal-overlay.active .modal-content{transform:translateY(0);}
@media(min-width:600px){
  .modal-content{border-radius:16px;margin-bottom:40px;}
  .modal-overlay{align-items:center;}
}
.modal-title{font-size:1.1rem;font-weight:700;margin-bottom:16px;color:#E0E0EC;}
.modal-close{
  position:absolute;top:12px;right:16px;
  font-size:1.5rem;color:#9090A8;cursor:pointer;
  width:44px;height:44px;display:flex;align-items:center;justify-content:center;
  border:none;background:none;
}
.modal-footer{
  display:flex;gap:10px;margin-top:16px;
  padding-top:14px;border-top:1px solid #2E2E52;
}
.modal-footer .btn{flex:1;}

/* Form */
.form-group{margin-bottom:14px;}
.form-group label{display:block;font-size:.85rem;color:#9090A8;margin-bottom:5px;font-weight:500;}
.form-input{
  width:100%;padding:10px 12px;
  background:#1A1A30;border:1px solid #2E2E52;
  border-radius:8px;color:#E0E0EC;font-size:.95rem;
  outline:none;min-height:44px;
}
.form-input:focus{border-color:#2ECC71;}
select.form-input{
  appearance:none;-webkit-appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%239090A8' stroke-width='2' fill='none'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 12px center;
}

/* Color picker */
.color-picker{display:flex;gap:8px;flex-wrap:wrap;}
.color-swatch{
  width:40px;height:40px;border-radius:50%;
  cursor:pointer;border:3px solid transparent;
  transition:border-color .15s,transform .15s;
}
.color-swatch:active{transform:scale(.9);}
.color-swatch.selected{border-color:#FFFFFF;transform:scale(1.1);}

/* Shift modal: Employee chips */
.emp-chips{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;}
.emp-chip{
  display:flex;align-items:center;gap:5px;
  padding:6px 12px;
  background:#1A1A30;border:2px solid #2E2E52;
  border-radius:20px;cursor:pointer;
  font-size:.85rem;color:#E0E0EC;
  transition:background .15s,border-color .15s;
  min-height:40px;
}
.emp-chip .chip-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.emp-chip.selected{border-color:#2ECC71;background:#2ECC7118;}

/* Role pills */
.role-pills{display:flex;gap:8px;margin-bottom:14px;}
.role-pill{
  padding:6px 16px;
  background:#2A2A45;border:1px solid #2E2E52;
  border-radius:20px;cursor:pointer;
  font-size:.85rem;color:#E0E0EC;
  transition:background .15s,border-color .15s;
  min-height:36px;
  display:flex;align-items:center;
}
.role-pill.selected{background:#2ECC71;color:#121225;border-color:#2ECC71;font-weight:600;}

/* Presets */
.presets{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;}
.preset-btn{
  padding:8px 14px;
  background:#2A2A45;border:1px solid #2E2E52;
  border-radius:8px;color:#E0E0EC;cursor:pointer;
  font-size:.82rem;min-height:40px;
  transition:background .1s;
}
.preset-btn:active{background:#2ECC71;color:#121225;}

/* Time picker grid */
.time-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(68px,1fr));
  gap:5px;
  max-height:160px;
  overflow-y:auto;
  padding:4px 0;
}
.time-option{
  padding:7px 4px;text-align:center;
  background:#1A1A30;border:1px solid #2E2E52;
  border-radius:6px;cursor:pointer;
  font-size:.82rem;color:#E0E0EC;
  min-height:36px;
  display:flex;align-items:center;justify-content:center;
  transition:background .1s,border-color .1s;
}
.time-option:active,.time-option.selected{
  background:#2ECC71;color:#121225;border-color:#2ECC71;font-weight:600;
}

/* Employee list in emp modal */
.emp-list-item{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 12px;
  background:#1A1A30;border:1px solid #2E2E52;
  border-radius:8px;margin-bottom:8px;
  min-height:48px;gap:8px;
}
.emp-list-item .emp-dot{width:14px;height:14px;border-radius:50%;flex-shrink:0;}
.emp-list-item .emp-info{flex:1;min-width:0;}
.emp-list-item .emp-info .name{font-weight:600;font-size:.9rem;}
.emp-list-item .emp-info .detail{font-size:.72rem;color:#9090A8;margin-top:2px;}
.emp-list-actions{display:flex;gap:6px;}

/* Month view modal */
.month-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:4px;
  margin-top:8px;
}
.month-dow-label{
  text-align:center;font-size:.7rem;color:#707088;padding:4px 0;
}
.month-day-cell{
  text-align:center;padding:6px 2px;
  background:#1A1A30;border:1px solid #2E2E52;
  border-radius:6px;cursor:pointer;
  min-height:44px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  transition:background .15s;
}
.month-day-cell:active{background:#2A2A45;}
.month-day-cell.empty{background:transparent;border-color:transparent;cursor:default;}
.month-day-cell.today{border-color:#FFD700;}
.month-day-cell.has-staff{background:#2ECC7115;border-color:#2ECC7140;}
.month-day-cell .md-num{font-size:.85rem;font-weight:600;color:#E0E0EC;}
.month-day-cell .md-num.sun{color:#E74C3C;}
.month-day-cell .md-num.sat{color:#4A9EFF;}
.month-day-cell .md-count{font-size:.6rem;color:#2ECC71;margin-top:2px;}

/* ===== Toast ===== */
.toast{
  position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);
  background:#2ECC71;color:#121225;
  padding:10px 20px;border-radius:8px;
  font-size:.9rem;font-weight:600;
  opacity:0;pointer-events:none;
  transition:opacity .3s,transform .3s;
  z-index:999;white-space:nowrap;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* ===== Loading ===== */
.loading{
  display:flex;align-items:center;justify-content:center;
  padding:40px;color:#9090A8;font-size:.95rem;
}
.spinner{
  width:24px;height:24px;border:3px solid #2E2E52;
  border-top-color:#2ECC71;border-radius:50%;
  animation:spin .6s linear infinite;margin-right:10px;
}
@keyframes spin{to{transform:rotate(360deg);}}

/* ===== AI Section ===== */
.ai-section{
  margin:8px;
  border:1px solid #2E2E52;
  border-radius:10px;
  overflow:hidden;
  background:#242444;
}
.ai-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;
  background:#1e1e3a;
  border-bottom:1px solid #2E2E52;
  cursor:pointer;user-select:none;
  min-height:44px;
}
.ai-header h3{font-size:.9rem;color:#FFD700;font-weight:600;}
.ai-header .arrow{color:#9090A8;transition:transform .2s;font-size:.8rem;}
.ai-header .arrow.open{transform:rotate(180deg);}
.ai-body{
  max-height:0;overflow:hidden;
  transition:max-height .3s ease;
}
.ai-body.open{max-height:600px;}
.ai-body-inner{padding:12px 14px;}
.ai-chat-list{
  max-height:280px;overflow-y:auto;
  padding:8px 14px;
  display:flex;flex-direction:column;gap:8px;
}
.ai-msg{
  padding:8px 12px;border-radius:10px;
  font-size:.85rem;line-height:1.4;
  max-width:90%;word-break:break-word;
}
.ai-msg.user{
  align-self:flex-end;
  background:#2ECC7128;border:1px solid #2ECC7140;
  color:#E0E0EC;
}
.ai-msg.ai{
  align-self:flex-start;
  background:#1A1A30;border:1px solid #2E2E52;
  color:#E0E0EC;
}
.ai-msg.ai .ai-apply-btn{
  display:inline-block;
  margin-top:6px;padding:4px 12px;
  background:#2ECC71;color:#121225;
  border:none;border-radius:6px;cursor:pointer;
  font-size:.8rem;font-weight:600;
}
.ai-msg.ai .ai-apply-btn:active{background:#27ae60;}
.ai-msg.loading{color:#9090A8;font-style:italic;}
.ai-input-area{
  display:flex;gap:8px;padding:8px 14px;
  border-top:1px solid #2E2E52;
}
.ai-input-area .form-input{flex:1;min-height:40px;font-size:.9rem;}
.ai-quick-btns{
  display:flex;gap:6px;padding:4px 14px 10px;flex-wrap:wrap;
}
.ai-quick-btns .btn{font-size:.75rem;padding:4px 10px;min-height:32px;min-width:auto;color:#9090A8;}

/* ===== Logistics Warning ===== */
.logistics-warn{color:#E74C3C;font-weight:600;font-size:.82rem;}
.logistics-ok{color:#2ECC71;font-size:.82rem;}

/* ===== Calendar buttons ===== */
.cal-section{margin-top:10px;padding-top:10px;border-top:1px solid #2E2E52;}
.cal-btns{display:flex;gap:6px;flex-wrap:wrap;}
.cal-btn{
  display:flex;align-items:center;gap:4px;
  padding:6px 10px;background:#1A1A30;border:1px solid #2E2E52;
  border-radius:6px;color:#E0E0EC;cursor:pointer;font-size:.78rem;
  min-height:36px;transition:background .1s;
}
.cal-btn:active{background:#2A2A45;}
.cal-btn .cdot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}

/* ===== Contact sync ===== */
.contact-import-btn{
  width:100%;margin-top:8px;
  display:flex;align-items:center;justify-content:center;gap:6px;
}

/* ===== Responsive ===== */
@media(max-width:400px){
  .header h1{font-size:1rem;}
  .date-display{font-size:.9rem;min-width:90px;}
  .vt-time-hdr,.vt-time-col,.vt-summary-time{min-width:38px;max-width:38px;}
  .vt-emp-hdr .vt-name{font-size:.55rem;}
  .vt-emp-hdr{min-height:30px;padding:3px 1px;}
  .vt-shift .vt-role{font-size:.5rem;}
  .vt-shift .vt-time-label{font-size:.45rem;}
  .vt-hour-tick{font-size:.6rem;}
  .vt-emp-hdr{min-height:26px;}
}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-left">
    <h1>ê·¼ë¬´í‘œ</h1>
    <button class="btn emp-mgr-btn" id="empMgrBtn">ì§ì›</button>
    <button class="btn emp-mgr-btn" id="dayoffMgrBtn" style="color:#E74C3C;border-color:#E74C3C55;">íœ´ë¬´</button>
  </div>
  <div class="header-center">
    <button class="btn nav-btn" id="prevDay" aria-label="ì´ì „ ë‚ ">â—€</button>
    <span class="date-display" id="dateDisplay"></span>
    <button class="btn nav-btn" id="nextDay" aria-label="ë‹¤ìŒ ë‚ ">â–¶</button>
  </div>
  <div class="header-right">
    <button class="btn btn-sm" id="refreshBtn" aria-label="ìƒˆë¡œê³ ì¹¨" style="font-size:1rem;padding:6px 8px;color:#9090A8;">â†»</button>
    <button class="btn btn-sm btn-gold" id="monthViewBtn" aria-label="ì›”ê°„ ë³´ê¸°" style="font-size:1rem;padding:6px 8px;">ğŸ“…</button>
  </div>
</div>

<!-- ë‹¹ì¼ ë¸Œë¦¬í•‘ íŒ¨ë„ -->
<div id="briefingPanel" style="background:#1e1e3a;border-bottom:1px solid #2E2E52;padding:6px 10px;font-size:.75rem;"></div>

<!-- Timeline Gauge View -->
<div class="timeline-section" id="timelineSection">
  <div class="loading" id="loadingIndicator" style="flex-shrink:0;"><div class="spinner"></div>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  <div id="timelineScroll" style="display:none;">
    <div id="timelineContent"></div>
  </div>
</div>

<!-- Week Overview -->
<div class="week-section">
  <div class="week-header" id="weekToggle">
    <h3>ì£¼ê°„ ê°œìš”</h3>
    <span class="arrow" id="weekArrow">â–¼</span>
  </div>
  <div class="week-body" id="weekBody">
    <div class="week-grid" id="weekGrid"></div>
    <div class="week-offs" id="weekOffs"></div>
  </div>
</div>

<!-- Info Bar -->
<div class="info-section">
  <div class="info-header" id="infoToggle">
    <h3>ì •ë³´</h3>
    <span class="arrow" id="infoArrow">â–¼</span>
  </div>
  <div class="info-body" id="infoBody">
    <div class="info-body-inner">
      <div class="info-row">
        <span class="info-icon">ğŸŒ¤</span>
        <span class="info-label">ë‚ ì”¨</span>
        <span class="info-value" id="weatherInfo"><span class="info-placeholder">ë¡œë”©ì¤‘...</span></span>
      </div>
      <div class="info-row">
        <span class="info-icon">âš½</span>
        <span class="info-label">ê²½ê¸°</span>
        <span class="info-value" id="sportsInfo"><span class="info-placeholder">ë¡œë”©ì¤‘...</span></span>
      </div>
      <div class="info-row">
        <span class="info-icon">ğŸšš</span>
        <span class="info-label">ë¬¼ë¥˜</span>
        <span class="info-value" id="logisticsInfo"><span class="info-placeholder">ì²´í¬ì¤‘...</span></span>
      </div>
    </div>
  </div>
</div>

<!-- AI Scheduling Section -->
<div class="ai-section">
  <div class="ai-header" id="aiToggle">
    <h3>AI ìŠ¤ì¼€ì¤„ë§</h3>
    <span class="arrow" id="aiArrow">â–¼</span>
  </div>
  <div class="ai-body" id="aiBody">
    <div class="ai-chat-list" id="aiChatList">
      <div class="ai-msg ai" style="color:#9090A8;font-size:.8rem;">ìŠ¤ì¼€ì¤„ ìš”ì²­ì„ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ: "ë‚´ì¼ ìŠ¤ì¼€ì¤„ ì§œì¤˜", "ì´ë²ˆì£¼ ë°°ì¹˜í•´ì¤˜"</div>
    </div>
    <div class="ai-input-area">
      <input class="form-input" id="aiInput" type="text" placeholder="ìŠ¤ì¼€ì¤„ ìš”ì²­..." enterkeyhint="send">
      <button class="btn btn-accent btn-sm" id="aiSendBtn" style="min-width:52px;">ì „ì†¡</button>
    </div>
    <div class="ai-quick-btns">
      <button class="btn btn-sm ai-quick" data-prompt="ì˜¤ëŠ˜ ìŠ¤ì¼€ì¤„ ì§œì¤˜">ì˜¤ëŠ˜</button>
      <button class="btn btn-sm ai-quick" data-prompt="ë‚´ì¼ ìŠ¤ì¼€ì¤„ ì§œì¤˜">ë‚´ì¼</button>
      <button class="btn btn-sm ai-quick" data-prompt="ì´ë²ˆì£¼ ìŠ¤ì¼€ì¤„ ì§œì¤˜">ì´ë²ˆì£¼</button>
      <button class="btn btn-sm ai-quick" data-prompt="ë‚´ì¼ ì¸ì› ë¶€ì¡±í•œ ì‹œê°„ëŒ€ ì•Œë ¤ì¤˜">ë¶€ì¡±ì²´í¬</button>
    </div>
  </div>
</div>

<!-- Share Section -->
<div class="share-section">
  <div class="share-header" id="shareToggle">
    <h3>ê³µìœ </h3>
    <span class="arrow" id="shareArrow">â–¼</span>
  </div>
  <div class="share-body" id="shareBody">
    <div class="share-btns">
      <button class="btn btn-accent" id="shareImageBtn">ì´ë¯¸ì§€ ê³µìœ </button>
      <button class="btn" id="shareTextBtn">í…ìŠ¤íŠ¸ ê³µìœ </button>
      <button class="btn" id="copyUrlBtn">URL ë³µì‚¬</button>
    </div>
    <div class="cal-section">
      <div style="font-size:.8rem;color:#9090A8;margin-bottom:6px;">ìº˜ë¦°ë” (.ics) â€” ì•„ì´í°/ê°¤ëŸ­ì‹œ í˜¸í™˜</div>
      <div class="cal-btns" id="calBtns"></div>
      <button class="btn btn-sm" id="calAllBtn" style="margin-top:6px;width:100%;font-size:.8rem;">ì „ì²´ ìº˜ë¦°ë” ë‹¤ìš´ë¡œë“œ</button>
    </div>
  </div>
</div>

<!-- Shift Input Modal -->
<div class="modal-overlay" id="shiftModal">
  <div class="modal-content">
    <button class="modal-close" id="shiftModalClose">&times;</button>
    <div class="modal-title" id="shiftTitle">ê·¼ë¬´ ì¶”ê°€</div>
    <div class="form-group">
      <label>ì§ì› ì„ íƒ</label>
      <div class="emp-chips" id="shiftEmpChips"></div>
    </div>
    <div class="form-group">
      <label>ì—­í•  (ë³µìˆ˜ ì„ íƒ ì‹œ 0.5ëª…ì”© ê³„ì‚°)</label>
      <div class="role-pills" id="shiftRolePills">
        <div class="role-pill" data-role="ì£¼ë°©">ğŸ³ ì£¼ë°©</div>
        <div class="role-pill" data-role="ë°°ë‹¬">ğŸ›µ ë°°ë‹¬</div>
      </div>
    </div>
    <div class="form-group">
      <label>ë¹ ë¥¸ ì„ íƒ</label>
      <div class="presets" id="shiftPresets">
        <button class="preset-btn" data-start="10:00" data-end="18:00">ì˜¤í”ˆ 10-18</button>
        <button class="preset-btn" data-start="14:00" data-end="22:00">ì¤‘ê°„ 14-22</button>
        <button class="preset-btn" data-start="16:00" data-end="00:00">ë§ˆê° 16-24</button>
        <button class="preset-btn" data-start="10:00" data-end="03:00">í’€ 10-03</button>
      </div>
    </div>
    <div class="form-group">
      <label>ì‹œì‘ ì‹œê°„</label>
      <div class="time-grid" id="startTimeGrid"></div>
    </div>
    <div class="form-group">
      <label>ì¢…ë£Œ ì‹œê°„</label>
      <div class="time-grid" id="endTimeGrid"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" id="shiftDelete" style="display:none;">ì‚­ì œ</button>
      <button class="btn" id="shiftCancel">ì·¨ì†Œ</button>
      <button class="btn btn-accent" id="shiftSave">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Month View Modal -->
<div class="modal-overlay" id="monthModal">
  <div class="modal-content">
    <button class="modal-close" id="monthModalClose">&times;</button>
    <div class="modal-title" id="monthModalTitle">ì›”ê°„ ë³´ê¸°</div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
      <button class="btn btn-sm nav-btn" id="monthPrev">â—€</button>
      <span id="monthModalLabel" style="font-size:1rem;font-weight:600;color:#FFD700;"></span>
      <button class="btn btn-sm nav-btn" id="monthNext">â–¶</button>
    </div>
    <div class="month-grid" id="monthGrid"></div>
  </div>
</div>

<!-- Employee Management Modal -->
<div class="modal-overlay" id="empModal">
  <div class="modal-content">
    <button class="modal-close" id="empModalClose">&times;</button>
    <div class="modal-title">ì§ì›ê´€ë¦¬</div>
    <div id="empList"></div>
    <button class="btn btn-accent" id="addEmpBtn" style="width:100%;margin-top:8px;">+ ì§ì› ì¶”ê°€</button>
    <button class="btn contact-import-btn" id="contactImportBtn">ì—°ë½ì²˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°</button>
  </div>
</div>

<!-- Employee Edit Modal -->
<div class="modal-overlay" id="empEditModal">
  <div class="modal-content">
    <button class="modal-close" id="empEditClose">&times;</button>
    <div class="modal-title" id="empEditTitle">ì§ì› ì¶”ê°€</div>
    <div class="form-group">
      <label>ì´ë¦„</label>
      <input class="form-input" id="empName" type="text" placeholder="í™ê¸¸ë™">
    </div>
    <div class="form-group">
      <label>ì „í™”ë²ˆí˜¸</label>
      <input class="form-input" id="empPhone" type="tel" placeholder="010-0000-0000">
    </div>
    <div class="form-group">
      <label>ìƒ‰ìƒ</label>
      <div class="color-picker" id="colorPicker"></div>
    </div>
    <div class="form-group">
      <label>ì—­í• </label>
      <select class="form-input" id="empRole">
        <option value="">ë¯¸ì§€ì •</option>
        <option value="ì£¼ë°©">ì£¼ë°©</option>
        <option value="ë°°ë‹¬">ë°°ë‹¬</option>
        <option value="ì˜¤ì „">ì˜¤ì „</option>
      </select>
    </div>
    <div class="form-group">
      <label>ì‹œê¸‰</label>
      <input class="form-input" id="empHourlyRate" type="number" placeholder="0" min="0">
    </div>
    <div class="form-group">
      <label>ì£¼ê°„ ìµœëŒ€ ì‹œê°„</label>
      <input class="form-input" id="empMaxHours" type="number" placeholder="40" min="0" max="168">
    </div>
    <div class="modal-footer">
      <button class="btn" id="empEditCancel">ì·¨ì†Œ</button>
      <button class="btn btn-accent" id="empEditSave">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Day-off Management Modal -->
<div class="modal-overlay" id="dayoffModal">
  <div class="modal-content">
    <button class="modal-close" id="dayoffModalClose">&times;</button>
    <div class="modal-title">íœ´ë¬´ ê´€ë¦¬</div>
    <div style="margin-bottom:10px;">
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;">
        <select class="form-input" id="dayoffEmpSelect" style="flex:1;"></select>
        <input class="form-input" id="dayoffDate" type="date" style="flex:1;">
        <button class="btn btn-accent btn-sm" id="dayoffAddBtn">ì¶”ê°€</button>
      </div>
      <div style="margin-bottom:8px;">
        <textarea class="form-input" id="dayoffBulkInput" placeholder="ì—¬ëŸ¬ í˜•íƒœë¡œ ì…ë ¥ ê°€ëŠ¥:&#10;ì´ì›ê·œ 2/25, 2/26&#10;ê¶Œì—°ì˜¥ 3/1~3/3&#10;ë¦¬ 2025-03-05&#10;íˆì˜¤ í™”,ëª© (ì´ë²ˆì£¼)" rows="4" style="font-size:.8rem;"></textarea>
        <button class="btn btn-sm" id="dayoffBulkBtn" style="width:100%;margin-top:4px;color:#FFD700;border-color:#FFD700;">ì¼ê´„ ë“±ë¡</button>
      </div>
    </div>
    <div style="font-size:.85rem;color:#FFD700;font-weight:600;margin-bottom:6px;" id="dayoffListTitle">ë“±ë¡ëœ íœ´ë¬´</div>
    <div id="dayoffList" style="max-height:300px;overflow-y:auto;"></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
(function(){
'use strict';

// ============================================================
// Firebase Config
// ============================================================
const FB_BASE = 'https://poskds-4ba60-default-rtdb.asia-southeast1.firebasedatabase.app';
const FB_WS = FB_BASE + '/workschedule';
const FB_EMPLOYEES = FB_WS + '/employees';
const FB_SCHEDULES = FB_WS + '/schedules';
const FB_SETTINGS = FB_WS + '/settings';

// ============================================================
// Timeline hours: 06~03(+1) = 22 columns
// ============================================================
const TL_HOURS = [6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,0,1,2,3];
const TL_START_HOUR = 6; // 06:00
const TL_TOTAL_HOURS = 22; // 06:00 ~ 03:00(+1) = 21h span, but 22 columns (inclusive)

// ============================================================
// Default employees
// ============================================================
const DEFAULT_EMPLOYEES = {
  emp1: {name:'ì´ì›ê·œ', color:'#FF6B6B', phone:'', role:'', hourlyRate:0, maxHours:40},
  emp2: {name:'ê¶Œì—°ì˜¥', color:'#4ECDC4', phone:'', role:'', hourlyRate:0, maxHours:40},
  emp3: {name:'ë¦¬', color:'#45B7D1', phone:'', role:'', hourlyRate:0, maxHours:40},
  emp4: {name:'íˆì˜¤', color:'#96CEB4', phone:'', role:'', hourlyRate:0, maxHours:40},
  emp5: {name:'ë°•ì¤€ëª¨', color:'#FFEAA7', phone:'', role:'', hourlyRate:0, maxHours:40},
  emp6: {name:'ì „ë¬˜ì •', color:'#DDA0DD', phone:'', role:'', hourlyRate:0, maxHours:40},
  emp7: {name:'ëŒ€ìœ ', color:'#F0A500', phone:'', role:'', hourlyRate:0, maxHours:40}
};

// ============================================================
// ê³ ì • ìŠ¤ì¼€ì¤„ (ìë™ ì…ë ¥)
// ============================================================
// ì§ì›ì´ë¦„ â†’ {start, end, role, type}
// type: 'fixed'=ë§¤ì¼ ê³ ì •, 'variable'=ë³€ì¹™(ìˆ˜ë™)
const FIXED_SCHEDULES = {
  'ì´ì›ê·œ': {start:'10:00', end:'20:00', role:'ì£¼ë°©,ë°°ë‹¬', type:'fixed'},
  'íˆì˜¤':   {start:'18:00', end:'03:00', role:'ì£¼ë°©,ë°°ë‹¬', type:'fixed'},
  'ë¦¬':     {start:'18:00', end:'03:00', role:'ì£¼ë°©,ë°°ë‹¬', type:'fixed'},
  'ë°•ì¤€ëª¨': {start:'17:00', end:'03:00', role:'ì£¼ë°©,ë°°ë‹¬', type:'fixed'},
  'ì „ë¬˜ì •': {start:'17:00', end:'03:00', role:'ì£¼ë°©,ë°°ë‹¬', type:'fixed'},
  'ëŒ€ìœ ':   {start:null, end:null, role:'', type:'variable'}, // ë³€ì¹™ â€” ìˆ˜ë™ ì…ë ¥
};

function getFixedSchedule(empName){
  return FIXED_SCHEDULES[empName] || null;
}

function findEmpIdByName(name){
  for(const id in employees){
    if(employees[id].name === name) return id;
  }
  return null;
}

// ============================================================
// State
// ============================================================
let currentDate = new Date();
let employees = {};
let daySchedule = {}; // schedule for currentDate
let weekSchedules = {}; // schedules for the week (dateStr -> data)
let monthScheduleSummary = {}; // monthKey -> {dateStr: count}
let sseEmployees = null;
let sseSchedule = null;
let sseGeneration = 0;
let monthViewYear, monthViewMonth;
let dataLoaded = false;

// ============================================================
// DOM refs
// ============================================================
const $ = id => document.getElementById(id);
const $dateDisplay = $('dateDisplay');
const $loading = $('loadingIndicator');
const $timelineScroll = $('timelineScroll');
const $timelineContent = $('timelineContent');
const $weekGrid = $('weekGrid');
const $weekOffs = $('weekOffs');
const $shiftModal = $('shiftModal');
const $monthModal = $('monthModal');
const $empModal = $('empModal');
const $empEditModal = $('empEditModal');
const $toast = $('toast');

// ============================================================
// Utility
// ============================================================
function pad(n){ return n < 10 ? '0'+n : ''+n; }
function dateStr(d){ return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate()); }
function dateKey(d){ return dateStr(d); }
function daysInMonth(y,m){ return new Date(y,m,0).getDate(); }
const DOW_KR = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
const DOW_KR_SHORT = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

function showToast(msg){
  $toast.textContent = msg;
  $toast.classList.add('show');
  setTimeout(()=> $toast.classList.remove('show'), 2000);
}
function openModal(el){ el.classList.add('active'); }
function closeModal(el){ el.classList.remove('active'); }

function isSameDay(a,b){
  return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
}

function getMonday(d){
  const dt = new Date(d);
  const day = dt.getDay();
  const diff = day === 0 ? -6 : 1 - day;
  dt.setDate(dt.getDate() + diff);
  dt.setHours(0,0,0,0);
  return dt;
}

// Convert time string "HH:MM" to minutes from 06:00
// Hours 00-05 are treated as next day (24-29)
function timeToMinutesFrom6(timeStr){
  const [h,m] = timeStr.split(':').map(Number);
  let hour = h;
  if(hour < 6) hour += 24; // next day: 00->24, 01->25, ..., 05->29
  return (hour - 6) * 60 + m;
}

// Calculate hours between start and end
function calcHours(start, end){
  let sm = timeToMinutesFrom6(start);
  let em = timeToMinutesFrom6(end);
  if(em <= sm) em += 24*60;
  return Math.round((em - sm)/60*10)/10;
}

// Get the percentage position of a time in the timeline (0-100%)
// Timeline spans 06:00 to 03:00(+1) = 21 hours = 1260 minutes
const TL_TOTAL_MINUTES = 21 * 60; // 1260 minutes
function timeToPercent(timeStr){
  const mins = timeToMinutesFrom6(timeStr);
  return Math.max(0, Math.min(100, (mins / TL_TOTAL_MINUTES) * 100));
}

// ============================================================
// Firebase REST
// ============================================================
async function fbGet(url){
  try{
    const r = await fetch(url+'.json');
    if(!r.ok) throw new Error(r.status);
    return await r.json();
  }catch(e){ console.error('fbGet error',url,e); return null; }
}
async function fbPut(url, data){
  try{
    const r = await fetch(url+'.json',{
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(data)
    });
    if(!r.ok) throw new Error(r.status);
    return true;
  }catch(e){ console.error('fbPut error',url,e); showToast('ì €ì¥ ì‹¤íŒ¨'); return false; }
}
async function fbPatch(url, data){
  try{
    const r = await fetch(url+'.json',{
      method:'PATCH',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(data)
    });
    if(!r.ok) throw new Error(r.status);
    return true;
  }catch(e){ console.error('fbPatch error',url,e); showToast('ì €ì¥ ì‹¤íŒ¨'); return false; }
}
async function fbDelete(url){
  try{
    const r = await fetch(url+'.json',{method:'DELETE'});
    if(!r.ok) throw new Error(r.status);
    return true;
  }catch(e){ console.error('fbDelete error',url,e); showToast('ì‚­ì œ ì‹¤íŒ¨'); return false; }
}

// ============================================================
// localStorage â€” single source of truth (Firebase = backup)
// ============================================================
const LS_EMPLOYEES = 'ws_employees';
const LS_SCHEDULE_PREFIX = 'ws_sched_';

function lsSaveEmployees(data){
  try{ localStorage.setItem(LS_EMPLOYEES, JSON.stringify(data)); }catch(e){}
}
function lsLoadEmployees(){
  try{
    const s = localStorage.getItem(LS_EMPLOYEES);
    return s ? JSON.parse(s) : null;
  }catch(e){ return null; }
}
function lsSaveSchedule(dateKey, data){
  try{ localStorage.setItem(LS_SCHEDULE_PREFIX + dateKey, JSON.stringify(data)); }catch(e){}
}
function lsLoadSchedule(dateKey){
  try{
    const s = localStorage.getItem(LS_SCHEDULE_PREFIX + dateKey);
    return s ? JSON.parse(s) : null;
  }catch(e){ return null; }
}
function lsDeleteShift(dateKey, empId){
  const sched = lsLoadSchedule(dateKey) || {};
  delete sched[empId];
  lsSaveSchedule(dateKey, sched);
}

// ============================================================
// SSE with generation counter
// ============================================================
function connectSSE(){
  sseGeneration++;
  const gen = sseGeneration;

  // Employees SSE
  if(sseEmployees){ try{sseEmployees.close();}catch(e){} sseEmployees = null; }
  try{
    sseEmployees = new EventSource(FB_EMPLOYEES+'.json');
    sseEmployees.addEventListener('put', function(e){
      if(gen !== sseGeneration){ sseEmployees.close(); return; }
      try{
        const d = JSON.parse(e.data);
        if(d.path === '/'){
          employees = d.data || {};
        } else {
          const key = d.path.replace(/^\//,'');
          if(d.data === null) delete employees[key];
          else employees[key] = d.data;
        }
        lsSaveEmployees(employees);
        renderAll();
      }catch(err){ console.error('SSE emp parse',err); }
    });
    sseEmployees.addEventListener('patch', function(e){
      if(gen !== sseGeneration){ sseEmployees.close(); return; }
      try{
        const d = JSON.parse(e.data);
        const key = d.path.replace(/^\//,'');
        if(key && d.data) employees[key] = Object.assign(employees[key]||{}, d.data);
        else if(!key && d.data) Object.assign(employees, d.data);
        lsSaveEmployees(employees);
        renderAll();
      }catch(err){ console.error('SSE emp patch parse',err); }
    });
    sseEmployees.onerror = function(){
      if(gen !== sseGeneration) return;
      try{sseEmployees.close();}catch(e){}
      sseEmployees = null;
      setTimeout(()=>{ if(gen === sseGeneration) connectSSE(); }, 3000);
    };
  }catch(e){ console.error('SSE emp connect fail',e); }

  // Schedule SSE for current date
  connectScheduleSSE(gen);
}

function connectScheduleSSE(gen){
  if(sseSchedule){ try{sseSchedule.close();}catch(e){} sseSchedule = null; }
  const dk = dateKey(currentDate);
  try{
    sseSchedule = new EventSource(FB_SCHEDULES+'/'+dk+'.json');
    sseSchedule.addEventListener('put', function(e){
      if(gen !== sseGeneration){ sseSchedule.close(); return; }
      try{
        const d = JSON.parse(e.data);
        if(d.path === '/'){
          daySchedule = d.data || {};
        } else {
          const key = d.path.replace(/^\//,'').split('/')[0];
          if(d.data === null) delete daySchedule[key];
          else {
            if(d.path.split('/').filter(Boolean).length === 1){
              daySchedule[key] = d.data;
            } else {
              if(!daySchedule[key]) daySchedule[key] = {};
              const subkey = d.path.replace(/^\//,'').split('/')[1];
              if(d.data === null) delete daySchedule[key][subkey];
              else daySchedule[key][subkey] = d.data;
            }
          }
        }
        lsSaveSchedule(dateKey(currentDate), daySchedule);
        renderTimeline();
      }catch(err){ console.error('SSE sched parse',err); }
    });
    sseSchedule.addEventListener('patch', function(e){
      if(gen !== sseGeneration){ sseSchedule.close(); return; }
      try{
        const d = JSON.parse(e.data);
        const parts = d.path.replace(/^\//,'').split('/').filter(Boolean);
        if(parts.length === 0 && d.data){
          Object.keys(d.data).forEach(k=>{
            daySchedule[k] = Object.assign(daySchedule[k]||{}, d.data[k]);
          });
        } else if(parts.length === 1 && d.data){
          daySchedule[parts[0]] = Object.assign(daySchedule[parts[0]]||{}, d.data);
        }
        renderTimeline();
      }catch(err){ console.error('SSE sched patch parse',err); }
    });
    sseSchedule.onerror = function(){
      if(gen !== sseGeneration) return;
      try{sseSchedule.close();}catch(e){}
      sseSchedule = null;
      setTimeout(()=>{ if(gen === sseGeneration) connectScheduleSSE(gen); }, 3000);
    };
  }catch(e){ console.error('SSE sched connect fail',e); }
}

// ============================================================
// Data loading
// ============================================================
async function loadData(){
  const dk = dateKey(currentDate);

  // 1) localStorage ì¦‰ì‹œ ë¡œë“œ (ë°ì´í„° ìœ ì‹¤ ë°©ì§€)
  const localEmp = lsLoadEmployees();
  const localSched = lsLoadSchedule(dk);
  if(localEmp && Object.keys(localEmp).length > 0){
    employees = localEmp;
  }
  if(localSched){
    daySchedule = localSched;
  }

  // ì´ë¯¸ ë¡œì»¬ ë°ì´í„° ìˆìœ¼ë©´ ì¦‰ì‹œ ë Œë” (ë¡œë”© ì—†ì´)
  if(localEmp || localSched){
    dataLoaded = true;
    $loading.style.display = 'none';
    $timelineScroll.style.display = '';
    renderAll();
  } else {
    $loading.style.display = 'flex';
    $timelineScroll.style.display = 'none';
  }

  // 2) Firebase ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™”
  try {
    const [empData, schedData] = await Promise.all([
      fbGet(FB_EMPLOYEES),
      fbGet(FB_SCHEDULES+'/'+dk)
    ]);

    if(empData && Object.keys(empData).length > 0){
      employees = empData;
      lsSaveEmployees(empData);
    } else if(!localEmp || Object.keys(employees).length === 0){
      employees = JSON.parse(JSON.stringify(DEFAULT_EMPLOYEES));
      lsSaveEmployees(employees);
      fbPut(FB_EMPLOYEES, employees);
    }

    if(schedData){
      // Firebase ë°ì´í„°ì™€ ë¡œì»¬ ë³‘í•© (ë¡œì»¬ ìš°ì„ )
      const merged = Object.assign({}, schedData, localSched || {});
      daySchedule = merged;
      lsSaveSchedule(dk, merged);
    }
  } catch(err){
    console.error('loadData Firebase sync error:', err);
  }
  dataLoaded = true;

  // ê³ ì • ìŠ¤ì¼€ì¤„ ìë™ ì ìš©
  autoApplyFixed(dk);

  $loading.style.display = 'none';
  $timelineScroll.style.display = '';
  renderAll();
  loadWeekSchedules();
}

async function loadWeekSchedules(){
  const monday = getMonday(currentDate);
  const promises = [];
  const keys = [];
  for(let i=0; i<7; i++){
    const d = new Date(monday);
    d.setDate(d.getDate()+i);
    const dk = dateKey(d);
    keys.push(dk);
    promises.push(fbGet(FB_SCHEDULES+'/'+dk));
  }
  const results = await Promise.all(promises);
  weekSchedules = {};
  keys.forEach((k,i)=>{
    weekSchedules[k] = results[i] || {};
  });
  renderWeek();
}

// ê³ ì • ìŠ¤ì¼€ì¤„ + íœ´ë¬´ì ìë™ ì ìš© (ë¹ˆ ë‚ ì§œì—ë§Œ)
function autoApplyFixed(dk){
  let changed = false;
  for(const empName in FIXED_SCHEDULES){
    const fix = FIXED_SCHEDULES[empName];
    if(fix.type === 'variable' || !fix.start) continue;
    const empId = findEmpIdByName(empName);
    if(!empId) continue;
    // ì´ë¯¸ ì…ë ¥ëœ ê²½ìš° ê±´ë“œë¦¬ì§€ ì•ŠìŒ
    if(daySchedule[empId]) continue;
    // íœ´ë¬´ì¸ ê²½ìš° ê±´ë“œë¦¬ì§€ ì•ŠìŒ
    if(isDayOff(empId, dk)) continue;
    daySchedule[empId] = {start:fix.start, end:fix.end, role:fix.role};
    changed = true;
  }
  if(changed){
    lsSaveSchedule(dk, daySchedule);
    // Firebaseì—ë„ ì €ì¥
    for(const empId in daySchedule){
      const s = daySchedule[empId];
      if(s && s.start) fbPut(FB_SCHEDULES+'/'+dk+'/'+empId, s);
    }
  }
  return changed;
}

async function onDateChange(){
  updateDateDisplay();
  // Reconnect schedule SSE for new date
  if(sseSchedule){ try{sseSchedule.close();}catch(e){} sseSchedule = null; }
  connectScheduleSSE(sseGeneration);
  const dk = dateKey(currentDate);
  // localStorage ë¨¼ì €
  const localSched = lsLoadSchedule(dk);
  if(localSched) daySchedule = localSched;
  else daySchedule = {};
  // ê³ ì • ìŠ¤ì¼€ì¤„ ìë™ ì ìš©
  autoApplyFixed(dk);
  renderTimeline();
  // Firebase ë™ê¸°í™”
  try{
    const schedData = await fbGet(FB_SCHEDULES+'/'+dk);
    if(schedData){
      const merged = Object.assign({}, schedData, localSched || {});
      daySchedule = merged;
      lsSaveSchedule(dk, merged);
      renderTimeline();
    }
  }catch(e){}
  loadWeekSchedules();
}

// ============================================================
// Date display
// ============================================================
function updateDateDisplay(){
  const m = currentDate.getMonth()+1;
  const d = currentDate.getDate();
  const dow = DOW_KR[currentDate.getDay()];
  $dateDisplay.textContent = m+'/'+d+' '+dow;
}

// ============================================================
// Render all
// ============================================================
function renderAll(){
  updateDateDisplay();
  renderBriefing();
  renderTimeline();
  renderWeek();
  checkLogistics();
  buildCalButtons();
}

// ============================================================
// ë‹¹ì¼ ë¸Œë¦¬í•‘ íŒ¨ë„ â€” í•œëˆˆì— ì—¼ë‘ì‚¬í•­ ëª¨ì•„ë³´ê¸°
// ============================================================
function renderBriefing(){
  const panel = $('briefingPanel');
  if(!panel) return;
  const dk = dateKey(currentDate);
  const empKeys = Object.keys(employees);

  let html = '';

  // 1) ë‹¹ì¼ íœ´ë¬´ì˜ˆì •ì
  const offToday = [];
  empKeys.forEach(id => {
    if(isDayOff(id, dk)) offToday.push(employees[id]?.name || id);
  });
  html += '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:4px;">';
  html += '<span style="color:#E74C3C;font-weight:600;">íœ´ë¬´ '+offToday.length+'ëª…</span>';
  if(offToday.length > 0){
    html += '<span style="color:#E74C3C;">'+offToday.join(', ')+'</span>';
  } else {
    html += '<span style="color:#707088;">ì—†ìŒ</span>';
  }

  // 2) ì´ë²ˆì£¼ íœ´ë¬´ ëˆ„ì  (ì¸ë‹¹)
  const mon = getMonday(currentDate);
  const weekOffCounts = {};
  empKeys.forEach(id => { weekOffCounts[id] = 0; });
  for(let i=0; i<7; i++){
    const d = new Date(mon);
    d.setDate(d.getDate()+i);
    const wdk = dateKey(d);
    empKeys.forEach(id => {
      if(isDayOff(id, wdk)) weekOffCounts[id]++;
    });
  }
  html += '<span style="color:#707088;margin-left:6px;">|</span>';
  html += '<span style="color:#FFD700;font-weight:600;">ì£¼ê°„íœ´ë¬´</span>';
  const offChips = [];
  empKeys.forEach(id => {
    if(weekOffCounts[id] > 0){
      offChips.push((employees[id]?.name||id)+weekOffCounts[id]+'ì¼');
    }
  });
  html += '<span style="color:#9090A8;">'+(offChips.length>0 ? offChips.join(' ') : 'ì—†ìŒ')+'</span>';
  html += '</div>';

  // 3) ë‚ ì”¨ + ë§¤ì¶œë³€ë™ìš”ì¸ (í•œì¤„)
  html += '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:4px;">';
  // ë‚ ì”¨ ìš”ì•½
  const wxNow = hourlyWeather[new Date().getHours()];
  if(wxNow){
    html += '<span style="color:#9090A8;">ë‚ ì”¨ '+wxNow.i+' '+wxNow.t+'Â°</span>';
  } else {
    const wxKeys = Object.keys(hourlyWeather);
    if(wxKeys.length > 0){
      const temps = wxKeys.map(h => hourlyWeather[h].t).filter(t=>t!==undefined);
      const icons = [...new Set(wxKeys.map(h => hourlyWeather[h].i))];
      if(temps.length > 0){
        html += '<span style="color:#9090A8;">ë‚ ì”¨ '+icons.join('')+' '+Math.min(...temps)+'~'+Math.max(...temps)+'Â°</span>';
      }
    }
  }
  // ìŠ¤í¬ì¸ /ë§¤ì¶œë³€ë™
  const sportsEl = $('sportsInfo');
  if(sportsEl && sportsEl.textContent && !sportsEl.textContent.includes('ë¡œë”©')){
    html += '<span style="color:#2AC1BC;">'+sportsEl.textContent.substring(0,30)+'</span>';
  }
  html += '</div>';

  // 4) ê·¼ë¬´ í˜„í™© ìš”ì•½ (ê³ ì •/ë³€ì¹™/ë¯¸ì…ë ¥)
  let fixedCount=0, variableCount=0, emptyCount=0, offCount=offToday.length;
  empKeys.forEach(id => {
    if(isDayOff(id, dk)) return;
    const s = daySchedule[id];
    if(s && s.start){
      const fix = getFixedSchedule(employees[id]?.name);
      if(fix && fix.type==='fixed' && s.start===fix.start && s.end===fix.end) fixedCount++;
      else variableCount++;
    } else {
      emptyCount++;
    }
  });
  html += '<div style="display:flex;gap:8px;">';
  html += '<span style="color:#2ECC71;">ê³ ì • '+fixedCount+'</span>';
  html += '<span style="color:#E67E22;">ìˆ˜ë™ '+variableCount+'</span>';
  if(emptyCount > 0) html += '<span style="color:#E74C3C;font-weight:600;">ë¯¸ì…ë ¥ '+emptyCount+'</span>';
  html += '<span style="color:#707088;">íœ´ë¬´ '+offCount+'</span>';

  // ëŒ€ìœ  (ë³€ì¹™) ì•Œë¦¼
  const daeyuId = findEmpIdByName('ëŒ€ìœ ');
  if(daeyuId && !isDayOff(daeyuId, dk) && (!daySchedule[daeyuId] || !daySchedule[daeyuId].start)){
    html += '<span style="color:#F0A500;font-weight:600;">âš  ëŒ€ìœ  ë¯¸ì…ë ¥</span>';
  }
  html += '</div>';

  panel.innerHTML = html;
}

// ============================================================
// Timeline Rendering â€” VERTICAL, FIT TO SCREEN
// ============================================================
let hourlyWeather = {}; // {hour: {t:temp, i:icon}}

function renderTimeline(){
  if(!dataLoaded) return;
  const container = $timelineContent;
  container.innerHTML = '';

  const empKeys = Object.keys(employees);

  if(empKeys.length === 0){
    container.innerHTML = '<div style="padding:30px;text-align:center;color:#9090A8;font-size:.9rem;">ì§ì›ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”</div>';
    return;
  }

  // --- Header (employee names) ---
  const header = document.createElement('div');
  header.className = 'vt-header';

  const timeHdr = document.createElement('div');
  timeHdr.className = 'vt-time-hdr';
  timeHdr.textContent = '';
  header.appendChild(timeHdr);

  const dk = dateKey(currentDate);
  empKeys.forEach(empId => {
    const emp = employees[empId];
    const off = isDayOff(empId, dk);
    const hdr = document.createElement('div');
    hdr.className = 'vt-emp-hdr';
    hdr.innerHTML = '<div class="vt-dot" style="background:'+(off?'#E74C3C':(emp.color||'#9090A8'))+'"></div><div class="vt-name">'+(off?'<span style="color:#E74C3C;">íœ´</span> ':'')+emp.name+'</div>';
    if(off) hdr.style.opacity = '.5';
    header.appendChild(hdr);
  });
  container.appendChild(header);

  // --- Body (fills remaining screen) ---
  const wrapper = document.createElement('div');
  wrapper.className = 'vt-wrapper';

  const body = document.createElement('div');
  body.className = 'vt-body';

  // Time column with weather
  const timeCol = document.createElement('div');
  timeCol.className = 'vt-time-col';
  const SHOW_HOURS = new Set([6,9,12,15,18,21,0,3]);
  TL_HOURS.forEach((h, idx) => {
    const pct = (idx / TL_HOURS.length) * 100;
    const tick = document.createElement('div');
    tick.className = 'vt-hour-tick';
    tick.style.top = pct + '%';
    tick.style.height = (100 / TL_HOURS.length) + '%';
    let html = SHOW_HOURS.has(h) ? '<span>'+pad(h)+'</span>' : '';
    // Weather at this hour
    const wx = hourlyWeather[h];
    if(wx){
      html += '<span class="vt-wx">'+wx.i+(wx.t!==undefined?wx.t+'Â°':'')+'</span>';
    }
    tick.innerHTML = html;
    timeCol.appendChild(tick);
  });
  body.appendChild(timeCol);

  // Employee columns with drag support
  empKeys.forEach(empId => {
    const emp = employees[empId];
    const shift = daySchedule[empId];
    const off = isDayOff(empId, dk);
    const col = document.createElement('div');
    col.className = 'vt-emp-col';
    col.dataset.empid = empId;

    // Grid lines at each hour
    TL_HOURS.forEach((h, idx) => {
      const pct = (idx / TL_HOURS.length) * 100;
      const line = document.createElement('div');
      line.className = 'vt-grid-line';
      line.style.top = pct + '%';
      line.style.height = (100 / TL_HOURS.length) + '%';
      col.appendChild(line);
    });

    // Day-off overlay
    if(off){
      const offBlock = document.createElement('div');
      offBlock.style.cssText = 'position:absolute;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;background:#E74C3C10;z-index:1;';
      offBlock.innerHTML = '<span style="color:#E74C3C;font-size:.75rem;font-weight:700;writing-mode:vertical-rl;opacity:.6;">íœ´ ë¬´</span>';
      col.appendChild(offBlock);
      col.style.opacity = '.4';
    }

    // Shift block
    if(!off && shift && shift.start && shift.end){
      const block = document.createElement('div');
      block.className = 'vt-shift';
      const topPct = timeToPercent(shift.start);
      const bottomPct = timeToPercent(shift.end);
      let heightPct = bottomPct - topPct;
      if(heightPct <= 0) heightPct += 100;

      block.style.top = topPct + '%';
      block.style.height = Math.min(heightPct, 100 - topPct) + '%';
      block.style.background = (emp.color||'#9090A8') + '38';
      block.style.borderTop = '2px solid '+(emp.color||'#9090A8');

      const roles = shift.role ? shift.role.split(',').filter(Boolean) : [];
      const roleIcons = roles.map(r => r==='ì£¼ë°©'?'ğŸ³':r==='ë°°ë‹¬'?'ğŸ›µ':r).join('');
      const timeText = shift.start.replace(/^0/,'')+'-'+shift.end.replace(/^0/,'');
      const hours = calcHours(shift.start, shift.end);
      block.innerHTML =
        (roleIcons ? '<span class="vt-role" style="color:'+(emp.color||'#E0E0EC')+'">'+roleIcons+(roles.length>1?' Ã—0.5':'')+'</span>' : '')+
        '<span class="vt-time-label" style="color:'+(emp.color||'#E0E0EC')+'">'+timeText+'</span>'+
        '<span class="vt-time-label" style="color:#FFFFFF">'+hours+'h</span>';

      block.addEventListener('click', (e)=>{
        e.stopPropagation();
        openShiftModal(empId);
      });
      col.appendChild(block);
    }

    // Drag: touchstart on column, move/end on document (during drag)
    col.addEventListener('touchstart', onDragStart, {passive:false});

    body.appendChild(col);
  });

  wrapper.appendChild(body);
  container.appendChild(wrapper);

  // --- Summary row ---
  const summary = document.createElement('div');
  summary.className = 'vt-summary';

  const sumTime = document.createElement('div');
  sumTime.className = 'vt-summary-time';
  sumTime.textContent = 'í•©ê³„';
  summary.appendChild(sumTime);

  empKeys.forEach(empId => {
    const shift = daySchedule[empId];
    const off = isDayOff(empId, dk);
    const cell = document.createElement('div');
    cell.className = 'vt-summary-cell';
    if(off){
      cell.textContent = 'íœ´';
      cell.style.color = '#E74C3C';
      cell.style.fontSize = '.6rem';
    } else if(shift && shift.start && shift.end){
      cell.textContent = calcHours(shift.start, shift.end) + 'h';
    } else {
      cell.textContent = '-';
      cell.style.color = '#707088';
    }
    summary.appendChild(cell);
  });
  container.appendChild(summary);

  // --- Staffing Check (ì‹œê°„ëŒ€ë³„ ì£¼ë°©/ë°°ë‹¬ ì¸ì› ì²´í¬) ---
  const staffing = calcStaffing(empKeys, dk);
  const staffDiv = document.createElement('div');
  staffDiv.style.cssText = 'padding:6px 8px;background:#1A1A30;border-top:1px solid #2E2E52;';

  // ë°°ë‹¬ëŒ€í–‰ ì˜ì—…ì‹œê°„: 10:00~01:00
  const DA_START = timeToMinutesFrom6('10:00');
  const DA_END = timeToMinutesFrom6('01:00');

  let html = '<div style="font-size:.7rem;color:#FFD700;font-weight:600;margin-bottom:4px;">ì‹œê°„ëŒ€ë³„ ì¸ì› (ì£¼ë°©/ë°°ë‹¬)</div>';
  html += '<div style="display:flex;flex-wrap:wrap;gap:3px;">';
  const checkHours = [10,11,12,13,14,15,16,17,18,19,20,21,22,23,0,1];
  for(const h of checkHours){
    const hStr = pad(h)+':00';
    const s = staffing[hStr] || {kitchen:0, delivery:0, total:0, daAvail:false};
    const needKitchen = 1;
    const needDelivery = 1;
    const kitchenOk = s.kitchen >= needKitchen;
    const deliveryOk = s.delivery >= needDelivery || s.daAvail;
    const allOk = kitchenOk && deliveryOk;
    const bgColor = allOk ? '#2ECC7120' : '#E74C3C20';
    const borderColor = allOk ? '#2ECC71' : '#E74C3C';

    html += '<div style="flex:1;min-width:38px;background:'+bgColor+';border:1px solid '+borderColor+'44;border-radius:4px;padding:2px 3px;text-align:center;">';
    html += '<div style="font-size:.6rem;color:#9090A8;">'+h+'ì‹œ</div>';
    html += '<div style="font-size:.6rem;">';
    html += '<span style="color:'+(kitchenOk?'#2ECC71':'#E74C3C')+';">ğŸ³'+s.kitchen.toFixed(1).replace('.0','')+'</span> ';
    html += '<span style="color:'+(deliveryOk?'#2ECC71':'#E74C3C')+';">ğŸ›µ'+(s.daAvail && s.delivery<needDelivery?'ëŒ€í–‰':s.delivery.toFixed(1).replace('.0',''))+'</span>';
    html += '</div></div>';
  }
  html += '</div>';

  // ë°°ë‹¬ëŒ€í–‰ ì•ˆë‚´
  html += '<div style="font-size:.6rem;color:#707088;margin-top:4px;">ğŸ›µëŒ€í–‰ = ë°°ë‹¬ëŒ€í–‰ (10ì‹œ~01ì‹œ, ë°°ë‹¬ì¸ì› ê³µë°± ì‹œ ì¶©ì¡±)</div>';

  staffDiv.innerHTML = html;
  container.appendChild(staffDiv);
}

// Staffing calculation
function calcStaffing(empKeys, dk){
  const result = {};
  const checkHours = [10,11,12,13,14,15,16,17,18,19,20,21,22,23,0,1];

  for(const h of checkHours){
    const hStr = pad(h)+':00';
    const hMin = timeToMinutesFrom6(hStr);
    let kitchen = 0, delivery = 0, total = 0;

    empKeys.forEach(empId => {
      if(isDayOff(empId, dk)) return;
      const shift = daySchedule[empId];
      if(!shift || !shift.start || !shift.end) return;

      const sMin = timeToMinutesFrom6(shift.start);
      let eMin = timeToMinutesFrom6(shift.end);
      if(eMin <= sMin) eMin += 24*60;

      if(hMin >= sMin && hMin < eMin){
        total++;
        const roles = shift.role ? shift.role.split(',').filter(Boolean) : [];
        const weight = roles.length > 1 ? 0.5 : 1;
        if(roles.includes('ì£¼ë°©')) kitchen += weight;
        if(roles.includes('ë°°ë‹¬')) delivery += weight;
        // ì—­í•  ë¯¸ì§€ì • â†’ ì£¼ë°©ìœ¼ë¡œ ì¹´ìš´íŠ¸
        if(roles.length === 0) kitchen += 1;
      }
    });

    // ë°°ë‹¬ëŒ€í–‰ ê°€ìš© ì—¬ë¶€ (10:00~01:00)
    const DA_START = timeToMinutesFrom6('10:00');
    const DA_END = timeToMinutesFrom6('01:00');
    const daAvail = hMin >= DA_START && hMin < DA_END;

    result[hStr] = {kitchen, delivery, total, daAvail};
  }
  return result;
}

// ============================================================
// Touch Drag to Create/Edit Shifts
// ============================================================
let dragState = null;

function yToTime(y, totalH){
  const pct = Math.max(0, Math.min(1, y / totalH));
  const totalMin = pct * TL_TOTAL_MINUTES;
  let h = Math.floor(totalMin / 60) + 6;
  if(h >= 24) h -= 24;
  let m = Math.round((totalMin % 60) / 30) * 30;
  if(m >= 60){ m = 0; h = (h+1) >= 24 ? h+1-24 : h+1; }
  return pad(h)+':'+pad(m);
}

function onDragStart(e){
  const col = e.currentTarget;
  const empId = col.dataset.empid;
  if(!empId) return;
  // Tap on existing shift â†’ open modal
  if(e.target.closest && e.target.closest('.vt-shift')) return;

  const rect = col.getBoundingClientRect();
  const y = e.touches[0].clientY - rect.top;
  dragState = {
    empId: empId,
    col: col,
    rect: rect,
    startY: y,
    endY: y,
    moved: false,
    preview: null
  };
  // Attach move/end to document for reliable tracking
  document.addEventListener('touchmove', onDragMove, {passive:false});
  document.addEventListener('touchend', onDragEnd, {passive:false});
}

function onDragMove(e){
  if(!dragState) return;
  const touch = e.touches[0];
  if(!touch) return;
  const y = touch.clientY - dragState.rect.top;
  if(Math.abs(y - dragState.startY) > 10) dragState.moved = true;
  if(!dragState.moved) return;
  e.preventDefault();
  e.stopPropagation();
  dragState.endY = y;

  const totalH = dragState.rect.height;
  const topY = Math.max(0, Math.min(dragState.startY, dragState.endY));
  const botY = Math.min(totalH, Math.max(dragState.startY, dragState.endY));
  const topPct = (topY / totalH) * 100;
  const heightPct = Math.max(2, ((botY - topY) / totalH) * 100);

  if(!dragState.preview){
    dragState.preview = document.createElement('div');
    dragState.preview.className = 'vt-drag';
    dragState.col.appendChild(dragState.preview);
  }
  const startTime = yToTime(topY, totalH);
  const endTime = yToTime(botY, totalH);
  dragState.preview.style.top = topPct + '%';
  dragState.preview.style.height = heightPct + '%';
  dragState.preview.textContent = startTime + '~' + endTime;
}

function onDragEnd(e){
  // Always remove document listeners
  document.removeEventListener('touchmove', onDragMove);
  document.removeEventListener('touchend', onDragEnd);

  if(!dragState) return;
  const ds = dragState;
  dragState = null;

  if(ds.preview) ds.preview.remove();

  if(!ds.moved){
    // Tap â†’ open modal for this employee
    openShiftModal(ds.empId);
    return;
  }

  const totalH = ds.rect.height;
  const topY = Math.max(0, Math.min(ds.startY, ds.endY));
  const botY = Math.min(totalH, Math.max(ds.startY, ds.endY));

  if(botY - topY < 12) return;

  const startTime = yToTime(topY, totalH);
  const endTime = yToTime(botY, totalH);
  if(startTime === endTime) return;

  const dk = dateKey(currentDate);
  const data = {start: startTime, end: endTime, role: ''};
  daySchedule[ds.empId] = data;
  lsSaveSchedule(dk, daySchedule);
  renderTimeline();
  fbPut(FB_SCHEDULES+'/'+dk+'/'+ds.empId, data).then(ok => {
    if(ok){
      showToast(employees[ds.empId].name+' '+startTime+'~'+endTime);
      loadWeekSchedules();
    }
  });
}

// ============================================================
// Hourly Weather (Gemini â†’ display in timeline)
// ============================================================
async function loadHourlyWeather(){
  const todayStr = dateStr(new Date());
  const cacheKey = 'ws_hourly_wx';
  const cached = localStorage.getItem(cacheKey);
  if(cached){
    try{
      const c = JSON.parse(cached);
      if(c.date === todayStr && c.data){
        hourlyWeather = {};
        c.data.forEach(w => { hourlyWeather[w.h] = {t:w.t, i:w.i}; });
        return;
      }
    }catch(e){}
  }
  if(!geminiKey) return;
  try{
    const prompt = 'ì˜¤ëŠ˜ '+todayStr+' ê²½ê¸°ë„ ì´ì²œì‹œ ì‹œê°„ë³„ ë‚ ì”¨. JSON ë°°ì—´ë§Œ ì‘ë‹µ: [{"h":10,"t":5,"i":"â˜€"},{"h":11,"t":6,"i":"â˜"},...] h=ì‹œ(10~3ì‹œ, ì •ìˆ˜), t=ê¸°ì˜¨(ì •ìˆ˜), i=ë‚ ì”¨ì´ëª¨ì§€(â˜€â˜ğŸŒ§ğŸŒ¨â„ğŸŒ« ì¤‘ 1ê°œ). 10ì‹œ~ìƒˆë²½3ì‹œë§Œ, ìˆœìˆ˜ JSONë§Œ(ë§ˆí¬ë‹¤ìš´ ê¸ˆì§€).';
    const result = await callGemini(prompt);
    const clean = result.replace(/```json\s*/g,'').replace(/```\s*/g,'').trim();
    const arr = JSON.parse(clean);
    if(Array.isArray(arr)){
      hourlyWeather = {};
      arr.forEach(w => { hourlyWeather[w.h] = {t:w.t, i:w.i}; });
      localStorage.setItem(cacheKey, JSON.stringify({date:todayStr, data:arr}));
    }
  }catch(e){ console.error('hourly wx error', e); }
}

function isHourInShift(hour, start, end){
  // Check if 'hour' (e.g., 10) falls within [start, end)
  const hourMin = timeToMinutesFrom6(pad(hour)+':00');
  const startMin = timeToMinutesFrom6(start);
  let endMin = timeToMinutesFrom6(end);
  if(endMin <= startMin) endMin += 24*60;
  return hourMin >= startMin && hourMin < endMin;
}

// ============================================================
// Week Overview Rendering
// ============================================================
function renderWeek(){
  if(!dataLoaded) return;
  const monday = getMonday(currentDate);
  const empKeys = Object.keys(employees);
  const today = new Date();

  $weekGrid.innerHTML = '';
  const daysOff = {}; // empId -> count of days off

  empKeys.forEach(id => { daysOff[id] = 0; });

  for(let i=0; i<7; i++){
    const d = new Date(monday);
    d.setDate(d.getDate()+i);
    const dk = dateKey(d);
    const sched = weekSchedules[dk] || {};
    const dow = d.getDay();
    const isCurrentDay = isSameDay(d, currentDate);
    const isTodayDay = isSameDay(d, today);

    const cell = document.createElement('div');
    cell.className = 'week-day';
    if(isTodayDay) cell.classList.add('today');
    if(isCurrentDay) cell.style.background = '#2A2A45';

    const label = document.createElement('div');
    label.className = 'day-label';
    label.textContent = DOW_KR_SHORT[dow];
    cell.appendChild(label);

    const dateNum = document.createElement('div');
    dateNum.className = 'day-date';
    if(dow === 0) dateNum.classList.add('sun');
    if(dow === 6) dateNum.classList.add('sat');
    dateNum.textContent = d.getDate();
    cell.appendChild(dateNum);

    // Colored dots for each scheduled employee
    const dots = document.createElement('div');
    dots.className = 'day-dots';
    let scheduledCount = 0;
    empKeys.forEach(empId => {
      if(sched[empId] && sched[empId].start){
        const dot = document.createElement('div');
        dot.className = 'wdot';
        dot.style.background = employees[empId] ? employees[empId].color : '#9090A8';
        dots.appendChild(dot);
        scheduledCount++;
      } else {
        daysOff[empId] = (daysOff[empId]||0) + 1;
      }
    });
    cell.appendChild(dots);

    if(scheduledCount > 0){
      const cnt = document.createElement('div');
      cnt.className = 'day-count';
      cnt.textContent = scheduledCount+'ëª…';
      cell.appendChild(cnt);
    }

    cell.addEventListener('click', ()=>{
      currentDate = new Date(d);
      onDateChange();
    });

    $weekGrid.appendChild(cell);
  }

  // Days off summary
  $weekOffs.innerHTML = '';
  empKeys.forEach(empId => {
    const emp = employees[empId];
    if(!emp) return;
    const chip = document.createElement('div');
    chip.className = 'off-chip';
    chip.innerHTML = '<div class="odot" style="background:'+(emp.color||'#9090A8')+'"></div><span class="off-text">'+emp.name+' íœ´'+daysOff[empId]+'ì¼</span>';
    $weekOffs.appendChild(chip);
  });
}

// ============================================================
// Shift Modal
// ============================================================
let shiftSelectedEmpId = null;
let shiftSelectedRoles = []; // ['ì£¼ë°©'], ['ë°°ë‹¬'], or ['ì£¼ë°©','ë°°ë‹¬']
let shiftSelectedStart = null;
let shiftSelectedEnd = null;
let shiftEditMode = false; // editing existing shift

function buildTimeGrids(){
  const $start = $('startTimeGrid');
  const $end = $('endTimeGrid');
  $start.innerHTML = '';
  $end.innerHTML = '';

  // Start times: 06:00 ~ 02:30 (30min intervals)
  for(let h=6; h<=26; h++){
    const realH = h >= 24 ? h-24 : h;
    if(h === 27) break; // stop at 03:00 for end only
    for(let m=0; m<60; m+=30){
      if(h === 26 && m > 30) break;
      const t = pad(realH)+':'+pad(m);
      // Start: 06:00 ~ 02:30
      if(h <= 26){
        const optS = document.createElement('div');
        optS.className = 'time-option';
        optS.textContent = t;
        optS.dataset.time = t;
        optS.addEventListener('click',()=> selectStartTime(t));
        $start.appendChild(optS);
      }
    }
  }

  // End times: 06:30 ~ 03:00
  for(let h=6; h<=27; h++){
    const realH = h >= 24 ? h-24 : h;
    for(let m=0; m<60; m+=30){
      if(h === 6 && m === 0) continue; // skip 06:00 for end
      if(h === 27 && m > 0) break;
      const t = pad(realH)+':'+pad(m);
      const optE = document.createElement('div');
      optE.className = 'time-option';
      optE.textContent = t;
      optE.dataset.time = t;
      optE.addEventListener('click',()=> selectEndTime(t));
      $end.appendChild(optE);
    }
  }
}

function selectStartTime(t){
  shiftSelectedStart = t;
  document.querySelectorAll('#startTimeGrid .time-option').forEach(el=>{
    el.classList.toggle('selected', el.dataset.time === t);
  });
}
function selectEndTime(t){
  shiftSelectedEnd = t;
  document.querySelectorAll('#endTimeGrid .time-option').forEach(el=>{
    el.classList.toggle('selected', el.dataset.time === t);
  });
}

function buildEmpChips(){
  const $chips = $('shiftEmpChips');
  $chips.innerHTML = '';
  Object.keys(employees).forEach(empId => {
    const emp = employees[empId];
    const chip = document.createElement('div');
    chip.className = 'emp-chip';
    if(empId === shiftSelectedEmpId) chip.classList.add('selected');
    chip.innerHTML = '<div class="chip-dot" style="background:'+(emp.color||'#9090A8')+'"></div>'+emp.name;
    chip.addEventListener('click', ()=>{
      shiftSelectedEmpId = empId;
      $chips.querySelectorAll('.emp-chip').forEach(c => c.classList.remove('selected'));
      chip.classList.add('selected');
      // Load existing shift if any
      const existing = daySchedule[empId];
      if(existing && existing.start){
        selectStartTime(existing.start);
        selectEndTime(existing.end);
        shiftSelectedRoles = existing.role ? existing.role.split(',').filter(Boolean) : [];
        updateRolePills();
        $('shiftDelete').style.display = '';
        shiftEditMode = true;
      } else {
        $('shiftDelete').style.display = 'none';
        shiftEditMode = false;
      }
    });
    $chips.appendChild(chip);
  });
}

function updateRolePills(){
  document.querySelectorAll('#shiftRolePills .role-pill').forEach(pill => {
    pill.classList.toggle('selected', shiftSelectedRoles.includes(pill.dataset.role));
  });
}

function openShiftModal(empId){
  shiftSelectedEmpId = empId || null;
  shiftSelectedRoles = [];
  shiftSelectedStart = null;
  shiftSelectedEnd = null;
  shiftEditMode = false;

  // Clear time selections
  document.querySelectorAll('#startTimeGrid .time-option, #endTimeGrid .time-option').forEach(el=> el.classList.remove('selected'));

  buildEmpChips();

  // If empId provided and has existing shift, load it
  if(empId && daySchedule[empId] && daySchedule[empId].start){
    const shift = daySchedule[empId];
    shiftSelectedStart = shift.start;
    shiftSelectedEnd = shift.end;
    shiftSelectedRoles = shift.role ? shift.role.split(',').filter(Boolean) : [];
    shiftEditMode = true;
    selectStartTime(shift.start);
    selectEndTime(shift.end);
    $('shiftDelete').style.display = '';
  } else {
    $('shiftDelete').style.display = 'none';
  }

  updateRolePills();

  const m = currentDate.getMonth()+1;
  const d = currentDate.getDate();
  const dow = DOW_KR[currentDate.getDay()];
  $('shiftTitle').textContent = 'ê·¼ë¬´ ' + (shiftEditMode ? 'ìˆ˜ì •' : 'ì¶”ê°€') + ' - ' + m+'/'+d+' ('+dow+')';

  openModal($shiftModal);
}

// Role pill clicks (multi-select toggle)
document.querySelectorAll('#shiftRolePills .role-pill').forEach(pill => {
  pill.addEventListener('click', ()=>{
    const r = pill.dataset.role;
    const idx = shiftSelectedRoles.indexOf(r);
    if(idx >= 0) shiftSelectedRoles.splice(idx, 1);
    else shiftSelectedRoles.push(r);
    updateRolePills();
  });
});

// Presets
document.querySelectorAll('#shiftPresets .preset-btn').forEach(btn => {
  btn.addEventListener('click', ()=>{
    selectStartTime(btn.dataset.start);
    selectEndTime(btn.dataset.end);
    // Scroll to selection
    const startSel = document.querySelector('#startTimeGrid .time-option.selected');
    if(startSel) startSel.scrollIntoView({block:'center',behavior:'smooth'});
    const endSel = document.querySelector('#endTimeGrid .time-option.selected');
    if(endSel) setTimeout(()=> endSel.scrollIntoView({block:'center',behavior:'smooth'}), 200);
  });
});

// Save shift
$('shiftSave').addEventListener('click', async()=>{
  if(!shiftSelectedEmpId){
    showToast('ì§ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
    return;
  }
  if(!shiftSelectedStart || !shiftSelectedEnd){
    showToast('ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
    return;
  }
  const dk = dateKey(currentDate);
  const data = {
    start: shiftSelectedStart,
    end: shiftSelectedEnd,
    role: shiftSelectedRoles.join(',')
  };

  closeModal($shiftModal);

  // Optimistic update â€” localStorage first
  daySchedule[shiftSelectedEmpId] = data;
  lsSaveSchedule(dk, daySchedule);
  renderTimeline();

  const ok = await fbPut(FB_SCHEDULES+'/'+dk+'/'+shiftSelectedEmpId, data);
  if(ok){
    showToast('ì €ì¥ë¨');
    loadWeekSchedules();
  } else {
    showToast('ë¡œì»¬ ì €ì¥ë¨ (ì„œë²„ ë™ê¸°í™” ëŒ€ê¸°)');
  }
});

// Delete shift
$('shiftDelete').addEventListener('click', async()=>{
  if(!shiftSelectedEmpId) return;
  const dk = dateKey(currentDate);

  closeModal($shiftModal);

  // Optimistic â€” localStorage first
  delete daySchedule[shiftSelectedEmpId];
  lsSaveSchedule(dk, daySchedule);
  renderTimeline();

  const ok = await fbDelete(FB_SCHEDULES+'/'+dk+'/'+shiftSelectedEmpId);
  if(ok){
    showToast('ì‚­ì œë¨');
    loadWeekSchedules();
  }
});

$('shiftCancel').addEventListener('click',()=> closeModal($shiftModal));
$('shiftModalClose').addEventListener('click',()=> closeModal($shiftModal));

// ============================================================
// Month View Modal
// ============================================================
$('monthViewBtn').addEventListener('click', ()=>{
  monthViewYear = currentDate.getFullYear();
  monthViewMonth = currentDate.getMonth()+1;
  renderMonthView();
  openModal($monthModal);
});
$('monthModalClose').addEventListener('click', ()=> closeModal($monthModal));
$('monthPrev').addEventListener('click', ()=>{
  monthViewMonth--;
  if(monthViewMonth < 1){ monthViewMonth=12; monthViewYear--; }
  renderMonthView();
});
$('monthNext').addEventListener('click', ()=>{
  monthViewMonth++;
  if(monthViewMonth > 12){ monthViewMonth=1; monthViewYear++; }
  renderMonthView();
});

async function renderMonthView(){
  $('monthModalLabel').textContent = monthViewYear+'ë…„ '+monthViewMonth+'ì›”';
  const grid = $('monthGrid');
  grid.innerHTML = '';

  // DOW labels
  DOW_KR_SHORT.forEach(d => {
    const label = document.createElement('div');
    label.className = 'month-dow-label';
    label.textContent = d;
    grid.appendChild(label);
  });

  const days = daysInMonth(monthViewYear, monthViewMonth);
  const firstDow = new Date(monthViewYear, monthViewMonth-1, 1).getDay();
  const today = new Date();

  // Load month schedule counts
  const monthData = {};
  const promises = [];
  const dateKeys = [];
  for(let d=1; d<=days; d++){
    const dk = monthViewYear+'-'+pad(monthViewMonth)+'-'+pad(d);
    dateKeys.push({dk, d});
  }

  // Fetch all days in parallel (batch â€” just fetch the whole month folder)
  const monthFolder = await fbGet(FB_SCHEDULES);
  const allSchedules = monthFolder || {};

  // Empty cells before first day
  for(let i=0; i<firstDow; i++){
    const cell = document.createElement('div');
    cell.className = 'month-day-cell empty';
    grid.appendChild(cell);
  }

  for(let d=1; d<=days; d++){
    const dk = monthViewYear+'-'+pad(monthViewMonth)+'-'+pad(d);
    const daySched = allSchedules[dk] || {};
    const count = Object.keys(daySched).filter(k => daySched[k] && daySched[k].start).length;
    const dow = new Date(monthViewYear, monthViewMonth-1, d).getDay();
    const isToday2 = (today.getFullYear()===monthViewYear && (today.getMonth()+1)===monthViewMonth && today.getDate()===d);

    const cell = document.createElement('div');
    cell.className = 'month-day-cell';
    if(isToday2) cell.classList.add('today');
    if(count > 0) cell.classList.add('has-staff');

    const num = document.createElement('div');
    num.className = 'md-num';
    if(dow === 0) num.classList.add('sun');
    if(dow === 6) num.classList.add('sat');
    num.textContent = d;
    cell.appendChild(num);

    if(count > 0){
      const cnt = document.createElement('div');
      cnt.className = 'md-count';
      cnt.textContent = count+'ëª…';
      cell.appendChild(cnt);
    }

    cell.addEventListener('click', ()=>{
      currentDate = new Date(monthViewYear, monthViewMonth-1, d);
      closeModal($monthModal);
      onDateChange();
    });

    grid.appendChild(cell);
  }
}

// ============================================================
// Employee Management Modal
// ============================================================
$('empMgrBtn').addEventListener('click', ()=>{
  renderEmpList();
  openModal($empModal);
});
$('empModalClose').addEventListener('click', ()=> closeModal($empModal));

function renderEmpList(){
  const $list = $('empList');
  $list.innerHTML = '';
  const empKeys = Object.keys(employees);
  if(empKeys.length === 0){
    $list.innerHTML = '<div style="padding:20px;text-align:center;color:#9090A8;">ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  empKeys.forEach(id => {
    const emp = employees[id];
    const item = document.createElement('div');
    item.className = 'emp-list-item';
    const roleText = emp.role || 'ë¯¸ì§€ì •';
    const rateText = emp.hourlyRate ? emp.hourlyRate.toLocaleString()+'ì›' : '-';
    item.innerHTML =
      '<div class="emp-dot" style="background:'+(emp.color||'#9090A8')+'"></div>'+
      '<div class="emp-info">'+
        '<div class="name">'+emp.name+'</div>'+
        '<div class="detail">'+(emp.phone||'ì „í™”ì—†ìŒ')+' | '+roleText+' | '+rateText+'</div>'+
      '</div>'+
      '<div class="emp-list-actions">'+
        '<button class="btn btn-sm" data-edit="'+id+'">ìˆ˜ì •</button>'+
        '<button class="btn btn-sm btn-danger" data-del="'+id+'">ì‚­ì œ</button>'+
      '</div>';
    $list.appendChild(item);
  });

  $list.querySelectorAll('[data-edit]').forEach(btn => {
    btn.addEventListener('click', ()=> openEmpEdit(btn.dataset.edit));
  });
  $list.querySelectorAll('[data-del]').forEach(btn => {
    btn.addEventListener('click', async()=>{
      if(!confirm(employees[btn.dataset.del].name+' ì‚­ì œ?')) return;
      const ok = await fbDelete(FB_EMPLOYEES+'/'+btn.dataset.del);
      if(ok){
        delete employees[btn.dataset.del];
        renderEmpList();
        renderAll();
        showToast('ì‚­ì œë¨');
      }
    });
  });
}

// ============================================================
// Employee Edit Modal
// ============================================================
const PRESET_COLORS = [
  '#FF6B6B','#4ECDC4','#45B7D1','#96CEB4',
  '#FFEAA7','#DDA0DD','#F0A500','#6C5CE7',
  '#A8E6CF','#FF8A5C','#EA80FC','#00BCD4'
];
let editingEmpId = null;
let selectedColor = PRESET_COLORS[0];

function buildColorPicker(){
  const $cp = $('colorPicker');
  $cp.innerHTML = '';
  PRESET_COLORS.forEach(c => {
    const sw = document.createElement('div');
    sw.className = 'color-swatch' + (c === selectedColor ? ' selected' : '');
    sw.style.background = c;
    sw.addEventListener('click', ()=>{
      selectedColor = c;
      $cp.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
      sw.classList.add('selected');
    });
    $cp.appendChild(sw);
  });
}

function openEmpEdit(id){
  editingEmpId = id;
  if(id && employees[id]){
    const emp = employees[id];
    $('empEditTitle').textContent = 'ì§ì› ìˆ˜ì •';
    $('empName').value = emp.name || '';
    $('empPhone').value = emp.phone || '';
    $('empRole').value = emp.role || '';
    $('empHourlyRate').value = emp.hourlyRate || 0;
    $('empMaxHours').value = emp.maxHours || 40;
    selectedColor = emp.color || PRESET_COLORS[0];
  } else {
    editingEmpId = null;
    $('empEditTitle').textContent = 'ì§ì› ì¶”ê°€';
    $('empName').value = '';
    $('empPhone').value = '';
    $('empRole').value = '';
    $('empHourlyRate').value = 0;
    $('empMaxHours').value = 40;
    selectedColor = PRESET_COLORS[0];
  }
  buildColorPicker();
  openModal($empEditModal);
}

$('addEmpBtn').addEventListener('click', ()=> openEmpEdit(null));
$('empEditClose').addEventListener('click', ()=> closeModal($empEditModal));
$('empEditCancel').addEventListener('click', ()=> closeModal($empEditModal));

$('empEditSave').addEventListener('click', async()=>{
  const name = $('empName').value.trim();
  if(!name){ showToast('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const data = {
    name: name,
    phone: $('empPhone').value.trim(),
    color: selectedColor,
    role: $('empRole').value,
    hourlyRate: parseInt($('empHourlyRate').value) || 0,
    maxHours: parseInt($('empMaxHours').value) || 40
  };
  let id = editingEmpId;
  if(!id) id = 'emp' + Date.now();
  closeModal($empEditModal);
  employees[id] = data;
  lsSaveEmployees(employees);
  renderEmpList();
  renderAll();
  const ok = await fbPut(FB_EMPLOYEES+'/'+id, data);
  if(ok) showToast('ì €ì¥ë¨');
  else showToast('ë¡œì»¬ ì €ì¥ë¨');
});

// ============================================================
// Day-off (íœ´ë¬´) Management
// ============================================================
const LS_DAYOFFS = 'ws_dayoffs';
const FB_DAYOFFS = FB_WS + '/dayoffs';
let dayoffs = {}; // {empId: {yyyy-MM-dd: true, ...}, ...}

function lsSaveDayoffs(){ try{ localStorage.setItem(LS_DAYOFFS, JSON.stringify(dayoffs)); }catch(e){} }
function lsLoadDayoffs(){ try{ const s = localStorage.getItem(LS_DAYOFFS); return s ? JSON.parse(s) : null; }catch(e){ return null; } }

function isDayOff(empId, dk){
  return dayoffs[empId] && dayoffs[empId][dk];
}

function getDayOffEmployees(dk){
  const result = [];
  for(const empId in dayoffs){
    if(dayoffs[empId][dk]) result.push(empId);
  }
  return result;
}

async function loadDayoffs(){
  const local = lsLoadDayoffs();
  if(local) dayoffs = local;
  try{
    const fb = await fbGet(FB_DAYOFFS);
    if(fb){
      // ë³‘í•©: ë¡œì»¬ ìš°ì„ 
      for(const empId in fb){
        if(!dayoffs[empId]) dayoffs[empId] = {};
        for(const dk in fb[empId]){
          if(dayoffs[empId][dk] === undefined) dayoffs[empId][dk] = fb[empId][dk];
        }
      }
      lsSaveDayoffs();
    }
  }catch(e){ console.error('loadDayoffs error', e); }
}

async function addDayOff(empId, dk){
  if(!dayoffs[empId]) dayoffs[empId] = {};
  dayoffs[empId][dk] = true;
  lsSaveDayoffs();
  // í•´ë‹¹ ë‚ ì§œ ìŠ¤ì¼€ì¤„ì— íœ´ë¬´ ë§ˆí‚¹
  const schedKey = dateKey(currentDate);
  if(dk === schedKey){
    daySchedule[empId] = {start:'', end:'', role:'íœ´ë¬´', dayoff:true};
    lsSaveSchedule(schedKey, daySchedule);
    renderTimeline();
  }
  fbPut(FB_DAYOFFS+'/'+empId+'/'+dk, true);
}

async function removeDayOff(empId, dk){
  if(dayoffs[empId]) delete dayoffs[empId][dk];
  lsSaveDayoffs();
  const schedKey = dateKey(currentDate);
  if(dk === schedKey && daySchedule[empId] && daySchedule[empId].dayoff){
    delete daySchedule[empId];
    lsSaveSchedule(schedKey, daySchedule);
    renderTimeline();
  }
  fbDelete(FB_DAYOFFS+'/'+empId+'/'+dk);
}

// Parse bulk dayoff input (ì—¬ëŸ¬ í˜•íƒœ ì§€ì›)
function parseBulkDayoffs(text){
  const results = [];
  const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
  const now = new Date();
  const thisYear = now.getFullYear();
  const thisMonth = now.getMonth() + 1;

  for(const line of lines){
    // ì§ì›ì´ë¦„ ì°¾ê¸°
    let matchedEmpId = null;
    let matchedName = '';
    let restText = line;
    for(const empId in employees){
      const name = employees[empId].name;
      if(line.startsWith(name)){
        matchedEmpId = empId;
        matchedName = name;
        restText = line.slice(name.length).trim();
        break;
      }
    }
    if(!matchedEmpId) continue;

    // ìš”ì¼ ì²˜ë¦¬ (í™”,ëª© â†’ ì´ë²ˆì£¼ í•´ë‹¹ ìš”ì¼)
    const dowMap = {'ì¼':0,'ì›”':1,'í™”':2,'ìˆ˜':3,'ëª©':4,'ê¸ˆ':5,'í† ':6};
    const dowPattern = restText.match(/^([ì¼ì›”í™”ìˆ˜ëª©ê¸ˆí† ])([,\s]+[ì¼ì›”í™”ìˆ˜ëª©ê¸ˆí† ])*/);
    if(dowPattern){
      const dows = restText.match(/[ì¼ì›”í™”ìˆ˜ëª©ê¸ˆí† ]/g);
      if(dows){
        const mon = getMonday(now);
        dows.forEach(d => {
          const target = dowMap[d];
          if(target !== undefined){
            const dt = new Date(mon);
            dt.setDate(dt.getDate() + (target === 0 ? 6 : target - 1));
            results.push({empId: matchedEmpId, date: dateKey(dt)});
          }
        });
      }
      continue;
    }

    // ë²”ìœ„ ì²˜ë¦¬ (M/D~M/D ë˜ëŠ” M/D-M/D)
    const rangeMatch = restText.match(/(\d{1,2})[\/\-](\d{1,2})\s*[~\-]\s*(\d{1,2})[\/\-](\d{1,2})/);
    if(rangeMatch){
      let [,m1,d1,m2,d2] = rangeMatch.map(Number);
      const start = new Date(thisYear, m1-1, d1);
      const end = new Date(thisYear, m2-1, d2);
      for(let d = new Date(start); d <= end; d.setDate(d.getDate()+1)){
        results.push({empId: matchedEmpId, date: dateKey(d)});
      }
      continue;
    }

    // yyyy-MM-dd í˜•íƒœ
    const isoMatch = restText.match(/(\d{4})-(\d{1,2})-(\d{1,2})/g);
    if(isoMatch){
      isoMatch.forEach(ds => {
        const [y,m,d] = ds.split('-').map(Number);
        results.push({empId: matchedEmpId, date: y+'-'+pad(m)+'-'+pad(d)});
      });
      continue;
    }

    // M/D, M/D ì½¤ë§ˆ êµ¬ë¶„
    const slashDates = restText.match(/(\d{1,2})[\/](\d{1,2})/g);
    if(slashDates && slashDates.length > 0){
      slashDates.forEach(ds => {
        const [m,d] = ds.split('/').map(Number);
        results.push({empId: matchedEmpId, date: thisYear+'-'+pad(m)+'-'+pad(d)});
      });
      continue;
    }

    // M-D ì½¤ë§ˆ êµ¬ë¶„
    const dashDates = restText.match(/(\d{1,2})-(\d{1,2})/g);
    if(dashDates && dashDates.length > 0){
      dashDates.forEach(ds => {
        const [m,d] = ds.split('-').map(Number);
        results.push({empId: matchedEmpId, date: thisYear+'-'+pad(m)+'-'+pad(d)});
      });
    }
  }
  return results;
}

// Render dayoff modal
const $dayoffModal = $('dayoffModal');

function renderDayoffList(){
  const list = $('dayoffList');
  const select = $('dayoffEmpSelect');

  // populate employee select
  select.innerHTML = '';
  for(const empId in employees){
    const opt = document.createElement('option');
    opt.value = empId;
    opt.textContent = employees[empId].name;
    select.appendChild(opt);
  }

  // Set default date
  $('dayoffDate').value = dateKey(currentDate);

  // Render list grouped by date (upcoming first)
  const allEntries = [];
  for(const empId in dayoffs){
    for(const dk in dayoffs[empId]){
      if(dayoffs[empId][dk]) allEntries.push({empId, date:dk});
    }
  }
  allEntries.sort((a,b) => a.date.localeCompare(b.date));

  if(allEntries.length === 0){
    list.innerHTML = '<div style="color:#707088;font-size:.8rem;padding:8px;">ë“±ë¡ëœ íœ´ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }

  let html = '';
  let lastDate = '';
  for(const entry of allEntries){
    if(entry.date !== lastDate){
      const d = new Date(entry.date);
      const dow = DOW_KR[d.getDay()];
      html += '<div style="font-size:.75rem;color:#9090A8;margin-top:8px;margin-bottom:2px;">'+entry.date+' ('+dow+')</div>';
      lastDate = entry.date;
    }
    const emp = employees[entry.empId];
    const name = emp ? emp.name : entry.empId;
    const color = emp ? emp.color : '#9090A8';
    html += '<div style="display:flex;align-items:center;gap:6px;padding:4px 8px;background:#1A1A30;border-radius:6px;margin-bottom:3px;">';
    html += '<span style="width:8px;height:8px;border-radius:50%;background:'+color+';flex-shrink:0;"></span>';
    html += '<span style="flex:1;font-size:.85rem;">'+name+'</span>';
    html += '<button class="btn btn-sm" style="min-width:30px;min-height:26px;padding:2px 6px;font-size:.7rem;color:#E74C3C;border-color:#E74C3C55;" data-dayoff-del="'+entry.empId+'|'+entry.date+'">âœ•</button>';
    html += '</div>';
  }
  list.innerHTML = html;

  // Delete buttons
  list.querySelectorAll('[data-dayoff-del]').forEach(btn => {
    btn.addEventListener('click', async ()=>{
      const [empId, dk] = btn.dataset.dayoffDel.split('|');
      await removeDayOff(empId, dk);
      renderDayoffList();
    });
  });
}

$('dayoffMgrBtn').addEventListener('click', ()=>{
  renderDayoffList();
  openModal($dayoffModal);
});
$('dayoffModalClose').addEventListener('click', ()=> closeModal($dayoffModal));
$dayoffModal.addEventListener('click', (e)=>{ if(e.target === $dayoffModal) closeModal($dayoffModal); });

// Single add
$('dayoffAddBtn').addEventListener('click', async ()=>{
  const empId = $('dayoffEmpSelect').value;
  const dk = $('dayoffDate').value;
  if(!empId || !dk) return;
  await addDayOff(empId, dk);
  showToast((employees[empId]?.name||'')+' '+dk+' íœ´ë¬´ ë“±ë¡');
  renderDayoffList();
});

// Bulk add
$('dayoffBulkBtn').addEventListener('click', async ()=>{
  const text = $('dayoffBulkInput').value.trim();
  if(!text) return;
  const entries = parseBulkDayoffs(text);
  if(entries.length === 0){
    showToast('ì¸ì‹ëœ íœ´ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  for(const e of entries){
    await addDayOff(e.empId, e.date);
  }
  $('dayoffBulkInput').value = '';
  showToast(entries.length+'ê±´ íœ´ë¬´ ë“±ë¡ ì™„ë£Œ');
  renderDayoffList();
});

// ============================================================
// Day Navigation
// ============================================================
$('prevDay').addEventListener('click', ()=>{
  currentDate.setDate(currentDate.getDate()-1);
  onDateChange();
});
$('nextDay').addEventListener('click', ()=>{
  currentDate.setDate(currentDate.getDate()+1);
  onDateChange();
});

// ============================================================
// Refresh Button
// ============================================================
$('refreshBtn').addEventListener('click', ()=>{
  showToast('ìƒˆë¡œê³ ì¹¨...');
  location.reload();
});

// ============================================================
// Contact Import (NativeBridge or Contact Picker API)
// ============================================================
$('contactImportBtn').addEventListener('click', async()=>{
  let contacts = null;

  // 1) Try NativeBridge (ì•± ë‚´)
  if(window.NativeBridge && window.NativeBridge.getContacts){
    try{
      const raw = window.NativeBridge.getContacts();
      contacts = JSON.parse(raw);
    }catch(e){ console.error('NativeBridge contacts error',e); }
  }

  // 2) Fallback: Contact Picker API (Chrome/ì›¹)
  if(!contacts && 'contacts' in navigator && 'ContactsManager' in window){
    try{
      const props = ['name','tel'];
      const opts = {multiple:true};
      const picked = await navigator.contacts.select(props, opts);
      contacts = picked.map(c => ({
        name: (c.name && c.name[0]) || '',
        phone: (c.tel && c.tel[0]) || ''
      }));
    }catch(e){
      if(e.name !== 'TypeError') console.error('Contact Picker error',e);
    }
  }

  if(!contacts || contacts.length === 0){
    showToast('ì—°ë½ì²˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    return;
  }

  // Show selection UI
  openContactPicker(contacts);
});

function openContactPicker(contacts){
  // Reuse empModal body for contact selection
  const $list = $('empList');
  $list.innerHTML = '<div style="padding:8px 0;font-size:.85rem;color:#FFD700;font-weight:600;">ì—°ë½ì²˜ ì„ íƒ (íƒ­í•˜ì—¬ ì¶”ê°€)</div>';

  const existingNames = new Set(Object.values(employees).map(e => e.name));

  contacts.forEach(c => {
    if(!c.name) return;
    const item = document.createElement('div');
    item.className = 'emp-list-item';
    const alreadyExists = existingNames.has(c.name);
    item.innerHTML =
      '<div class="emp-dot" style="background:'+(alreadyExists?'#2ECC71':'#9090A8')+'"></div>'+
      '<div class="emp-info">'+
        '<div class="name">'+c.name+'</div>'+
        '<div class="detail">'+(c.phone||'ì „í™”ì—†ìŒ')+(alreadyExists?' (ë“±ë¡ë¨)':'')+'</div>'+
      '</div>'+
      (alreadyExists ? '' : '<button class="btn btn-sm btn-accent" data-cname="'+c.name.replace(/"/g,'&quot;')+'" data-cphone="'+(c.phone||'').replace(/"/g,'&quot;')+'">ì¶”ê°€</button>');
    $list.appendChild(item);
  });

  // Back button
  const backBtn = document.createElement('button');
  backBtn.className = 'btn';
  backBtn.style.cssText = 'width:100%;margin-top:8px;';
  backBtn.textContent = 'ëŒì•„ê°€ê¸°';
  backBtn.addEventListener('click', ()=> renderEmpList());
  $list.appendChild(backBtn);

  // Add button handlers
  $list.querySelectorAll('[data-cname]').forEach(btn => {
    btn.addEventListener('click', async()=>{
      const name = btn.dataset.cname;
      const phone = btn.dataset.cphone;
      const colorIdx = Object.keys(employees).length % PRESET_COLORS.length;
      const data = {
        name: name,
        phone: phone,
        color: PRESET_COLORS[colorIdx],
        role: '',
        hourlyRate: 0,
        maxHours: 40
      };
      const id = 'emp' + Date.now();
      employees[id] = data;
      lsSaveEmployees(employees);
      const ok = await fbPut(FB_EMPLOYEES+'/'+id, data);
      if(ok){
        btn.textContent = 'ì™„ë£Œ';
        btn.disabled = true;
        btn.style.opacity = '.5';
        showToast(name+' ì¶”ê°€ë¨');
        renderAll();
      }
    });
  });
}

// ============================================================
// Collapsible sections (localStorage persistence)
// ============================================================
function setupCollapsible(toggleId, arrowId, bodyId, storageKey, defaultOpen){
  const body = $(bodyId);
  const arrow = $(arrowId);
  const stored = localStorage.getItem(storageKey);
  const isOpen = stored !== null ? stored === 'true' : defaultOpen;
  if(isOpen){
    body.classList.add('open');
    arrow.classList.add('open');
  }
  $(toggleId).addEventListener('click', ()=>{
    const open = body.classList.toggle('open');
    arrow.classList.toggle('open', open);
    localStorage.setItem(storageKey, open);
  });
}

setupCollapsible('weekToggle','weekArrow','weekBody','ws_week_open', false);
setupCollapsible('infoToggle','infoArrow','infoBody','ws_info_open', false);
setupCollapsible('aiToggle','aiArrow','aiBody','ws_ai_open', false);
setupCollapsible('shareToggle','shareArrow','shareBody','ws_share_open', false);

// ============================================================
// Share / Image
// ============================================================
$('shareImageBtn').addEventListener('click', async()=>{
  showToast('ìº¡ì²˜ ì¤‘...');
  try{
    const canvas = await html2canvas($('timelineSection'),{
      backgroundColor:'#1A1A30',
      scale:2,
      useCORS:true,
      logging:false
    });
    const base64 = canvas.toDataURL('image/png');
    if(window.NativeBridge && window.NativeBridge.shareImage){
      window.NativeBridge.shareImage(base64);
    } else {
      const link = document.createElement('a');
      const m = currentDate.getMonth()+1;
      const d = currentDate.getDate();
      link.download = 'ê·¼ë¬´í‘œ_'+m+'ì›”'+d+'ì¼.png';
      link.href = base64;
      link.click();
      showToast('ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
    }
  }catch(e){
    console.error('html2canvas error',e);
    showToast('ìº¡ì²˜ ì‹¤íŒ¨');
  }
});

$('shareTextBtn').addEventListener('click', ()=>{
  const empKeys = Object.keys(employees);
  const m = currentDate.getMonth()+1;
  const d = currentDate.getDate();
  const dow = DOW_KR[currentDate.getDay()];
  let text = 'ê·¼ë¬´í‘œ '+m+'/'+d+' ('+dow+')\n';
  text += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
  let hasShift = false;
  empKeys.forEach(empId => {
    const emp = employees[empId];
    const shift = daySchedule[empId];
    if(shift && shift.start){
      text += emp.name+': '+shift.start+'~'+shift.end;
      if(shift.role) text += ' ('+shift.role+')';
      text += ' ['+calcHours(shift.start,shift.end)+'h]\n';
      hasShift = true;
    }
  });
  if(!hasShift) text += '(ê·¼ë¬´ ì—†ìŒ)\n';

  if(window.NativeBridge && window.NativeBridge.shareText){
    window.NativeBridge.shareText(text);
  } else if(navigator.clipboard){
    navigator.clipboard.writeText(text).then(()=> showToast('í…ìŠ¤íŠ¸ ë³µì‚¬ë¨'));
  } else {
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('í…ìŠ¤íŠ¸ ë³µì‚¬ë¨');
  }
});

$('copyUrlBtn').addEventListener('click', ()=>{
  const url = window.location.href;
  if(navigator.clipboard){
    navigator.clipboard.writeText(url).then(()=> showToast('URL ë³µì‚¬ë¨'));
  } else {
    const ta = document.createElement('textarea');
    ta.value = url;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('URL ë³µì‚¬ë¨');
  }
});

// ============================================================
// Gemini AI Integration
// ============================================================
const GEMINI_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
let geminiKey = '';

function loadAiKey(){
  // Priority 1: localStorage
  let k = localStorage.getItem('ws_gemini_key') || '';
  // Priority 2: Firebase (BankTotal shared key)
  if(!k){
    fetch(FB_BASE+'/banktotal/settings/gemini_key.json')
      .then(r=>r.json())
      .then(d=>{
        if(d && typeof d === 'string'){
          geminiKey = d;
          localStorage.setItem('ws_gemini_key', d);
        }
      }).catch(()=>{});
  } else {
    geminiKey = k;
  }
  // Also refresh from Firebase in background
  if(k){
    fetch(FB_BASE+'/banktotal/settings/gemini_key.json')
      .then(r=>r.json())
      .then(d=>{
        if(d && typeof d === 'string' && d !== k){
          geminiKey = d;
          localStorage.setItem('ws_gemini_key', d);
        }
      }).catch(()=>{});
  }
}

async function callGemini(prompt){
  if(!geminiKey) loadAiKey();
  if(!geminiKey) throw new Error('Gemini API í‚¤ ì—†ìŒ');
  const r = await fetch(GEMINI_URL+'?key='+geminiKey,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})
  });
  if(!r.ok){
    const err = await r.json().catch(()=>({}));
    throw new Error(err.error?.message || 'Gemini API ì˜¤ë¥˜ '+r.status);
  }
  const d = await r.json();
  return d.candidates?.[0]?.content?.parts?.[0]?.text || '';
}

// ============================================================
// Weather & Sports (Gemini)
// ============================================================
let weatherCache = {date:'', data:''};
let sportsCache = {date:'', data:''};

async function loadWeatherAndSports(){
  const today = new Date();
  const todayStr = dateStr(today);
  const $weather = $('weatherInfo');
  const $sports = $('sportsInfo');

  // Weather
  if(weatherCache.date === todayStr && weatherCache.data){
    $weather.innerHTML = weatherCache.data;
  } else {
    try{
      const wPrompt = 'ì˜¤ëŠ˜ ë‚ ì§œ: '+todayStr+'. ê²½ê¸°ë„ ì´ì²œì‹œ ì˜¤ëŠ˜ ë‚ ì”¨ë¥¼ í•œì¤„ë¡œ ì•Œë ¤ì¤˜. ê¸°ì˜¨, ê°•ìˆ˜í™•ë¥ , ë¹„/ëˆˆ/ê²°ë¹™ ì—¬ë¶€ë§Œ. ë°°ë‹¬ì— ì˜í–¥ ìˆìœ¼ë©´ "ë°°ë‹¬ì£¼ì˜" ì¶”ê°€. 50ì ì´ë‚´. ìˆœìˆ˜ í…ìŠ¤íŠ¸ë§Œ (ë§ˆí¬ë‹¤ìš´ ê¸ˆì§€).';
      const wResult = await callGemini(wPrompt);
      const wClean = wResult.replace(/\*/g,'').replace(/\n/g,' ').trim().substring(0,80);
      weatherCache = {date:todayStr, data:wClean};
      localStorage.setItem('ws_weather_cache', JSON.stringify(weatherCache));
      $weather.innerHTML = wClean;
    }catch(e){
      const cached = localStorage.getItem('ws_weather_cache');
      if(cached){
        try{
          const c = JSON.parse(cached);
          $weather.innerHTML = c.data || '<span class="info-placeholder">ë‚ ì”¨ ë¡œë”© ì‹¤íŒ¨</span>';
        }catch(x){ $weather.innerHTML = '<span class="info-placeholder">ë‚ ì”¨ ë¡œë”© ì‹¤íŒ¨</span>'; }
      } else {
        $weather.innerHTML = '<span class="info-placeholder">ë‚ ì”¨ ë¡œë”© ì‹¤íŒ¨</span>';
      }
    }
  }

  // Sports
  if(sportsCache.date === todayStr && sportsCache.data){
    $sports.innerHTML = sportsCache.data;
  } else {
    try{
      const sPrompt = 'ì˜¤ëŠ˜ ë‚ ì§œ: '+todayStr+'. ì˜¤ëŠ˜/ë‚´ì¼ ì¤‘ í•œêµ­ ìŠ¤í¬ì¸  ê²½ê¸° ì¼ì • ì•Œë ¤ì¤˜. KBO(í”„ë¡œì•¼êµ¬), í•œêµ­ êµ­ê°€ëŒ€í‘œ ì¶•êµ¬, ì±”í”¼ì–¸ìŠ¤ë¦¬ê·¸ë§Œ. ê²½ê¸° ì—†ìœ¼ë©´ "ê²½ê¸°ì—†ìŒ". ê° ê²½ê¸° íŒ€+ì‹œê°„ë§Œ í•œì¤„ì”©. 80ì ì´ë‚´. ìˆœìˆ˜ í…ìŠ¤íŠ¸ë§Œ (ë§ˆí¬ë‹¤ìš´ ê¸ˆì§€).';
      const sResult = await callGemini(sPrompt);
      const sClean = sResult.replace(/\*/g,'').replace(/\n/g,' | ').trim().substring(0,120);
      sportsCache = {date:todayStr, data:sClean};
      localStorage.setItem('ws_sports_cache', JSON.stringify(sportsCache));
      $sports.innerHTML = sClean;
    }catch(e){
      const cached = localStorage.getItem('ws_sports_cache');
      if(cached){
        try{
          const c = JSON.parse(cached);
          $sports.innerHTML = c.data || '<span class="info-placeholder">ê²½ê¸° ë¡œë”© ì‹¤íŒ¨</span>';
        }catch(x){ $sports.innerHTML = '<span class="info-placeholder">ê²½ê¸° ë¡œë”© ì‹¤íŒ¨</span>'; }
      } else {
        $sports.innerHTML = '<span class="info-placeholder">ê²½ê¸° ë¡œë”© ì‹¤íŒ¨</span>';
      }
    }
  }
}

// ============================================================
// Logistics Check (min 2 people, 3 after 16:30)
// ============================================================
function checkLogistics(){
  const $log = $('logisticsInfo');
  const empKeys = Object.keys(employees);
  if(empKeys.length === 0){
    $log.innerHTML = '<span class="info-placeholder">ì§ì› ë°ì´í„° ì—†ìŒ</span>';
    return;
  }

  const issues = [];
  // Check each hour from 10:00 to 03:00
  const checkHours = [10,11,12,13,14,15,16,17,18,19,20,21,22,23,0,1,2,3];
  let hasShifts = false;
  checkHours.forEach(hour => {
    let count = 0;
    empKeys.forEach(empId => {
      const shift = daySchedule[empId];
      if(shift && shift.start && shift.end){
        hasShifts = true;
        if(isHourInShift(hour, shift.start, shift.end)) count++;
      }
    });
    if(!hasShifts) return;
    const hLabel = pad(hour)+':00';
    // After 16:30 need 3 people (check 16,17,...23,0,1,2,3)
    const isEvening = (hour >= 16 && hour <= 23) || hour < 4;
    const minRequired = isEvening ? 3 : 2;
    if(count < minRequired && count >= 0){
      issues.push(hLabel+' '+count+'ëª…(ìµœì†Œ'+minRequired+')');
    }
  });

  if(!hasShifts){
    $log.innerHTML = '<span class="info-placeholder">ì˜¤ëŠ˜ ê·¼ë¬´ ì—†ìŒ</span>';
  } else if(issues.length === 0){
    $log.innerHTML = '<span class="logistics-ok">ì¸ì› ì¶©ì¡±</span>';
  } else {
    $log.innerHTML = '<span class="logistics-warn">ë¶€ì¡±: '+issues.slice(0,4).join(', ')+(issues.length>4?' ì™¸ '+(issues.length-4)+'ê±´':'')+'</span>';
  }
}

// ============================================================
// AI Scheduling Chat
// ============================================================
let aiProcessing = false;

function buildScheduleContext(targetDates){
  const empKeys = Object.keys(employees);
  let ctx = '## ì§ì› ëª©ë¡\n';
  empKeys.forEach(id => {
    const e = employees[id];
    ctx += '- '+e.name+' (ID:'+id+', ì—­í• :'+( e.role||'ë¯¸ì§€ì •')+', ì£¼ê°„ìµœëŒ€:'+(e.maxHours||40)+'h)\n';
  });
  ctx += '\n## í˜„ì¬ ìŠ¤ì¼€ì¤„\n';
  if(targetDates && targetDates.length > 0){
    targetDates.forEach(dk => {
      const sched = weekSchedules[dk] || daySchedule;
      ctx += dk+': ';
      const parts = [];
      empKeys.forEach(id => {
        const s = (dk === dateKey(currentDate)) ? daySchedule[id] : (weekSchedules[dk]||{})[id];
        if(s && s.start) parts.push(employees[id].name+' '+s.start+'~'+s.end+(s.role?' ('+s.role+')':''));
      });
      ctx += parts.length > 0 ? parts.join(', ') : '(ì—†ìŒ)';
      ctx += '\n';
    });
  }
  ctx += '\n## ê·œì¹™\n';
  ctx += '- ì˜ì—…ì‹œê°„: 10:00~03:00 (ìƒˆë²½)\n';
  ctx += '- ìµœì†Œ ì¸ì›: 10:00~16:00 2ëª…, 16:00~03:00 3ëª…\n';
  ctx += '- ë°°ë‹¬ ì—­í•  í•„ìš” (16:30 ì´í›„ ë¬¼ë¥˜)\n';
  ctx += '- ê·¼ë¬´ì‹œê°„: 06:00~03:00 ë²”ìœ„, 30ë¶„ ë‹¨ìœ„\n';
  ctx += '- ì‹œê°„ í˜•ì‹: HH:MM (24ì‹œê°„)\n';
  if(weatherCache.data) ctx += '\n## ë‚ ì”¨: '+weatherCache.data+'\n';
  if(sportsCache.data) ctx += '\n## ê²½ê¸°ì¼ì •: '+sportsCache.data+'\n';
  return ctx;
}

function getTargetDates(userMsg){
  const today = new Date();
  const todayDk = dateStr(today);
  if(/ì´ë²ˆ\s*ì£¼|ì´ë²ˆì£¼/.test(userMsg)){
    const mon = getMonday(today);
    const dates = [];
    for(let i=0;i<7;i++){
      const d = new Date(mon);
      d.setDate(d.getDate()+i);
      dates.push(dateStr(d));
    }
    return dates;
  }
  if(/ë‚´ì¼/.test(userMsg)){
    const tm = new Date(today);
    tm.setDate(tm.getDate()+1);
    return [dateStr(tm)];
  }
  if(/ëª¨ë ˆ|ëª¨ë˜/.test(userMsg)){
    const tm = new Date(today);
    tm.setDate(tm.getDate()+2);
    return [dateStr(tm)];
  }
  // Default: current displayed date
  return [dateKey(currentDate)];
}

async function sendAiMessage(userMsg){
  if(aiProcessing) return;
  if(!userMsg.trim()) return;
  if(!geminiKey){ showToast('Gemini API í‚¤ ë¡œë”©ì¤‘...'); loadAiKey(); return; }
  aiProcessing = true;

  const $chat = $('aiChatList');
  // User message
  const userDiv = document.createElement('div');
  userDiv.className = 'ai-msg user';
  userDiv.textContent = userMsg;
  $chat.appendChild(userDiv);

  // Loading
  const loadDiv = document.createElement('div');
  loadDiv.className = 'ai-msg ai loading';
  loadDiv.textContent = 'ìƒê°ì¤‘...';
  $chat.appendChild(loadDiv);
  $chat.scrollTop = $chat.scrollHeight;

  try{
    const targetDates = getTargetDates(userMsg);
    const ctx = buildScheduleContext(targetDates);

    const prompt = `ë„ˆëŠ” ë§¤ì¥ ê·¼ë¬´ ìŠ¤ì¼€ì¤„ ê´€ë¦¬ AIì•¼. í•œêµ­ì–´ë¡œ ë‹µë³€í•´.

${ctx}

## ìš”ì²­
${userMsg}

## ì‘ë‹µ í˜•ì‹
ìŠ¤ì¼€ì¤„ ë°°ì¹˜ ìš”ì²­ì´ë©´ ë°˜ë“œì‹œ ì•„ë˜ JSON ë°°ì—´ì„ í¬í•¨í•´:
\`\`\`json
[{"date":"YYYY-MM-DD","empId":"emp1","start":"HH:MM","end":"HH:MM","role":"ì£¼ë°©|ë°°ë‹¬|ì˜¤ì „"}]
\`\`\`
ìŠ¤ì¼€ì¤„ ë°°ì¹˜ê°€ ì•„ë‹Œ ì§ˆë¬¸ì´ë©´ í…ìŠ¤íŠ¸ë¡œ ë‹µë³€í•´.
ë‹µë³€ì€ ê°„ê²°í•˜ê²Œ (200ì ì´ë‚´ ì„¤ëª… + JSON).`;

    const result = await callGemini(prompt);
    $chat.removeChild(loadDiv);

    // Parse response
    const aiDiv = document.createElement('div');
    aiDiv.className = 'ai-msg ai';

    // Extract JSON if present
    const jsonMatch = result.match(/```json\s*([\s\S]*?)```/);
    let scheduleData = null;
    if(jsonMatch){
      try{
        scheduleData = JSON.parse(jsonMatch[1].trim());
      }catch(e){ /* not valid JSON */ }
    }

    // Clean text (remove json block)
    let textPart = result.replace(/```json[\s\S]*?```/g, '').replace(/\*/g,'').trim();
    if(textPart.length > 300) textPart = textPart.substring(0,300)+'...';

    let html = textPart.replace(/\n/g,'<br>');
    if(scheduleData && Array.isArray(scheduleData) && scheduleData.length > 0){
      html += '<br><br>';
      scheduleData.forEach(s => {
        const emp = employees[s.empId];
        const name = emp ? emp.name : s.empId;
        html += '<span style="color:#FFD700">'+s.date+'</span> '+name+' '+s.start+'~'+s.end+(s.role?' ('+s.role+')':'')+' <br>';
      });
      html += '<button class="ai-apply-btn" id="aiApplyBtn_'+(+new Date())+'">ì ìš©í•˜ê¸°</button>';
    }
    aiDiv.innerHTML = html;
    $chat.appendChild(aiDiv);
    // Attach apply handler via JS (not onclick attribute â€” safer)
    if(scheduleData){
      const applyBtn = aiDiv.querySelector('.ai-apply-btn');
      if(applyBtn){
        const capturedData = scheduleData;
        applyBtn.addEventListener('click', ()=> window.applyAiSchedule(capturedData));
      }
    }
  }catch(e){
    $chat.removeChild(loadDiv);
    const errDiv = document.createElement('div');
    errDiv.className = 'ai-msg ai';
    errDiv.style.color = '#E74C3C';
    errDiv.textContent = 'AI ì˜¤ë¥˜: '+e.message;
    $chat.appendChild(errDiv);
  }
  $chat.scrollTop = $chat.scrollHeight;
  aiProcessing = false;
}

// Global: apply AI schedule
window.applyAiSchedule = async function(data){
  if(!Array.isArray(data)) return;
  let applied = 0;
  for(const s of data){
    if(!s.date || !s.empId || !s.start || !s.end) continue;
    const shiftData = {start:s.start, end:s.end, role:s.role||''};
    // localStorage first
    const lsData = lsLoadSchedule(s.date) || {};
    lsData[s.empId] = shiftData;
    lsSaveSchedule(s.date, lsData);
    if(s.date === dateKey(currentDate)){
      daySchedule[s.empId] = shiftData;
    }
    const ok = await fbPut(FB_SCHEDULES+'/'+s.date+'/'+s.empId, shiftData);
    if(ok) applied++;
  }
  renderTimeline();
  loadWeekSchedules();
  showToast(applied+'ê±´ ì ìš© ì™„ë£Œ');
};

// AI event listeners
$('aiSendBtn').addEventListener('click', ()=>{
  const input = $('aiInput');
  sendAiMessage(input.value);
  input.value = '';
});
$('aiInput').addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){
    e.preventDefault();
    const input = $('aiInput');
    sendAiMessage(input.value);
    input.value = '';
  }
});
document.querySelectorAll('.ai-quick').forEach(btn => {
  btn.addEventListener('click', ()=> sendAiMessage(btn.dataset.prompt));
});

// ============================================================
// .ics Calendar Generation (iPhone + Galaxy compatible)
// ============================================================
function generateICS(events, filename){
  let ics = 'BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//WorkSchedule//KR\r\nCALSCALE:GREGORIAN\r\nMETHOD:PUBLISH\r\n';
  events.forEach(ev => {
    const [y,mo,d] = ev.date.split('-');
    const [sh,sm] = ev.start.split(':').map(Number);
    const [eh,em] = ev.end.split(':').map(Number);
    // Handle overnight shifts (end hour < start hour means next day)
    let endDate = ev.date;
    if(eh < sh || (eh === sh && em < sm)){
      const nd = new Date(parseInt(y), parseInt(mo)-1, parseInt(d));
      nd.setDate(nd.getDate()+1);
      endDate = dateStr(nd);
    }
    const [ey,emo,ed] = endDate.split('-');
    const dtStart = y+mo+d+'T'+pad(sh)+pad(sm)+'00';
    const dtEnd = ey+emo+ed+'T'+pad(eh)+pad(em)+'00';
    const uid = ev.date+'-'+ev.empId+'-'+(+new Date())+'@workschedule';
    ics += 'BEGIN:VEVENT\r\n';
    ics += 'UID:'+uid+'\r\n';
    ics += 'DTSTART;TZID=Asia/Seoul:'+dtStart+'\r\n';
    ics += 'DTEND;TZID=Asia/Seoul:'+dtEnd+'\r\n';
    ics += 'SUMMARY:'+ev.summary+'\r\n';
    if(ev.description) ics += 'DESCRIPTION:'+ev.description+'\r\n';
    ics += 'END:VEVENT\r\n';
  });
  ics += 'END:VCALENDAR\r\n';
  downloadBlob(ics, filename, 'text/calendar;charset=utf-8');
}

function downloadBlob(content, filename, mime){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(()=> URL.revokeObjectURL(url), 1000);
}

function buildCalButtons(){
  const $btns = $('calBtns');
  if(!$btns) return;
  $btns.innerHTML = '';
  const empKeys = Object.keys(employees);
  empKeys.forEach(empId => {
    const emp = employees[empId];
    const shift = daySchedule[empId];
    if(!shift || !shift.start) return;
    const btn = document.createElement('button');
    btn.className = 'cal-btn';
    btn.innerHTML = '<div class="cdot" style="background:'+(emp.color||'#9090A8')+'"></div>'+emp.name;
    btn.addEventListener('click', ()=>{
      const dk = dateKey(currentDate);
      const events = [{
        date:dk, empId:empId,
        start:shift.start, end:shift.end,
        summary:'ê·¼ë¬´ - '+emp.name,
        description:'ì—­í• : '+(shift.role||'ë¯¸ì§€ì •')+', '+shift.start+'~'+shift.end
      }];
      const m = currentDate.getMonth()+1;
      const d = currentDate.getDate();
      generateICS(events, emp.name+'_'+m+'ì›”'+d+'ì¼.ics');
      showToast(emp.name+' ìº˜ë¦°ë” ë‹¤ìš´ë¡œë“œ');
    });
    $btns.appendChild(btn);
  });
}

$('calAllBtn').addEventListener('click', ()=>{
  const empKeys = Object.keys(employees);
  const events = [];
  const dk = dateKey(currentDate);
  empKeys.forEach(empId => {
    const emp = employees[empId];
    const shift = daySchedule[empId];
    if(!shift || !shift.start) return;
    events.push({
      date:dk, empId:empId,
      start:shift.start, end:shift.end,
      summary:'ê·¼ë¬´ - '+emp.name,
      description:'ì—­í• : '+(shift.role||'ë¯¸ì§€ì •')+', '+shift.start+'~'+shift.end
    });
  });
  if(events.length === 0){ showToast('ì˜¤ëŠ˜ ê·¼ë¬´ ì—†ìŒ'); return; }
  const m = currentDate.getMonth()+1;
  const d = currentDate.getDate();
  generateICS(events, 'ê·¼ë¬´í‘œ_'+m+'ì›”'+d+'ì¼.ics');
  showToast('ì „ì²´ ìº˜ë¦°ë” ë‹¤ìš´ë¡œë“œ');
});

// ============================================================
// Visibility change handler (foreground return)
// ============================================================
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState === 'visible'){
    connectSSE();
    loadData();
    loadWeatherAndSports();
  }
});

// ============================================================
// Close modals on overlay click
// ============================================================
[$shiftModal, $monthModal, $empModal, $empEditModal].forEach(modal => {
  modal.addEventListener('click', (e)=>{
    if(e.target === modal) closeModal(modal);
  });
});

// ============================================================
// Init
// ============================================================
function init(){
  currentDate = new Date();
  updateDateDisplay();
  buildTimeGrids();
  loadAiKey();
  loadDayoffs();
  loadData().then(()=>{
    // Load weather after data + key ready
    setTimeout(()=>{
      loadHourlyWeather().then(()=> renderTimeline());
      loadWeatherAndSports();
    }, 1500);
  });
  connectSSE();
}

init();

})();
</script>
</body>
</html>
