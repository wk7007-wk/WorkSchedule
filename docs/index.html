<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Í∑ºÎ¨¥Ìëú</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{font-size:14px;-webkit-tap-highlight-color:transparent;}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans KR',sans-serif;
  background:#1A1A30;
  color:#E0E0EC;
  min-height:100vh;
  padding:0;margin:0;
}
::-webkit-scrollbar{height:6px;width:6px;}
::-webkit-scrollbar-track{background:#1A1A30;}
::-webkit-scrollbar-thumb{background:#2E2E52;border-radius:3px;}

/* ===== Header ===== */
.header{
  z-index:100;
  position:sticky;top:0;
  background:#1A1A30;
  border-bottom:1px solid #2E2E52;
  padding:6px 6px;
  display:flex;align-items:center;justify-content:space-between;
  gap:4px;
}
.header-left{display:flex;align-items:center;gap:6px;}
.header h1{font-size:1.2rem;font-weight:700;color:#E0E0EC;white-space:nowrap;}
.header-center{display:flex;align-items:center;gap:6px;}
.date-display{
  font-size:1.05rem;font-weight:600;color:#FFD700;
  min-width:110px;text-align:center;white-space:nowrap;
}
.header-right{display:flex;align-items:center;gap:6px;}

/* ===== Buttons ===== */
.btn{
  display:inline-flex;align-items:center;justify-content:center;
  border:1px solid #2E2E52;background:#242444;color:#E0E0EC;
  border-radius:8px;cursor:pointer;font-size:.9rem;
  min-width:44px;min-height:44px;padding:8px 12px;
  transition:background .15s,border-color .15s;
  user-select:none;-webkit-user-select:none;
  white-space:nowrap;
}
.btn:active{background:#2E2E52;}
.btn-accent{background:#2ECC71;color:#121225;border-color:#2ECC71;font-weight:600;}
.btn-accent:active{background:#27ae60;}
.btn-danger{background:#E74C3C;color:#fff;border-color:#E74C3C;}
.btn-danger:active{background:#c0392b;}
.btn-gold{background:transparent;border-color:#FFD700;color:#FFD700;}
.btn-gold:active{background:#FFD70022;}
.btn-warning{background:#E67E22;color:#fff;border-color:#E67E22;}
.btn-sm{min-width:36px;min-height:36px;padding:6px 10px;font-size:.8rem;border-radius:6px;}
.nav-btn{font-size:1.1rem;padding:6px 10px;font-weight:700;}
.emp-mgr-btn{font-size:.75rem;padding:4px 10px;min-height:32px;min-width:auto;border-radius:6px;color:#9090A8;border-color:#2E2E52;}

/* ===== Layout Tabs ===== */
.layout-tabs{
  display:flex;
  background:#121225;
  border-bottom:2px solid #2E2E52;
  position:sticky;top:66px;z-index:99;
}
.layout-tab{
  flex:1;padding:8px 0;text-align:center;
  font-size:.85rem;font-weight:600;color:#707088;
  background:transparent;border:none;cursor:pointer;
  border-bottom:2px solid transparent;
  transition:color .15s,border-color .15s;
}
.layout-tab.active{color:#FFD700;border-bottom-color:#FFD700;}
.layout-tab:active{background:#1A1A3088;}
.tab-panel{display:none;}
.tab-panel.active{display:block;}

/* ===== Timeline Container ===== */
.timeline-section{
  background:#242444;
}
#timelineContent{}

/* ===== Shift Gauge ===== */
.shift-gauge-wrap{padding:4px 0;}
.shift-gauge{
  position:relative;height:32px;
  background:#1A1A30;border:1px solid #2E2E52;border-radius:6px;
  overflow:hidden;touch-action:none;cursor:pointer;
}
.shift-gauge-fill{
  position:absolute;top:0;bottom:0;
  background:#2ECC7140;border-left:2px solid #2ECC71;border-right:2px solid #E74C3C;
  border-radius:4px;
}
.shift-gauge-labels{
  position:absolute;top:0;left:0;right:0;bottom:0;
  display:flex;align-items:center;justify-content:center;
  font-size:.8rem;font-weight:700;color:#FFFFFF;
  pointer-events:none;text-shadow:0 1px 2px #000;
}

/* ===== Calendar View ===== */
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;font-size:.7rem;}
.cal-hdr{text-align:center;color:#707088;font-weight:600;padding:4px 0;font-size:.65rem;}
.cal-cell{
  background:#242444;border:1px solid #2E2E5230;border-radius:4px;
  min-height:68px;padding:3px 4px;cursor:pointer;position:relative;
}
.cal-cell.today{border-color:#FFD700;border-width:2px;background:#FFD70010;}
.cal-cell.other{opacity:.2;pointer-events:none;}
.cal-cell .cal-date{font-size:.7rem;color:#E0E0EC;font-weight:700;}
.cal-cell .cal-emp{font-size:.55rem;line-height:1.4;overflow:hidden;margin-top:1px;}

/* ===== Horizontal Timeline ===== */
.ht-row{display:flex;align-items:center;border-bottom:1px solid #2E2E5220;min-height:36px;}
.ht-name{min-width:50px;max-width:50px;font-size:.7rem;font-weight:600;color:#FFFFFF;padding:4px;text-align:center;flex-shrink:0;}
.ht-bar{flex:1;position:relative;height:28px;background:#1A1A30;border-radius:4px;margin:2px 4px;overflow:hidden;}
.ht-fill{position:absolute;top:0;bottom:0;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:600;color:#fff;text-shadow:0 1px 1px #000;}
.ht-hours{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;pointer-events:none;}
.ht-hours span{flex:1;border-right:1px solid #2E2E5220;}

/* Vertical Timeline ‚Äî Fit to screen */
.vt-header{
  display:flex;
  background:#1e1e3a;
  border-bottom:2px solid #2E2E52;
}
.vt-time-hdr{
  min-width:32px;max-width:32px;
  display:flex;align-items:center;justify-content:center;
  font-size:.7rem;color:#9090A8;
  border-right:1px solid #2E2E52;
  padding:4px 0;
}
.vt-emp-hdr{
  flex:1;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:4px 1px;
  border-right:1px solid #2E2E5230;
  min-height:36px;
}
.vt-emp-hdr:last-child{border-right:none;}
.vt-emp-hdr .vt-dot{width:10px;height:10px;border-radius:50%;margin-bottom:2px;}
.vt-emp-hdr .vt-name{font-size:.75rem;color:#FFFFFF;font-weight:700;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%;}

.vt-wrapper{
  position:relative;
  min-height:500px;
}
.vt-body{
  display:flex;
  position:relative;
  height:100%;
}
.vt-time-col{
  min-width:32px;max-width:32px;
  border-right:1px solid #2E2E52;
  flex-shrink:0;
  position:relative;
}
.vt-hour-tick{
  position:absolute;left:0;right:0;
  display:flex;align-items:flex-start;justify-content:center;
  font-size:.7rem;color:#9090A8;
  pointer-events:none;
}
.vt-hour-tick .vt-wx{
  font-size:.55rem;color:#9090A8;
  display:block;text-align:center;line-height:1.1;
}
.vt-emp-col{
  flex:1;
  position:relative;
  border-right:1px solid #2E2E5215;
  touch-action:none;
}
.vt-emp-col:last-child{border-right:none;}
.vt-grid-line{
  position:absolute;left:0;right:0;
  border-bottom:1px solid #2E2E5220;
  pointer-events:none;
}
.vt-shift{
  position:absolute;left:1px;right:1px;
  border-radius:3px;
  z-index:2;
  display:flex;align-items:center;justify-content:center;
  flex-direction:column;
  overflow:hidden;
  transition:opacity .15s;
}
.vt-shift .vt-role{font-size:.65rem;font-weight:700;}
.vt-shift .vt-time-label{font-size:.6rem;opacity:.9;}

/* Drag preview */
.vt-drag{
  position:absolute;left:1px;right:1px;
  background:#2ECC7140;
  border:1px dashed #2ECC71;
  border-radius:3px;
  z-index:3;
  pointer-events:none;
  display:flex;align-items:center;justify-content:center;
  font-size:.65rem;color:#2ECC71;font-weight:600;
}

/* Summary row */
.vt-summary{
  display:flex;
  border-top:2px solid #2E2E52;
  background:#1e1e3a;
}
.vt-summary-time{
  min-width:32px;max-width:32px;
  display:flex;align-items:center;justify-content:center;
  font-size:.65rem;color:#FFD700;font-weight:700;
  border-right:1px solid #2E2E52;
  min-height:26px;
}
.vt-summary-cell{
  flex:1;
  display:flex;align-items:center;justify-content:center;
  font-size:.6rem;font-weight:700;color:#FFFFFF;
  min-height:26px;
  border-right:1px solid #2E2E5215;
}
.vt-summary-cell:last-child{border-right:none;}

/* ===== Week Overview ===== */
.week-section{
  margin:4px 2px;
  border:1px solid #2E2E52;
  border-radius:8px;
  overflow:hidden;
  background:#242444;
}
.week-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;
  background:#1e1e3a;
  border-bottom:1px solid #2E2E52;
  cursor:pointer;user-select:none;
  min-height:44px;
}
.week-header h3{font-size:.9rem;color:#9090A8;font-weight:600;}
.week-header .arrow{color:#9090A8;transition:transform .2s;font-size:.8rem;}
.week-header .arrow.open{transform:rotate(180deg);}
.week-body{
  max-height:0;overflow:hidden;
  transition:max-height .3s ease;
}
.week-body.open{max-height:500px;}

.week-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:1px;
  padding:8px;
}
.week-day{
  background:#1A1A30;
  border:1px solid #2E2E52;
  border-radius:6px;
  padding:6px 4px;
  text-align:center;
  cursor:pointer;
  transition:background .15s;
  min-height:60px;
}
.week-day:active{background:#2A2A45;}
.week-day .day-label{font-size:.7rem;color:#707088;margin-bottom:2px;}
.week-day .day-date{font-size:.8rem;font-weight:600;color:#E0E0EC;margin-bottom:4px;}
.week-day .day-date.sun{color:#E74C3C;}
.week-day .day-date.sat{color:#4ECDC4;}
.week-day .day-count{font-size:.65rem;margin-top:3px;}

.week-offs{
  padding:8px 14px;
  border-top:1px solid #2E2E52;
  display:flex;flex-wrap:wrap;gap:8px;
  font-size:.75rem;color:#9090A8;
}
.week-offs .off-chip{
  display:flex;align-items:center;gap:4px;
  background:#1A1A30;
  padding:3px 8px;
  border-radius:4px;
}
.week-offs .off-chip .odot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.week-offs .off-chip .off-text{color:#E0E0EC;}

/* Sections below timeline */

/* ===== Info Bar ===== */
.info-section-inner{
  margin:4px 2px;
  border:1px solid #2E2E52;
  border-radius:8px;
  overflow:hidden;
  background:#242444;
}
.info-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;
  background:#1e1e3a;
  border-bottom:1px solid #2E2E52;
  cursor:pointer;user-select:none;
  min-height:44px;
}
.info-header h3{font-size:.9rem;color:#9090A8;font-weight:600;}
.info-header .arrow{color:#9090A8;transition:transform .2s;font-size:.8rem;}
.info-header .arrow.open{transform:rotate(180deg);}
.info-body{
  max-height:0;overflow:hidden;
  transition:max-height .3s ease;
}
.info-body.open{max-height:400px;}
.info-body-inner{padding:12px 14px;}

.info-row{
  display:flex;align-items:center;gap:10px;
  padding:8px 0;
  border-bottom:1px solid #2E2E5240;
  font-size:.85rem;
}
.info-row:last-child{border-bottom:none;}
.info-icon{font-size:1.1rem;flex-shrink:0;width:28px;text-align:center;}
.info-label{color:#9090A8;flex-shrink:0;min-width:60px;}
.info-value{color:#E0E0EC;flex:1;}
.info-placeholder{color:#707088;font-style:italic;font-size:.8rem;}

/* ===== Share Section ===== */
.share-section{
  margin:8px;
  border:1px solid #2E2E52;
  border-radius:10px;
  overflow:hidden;
}
.share-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;
  background:#242444;
  cursor:pointer;user-select:none;
  min-height:44px;
}
.share-header h3{font-size:.9rem;color:#9090A8;font-weight:600;}
.share-header .arrow{color:#9090A8;transition:transform .2s;font-size:.8rem;}
.share-header .arrow.open{transform:rotate(180deg);}
.share-body{
  max-height:0;overflow:hidden;padding:0;
  transition:max-height .3s ease,padding .3s ease;
  background:#1A1A35;
}
.share-body.open{max-height:200px;padding:12px 14px;}
.share-btns{display:flex;gap:10px;flex-wrap:wrap;}

/* ===== Modals ===== */
.modal-overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,.65);
  z-index:200;
  display:flex;align-items:flex-end;justify-content:center;
  opacity:0;pointer-events:none;
  transition:opacity .2s;
}
.modal-overlay.active{opacity:1;pointer-events:auto;}
.modal-content{
  background:linear-gradient(180deg,#242444,#1A1A35);
  border:1px solid #2E2E52;
  border-radius:16px 16px 0 0;
  width:100%;max-width:480px;
  max-height:85vh;
  overflow-y:auto;
  padding:20px;
  transform:translateY(100%);
  transition:transform .3s cubic-bezier(.22,.68,0,1);
  position:relative;
}
.modal-overlay.active .modal-content{transform:translateY(0);}
@media(min-width:600px){
  .modal-content{border-radius:16px;margin-bottom:40px;}
  .modal-overlay{align-items:center;}
}
.modal-title{font-size:1.1rem;font-weight:700;margin-bottom:16px;color:#E0E0EC;}
.modal-close{
  position:absolute;top:12px;right:16px;
  font-size:1.5rem;color:#9090A8;cursor:pointer;
  width:44px;height:44px;display:flex;align-items:center;justify-content:center;
  border:none;background:none;
}
.modal-footer{
  display:flex;gap:10px;margin-top:16px;
  padding-top:14px;border-top:1px solid #2E2E52;
}
.modal-footer .btn{flex:1;}

/* Form */
.form-group{margin-bottom:14px;}
.form-group label{display:block;font-size:.85rem;color:#9090A8;margin-bottom:5px;font-weight:500;}
.form-input{
  width:100%;padding:10px 12px;
  background:#1A1A30;border:1px solid #2E2E52;
  border-radius:8px;color:#E0E0EC;font-size:.95rem;
  outline:none;min-height:44px;
}
.form-input:focus{border-color:#2ECC71;}
select.form-input{
  appearance:none;-webkit-appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%239090A8' stroke-width='2' fill='none'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 12px center;
}

/* Color picker */
.color-picker{display:flex;gap:8px;flex-wrap:wrap;}
.color-swatch{
  width:40px;height:40px;border-radius:50%;
  cursor:pointer;border:3px solid transparent;
  transition:border-color .15s,transform .15s;
}
.color-swatch:active{transform:scale(.9);}
.color-swatch.selected{border-color:#FFFFFF;transform:scale(1.1);}

/* Shift modal: Employee chips */
.emp-chips{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;}
.emp-chip{
  display:flex;align-items:center;gap:5px;
  padding:6px 12px;
  background:#1A1A30;border:2px solid #2E2E52;
  border-radius:20px;cursor:pointer;
  font-size:.85rem;color:#E0E0EC;
  transition:background .15s,border-color .15s;
  min-height:40px;
}
.emp-chip .chip-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.emp-chip.selected{border-color:#2ECC71;background:#2ECC7118;}

/* Role pills */
.role-pills{display:flex;gap:8px;margin-bottom:14px;}
.role-pill{
  padding:6px 16px;
  background:#2A2A45;border:1px solid #2E2E52;
  border-radius:20px;cursor:pointer;
  font-size:.85rem;color:#E0E0EC;
  transition:background .15s,border-color .15s;
  min-height:36px;
  display:flex;align-items:center;
}
.role-pill.selected{background:var(--pill-color,#2ECC71);color:#121225;border-color:var(--pill-color,#2ECC71);font-weight:600;}
.role-pill.disabled{opacity:.3;pointer-events:none;text-decoration:line-through;}

/* Presets */
.presets{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;}
.preset-btn{
  padding:8px 14px;
  background:#2A2A45;border:1px solid #2E2E52;
  border-radius:8px;color:#E0E0EC;cursor:pointer;
  font-size:.82rem;min-height:40px;
  transition:background .1s;
}
.preset-btn:active{background:#2ECC71;color:#121225;}

/* Time picker grid */
.time-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(68px,1fr));
  gap:5px;
  max-height:160px;
  overflow-y:auto;
  padding:4px 0;
}
.time-option{
  padding:7px 4px;text-align:center;
  background:#1A1A30;border:1px solid #2E2E52;
  border-radius:6px;cursor:pointer;
  font-size:.82rem;color:#E0E0EC;
  min-height:36px;
  display:flex;align-items:center;justify-content:center;
  transition:background .1s,border-color .1s;
}
.time-option:active,.time-option.selected{
  background:#2ECC71;color:#121225;border-color:#2ECC71;font-weight:600;
}

/* Employee list in emp modal */
.emp-list-item{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 12px;
  background:#1A1A30;border:1px solid #2E2E52;
  border-radius:8px;margin-bottom:8px;
  min-height:48px;gap:8px;
}
.emp-list-item .emp-dot{width:14px;height:14px;border-radius:50%;flex-shrink:0;}
.emp-list-item .emp-info{flex:1;min-width:0;}
.emp-list-item .emp-info .name{font-weight:600;font-size:.9rem;}
.emp-list-item .emp-info .detail{font-size:.72rem;color:#9090A8;margin-top:2px;}
.emp-list-actions{display:flex;gap:6px;}

/* Month view modal */
.month-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:4px;
  margin-top:8px;
}
.month-dow-label{
  text-align:center;font-size:.7rem;color:#707088;padding:4px 0;
}
.month-day-cell{
  text-align:center;padding:6px 2px;
  background:#1A1A30;border:1px solid #2E2E52;
  border-radius:6px;cursor:pointer;
  min-height:44px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  transition:background .15s;
}
.month-day-cell:active{background:#2A2A45;}
.month-day-cell.empty{background:transparent;border-color:transparent;cursor:default;}
.month-day-cell.today{border-color:#FFD700;}
.month-day-cell.has-staff{background:#2ECC7115;border-color:#2ECC7140;}
.month-day-cell .md-num{font-size:.85rem;font-weight:600;color:#E0E0EC;}
.month-day-cell .md-num.sun{color:#E74C3C;}
.month-day-cell .md-num.sat{color:#4A9EFF;}
.month-day-cell .md-count{font-size:.6rem;color:#2ECC71;margin-top:2px;}

/* ===== Toast ===== */
.toast{
  position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);
  background:#2ECC71;color:#121225;
  padding:10px 20px;border-radius:8px;
  font-size:.9rem;font-weight:600;
  opacity:0;pointer-events:none;
  transition:opacity .3s,transform .3s;
  z-index:999;white-space:nowrap;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* ===== Loading ===== */
.loading{
  display:flex;align-items:center;justify-content:center;
  padding:40px;color:#9090A8;font-size:.95rem;
}
.spinner{
  width:24px;height:24px;border:3px solid #2E2E52;
  border-top-color:#2ECC71;border-radius:50%;
  animation:spin .6s linear infinite;margin-right:10px;
}
@keyframes spin{to{transform:rotate(360deg);}}

/* ===== AI Section ===== */
.ai-section{
  margin:4px 2px;
  border:1px solid #2E2E52;
  border-radius:8px;
  overflow:hidden;
  background:#242444;
}
.ai-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;
  background:#1e1e3a;
  border-bottom:1px solid #2E2E52;
  cursor:pointer;user-select:none;
  min-height:44px;
}
.ai-header h3{font-size:.9rem;color:#FFD700;font-weight:600;}
.ai-header .arrow{color:#9090A8;transition:transform .2s;font-size:.8rem;}
.ai-header .arrow.open{transform:rotate(180deg);}
.ai-body{
  max-height:0;overflow:hidden;
  transition:max-height .3s ease;
}
.ai-body.open{max-height:600px;}
.ai-body-inner{padding:12px 14px;}
.ai-chat-list{
  max-height:280px;overflow-y:auto;
  padding:8px 14px;
  display:flex;flex-direction:column;gap:8px;
}
.ai-msg{
  padding:8px 12px;border-radius:10px;
  font-size:.85rem;line-height:1.4;
  max-width:90%;word-break:break-word;
}
.ai-msg.user{
  align-self:flex-end;
  background:#2ECC7128;border:1px solid #2ECC7140;
  color:#E0E0EC;
}
.ai-msg.ai{
  align-self:flex-start;
  background:#1A1A30;border:1px solid #2E2E52;
  color:#E0E0EC;
}
.ai-msg.ai .ai-apply-btn{
  display:inline-block;
  margin-top:6px;padding:4px 12px;
  background:#2ECC71;color:#121225;
  border:none;border-radius:6px;cursor:pointer;
  font-size:.8rem;font-weight:600;
}
.ai-msg.ai .ai-apply-btn:active{background:#27ae60;}
.ai-msg.loading{color:#9090A8;font-style:italic;}
.ai-input-area{
  display:flex;gap:8px;padding:8px 14px;
  border-top:1px solid #2E2E52;
}
.ai-input-area .form-input{flex:1;min-height:40px;font-size:.9rem;}
.ai-quick-btns{
  display:flex;gap:6px;padding:4px 14px 10px;flex-wrap:wrap;
}
.ai-quick-btns .btn{font-size:.75rem;padding:4px 10px;min-height:32px;min-width:auto;color:#9090A8;}

/* ===== Logistics Warning ===== */
.logistics-warn{color:#E74C3C;font-weight:600;font-size:.82rem;}
.logistics-ok{color:#2ECC71;font-size:.82rem;}

/* ===== Calendar buttons ===== */
.cal-section{margin-top:10px;padding-top:10px;border-top:1px solid #2E2E52;}
.cal-btns{display:flex;gap:6px;flex-wrap:wrap;}
.cal-btn{
  display:flex;align-items:center;gap:4px;
  padding:6px 10px;background:#1A1A30;border:1px solid #2E2E52;
  border-radius:6px;color:#E0E0EC;cursor:pointer;font-size:.78rem;
  min-height:36px;transition:background .1s;
}
.cal-btn:active{background:#2A2A45;}
.cal-btn .cdot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}

/* ===== Contact sync ===== */
.contact-import-btn{
  width:100%;margin-top:8px;
  display:flex;align-items:center;justify-content:center;gap:6px;
}

/* ===== Date Strip (60Ïùº Ïä§ÌÅ¨Î°§) ===== */
.date-strip{
  display:flex;overflow-x:auto;gap:2px;padding:6px 6px;
  background:#1A1A30;border-bottom:1px solid #2E2E52;
  -webkit-overflow-scrolling:touch;scrollbar-width:none;
}
.date-strip::-webkit-scrollbar{display:none;}
.date-strip-item{
  flex:0 0 auto;min-width:36px;padding:3px 2px;border-radius:6px;
  text-align:center;cursor:pointer;border:2px solid #2E2E52;
  transition:background .1s;
}
.date-strip-item:active{background:#2A2A45;}
.date-strip-item .ds-dow{font-size:.48rem;color:#707088;line-height:1;}
.date-strip-item .ds-date{font-size:.75rem;font-weight:700;color:#E0E0EC;line-height:1.2;}
.date-strip-item .ds-date.sun{color:#E74C3C;}
.date-strip-item .ds-date.sat{color:#4ECDC4;}

/* ===== Date Picker Dropdown ===== */
.date-picker-overlay{
  display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.5);
}
.date-picker-overlay.open{display:block;}
.date-picker-list{
  position:absolute;top:44px;left:50%;transform:translateX(-50%);
  width:90%;max-width:360px;max-height:70vh;overflow-y:auto;
  background:#242444;border:1px solid #2E2E52;border-radius:10px;
  padding:6px;-webkit-overflow-scrolling:touch;
}
.dp-item{
  display:flex;align-items:center;justify-content:space-between;
  padding:8px 10px;border-radius:6px;cursor:pointer;
  border-bottom:1px solid #2E2E5220;
}
.dp-item:active{background:#2E2E52;}
.dp-item.today{background:#FFD70010;border:1px solid #FFD70044;}
.dp-item.selected{background:#2ECC7115;border:1px solid #2ECC7144;}
.dp-item .dp-date{font-size:.85rem;font-weight:700;color:#E0E0EC;min-width:70px;}
.dp-item .dp-dow{font-size:.7rem;color:#9090A8;min-width:24px;}
.dp-item .dp-summary{font-size:.6rem;color:#707088;flex:1;text-align:right;}
.dp-jump{
  display:flex;gap:4px;padding:6px;border-bottom:1px solid #2E2E52;margin-bottom:4px;
}
.dp-jump button{
  flex:1;padding:6px;border:1px solid #2E2E52;background:#1A1A30;
  color:#E0E0EC;border-radius:6px;font-size:.75rem;font-weight:600;cursor:pointer;
}
.dp-jump button:active{background:#2E2E52;}

/* ===== Responsive ===== */
@media(max-width:400px){
  .header h1{font-size:1rem;}
  .date-display{font-size:.9rem;min-width:90px;}
  .vt-time-hdr,.vt-time-col,.vt-summary-time{min-width:36px;max-width:36px;}
  .vt-emp-hdr .vt-name{font-size:.65rem;}
  .vt-emp-hdr{min-height:28px;padding:3px 1px;}
  .vt-shift .vt-role{font-size:.55rem;}
  .vt-shift .vt-time-label{font-size:.5rem;}
  .vt-hour-tick{font-size:.6rem;}
}
</style>
</head>
<body>

<!-- Header (2Ìñâ Íµ¨Ï°∞: ÎÇ†Ïßú ÎÑ§ÎπÑ + Í∏∞Îä• Î≤ÑÌäº) -->
<div style="position:sticky;top:0;z-index:100;background:#1A1A30;border-bottom:1px solid #2E2E52;">
  <div style="display:flex;align-items:center;justify-content:center;padding:4px 8px;gap:4px;">
    <button class="btn nav-btn" id="prevDay" aria-label="3Ïùº Ï†Ñ" style="font-size:.7rem;min-width:32px;min-height:32px;padding:4px;">‚óÄ‚óÄ</button>
    <button class="btn nav-btn" id="prevDay1" aria-label="Ïù¥Ï†Ñ ÎÇ†" style="font-size:.8rem;min-width:32px;min-height:32px;padding:4px;">‚óÄ</button>
    <span class="date-display" id="dateDisplay" style="cursor:pointer;min-width:90px;"></span>
    <button class="btn nav-btn" id="nextDay1" aria-label="Îã§Ïùå ÎÇ†" style="font-size:.8rem;min-width:32px;min-height:32px;padding:4px;">‚ñ∂</button>
    <button class="btn nav-btn" id="nextDay" aria-label="3Ïùº ÌõÑ" style="font-size:.7rem;min-width:32px;min-height:32px;padding:4px;">‚ñ∂‚ñ∂</button>
  </div>
  <div style="display:flex;align-items:center;justify-content:space-between;padding:0 8px 4px;gap:4px;">
    <div style="display:flex;gap:4px;">
      <button class="btn emp-mgr-btn" id="empMgrBtn">ÏßÅÏõê</button>
      <button class="btn emp-mgr-btn" id="dayoffMgrBtn" style="color:#E74C3C;border-color:#E74C3C55;">Ìú¥Î¨¥</button>
    </div>
    <div style="display:flex;gap:4px;">
      <button class="btn btn-sm" id="refreshBtn" aria-label="ÏÉàÎ°úÍ≥†Ïπ®" style="font-size:.75rem;padding:2px 6px;min-width:auto;min-height:26px;color:#707088;border-color:#2E2E52;">‚Üª</button>
    </div>
    <!-- Ïû¨Î∞∞Ïπò/ÏûëÏóÖÏ§ë Î≤ÑÌäº Ïà®ÍπÄ (Í∏∞Îä• Î∂àÎ™ÖÌôï, Î≥¥Ï†ï ÏãúÏä§ÌÖúÏúºÎ°ú ÎåÄÏ≤¥) -->
    <button class="btn btn-sm" id="resetFixedBtn" style="display:none;">Ïû¨Î∞∞Ïπò</button>
    <button class="btn btn-sm" id="confirmDayBtn" style="display:none;">ÏûëÏóÖÏ§ë</button>
  </div>
</div>

<!-- ÎãπÏùº Î∏åÎ¶¨Ìïë Ìå®ÎÑê -->
<div id="briefingPanel" style="background:#1e1e3a;border-bottom:1px solid #2E2E52;padding:6px 4px;font-size:.75rem;"></div>

<!-- Î†àÏù¥ÏïÑÏõÉ ÌÉ≠ -->
<div class="layout-tabs" id="layoutTabs">
  <button class="layout-tab active" data-tab="list">Î¶¨Ïä§Ìä∏</button>
  <button class="layout-tab" data-tab="vertical">ÏÑ∏Î°ú</button>
  <button class="layout-tab" data-tab="horizontal">Í∞ÄÎ°ú</button>
  <button class="layout-tab" data-tab="calendar">Îã¨Î†•</button>
</div>

<!-- Date Strip (60Ïùº Ïä§ÌÅ¨Î°§) -->
<div class="date-strip" id="dateStrip"></div>

<!-- ÌÉ≠ Ïª®ÌÖêÏ∏† -->
<div class="loading" id="loadingIndicator"><div class="spinner"></div>Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
<div id="tabContent" style="display:none;">
  <div class="tab-panel active" id="panelList">
    <div id="listContent"></div>
  </div>
  <div class="tab-panel" id="panelVertical">
    <div class="timeline-section" id="timelineSection">
      <div id="timelineContent"></div>
    </div>
  </div>
  <div class="tab-panel" id="panelCalendar">
    <div id="calendarContent"></div>
  </div>
  <div class="tab-panel" id="panelHorizontal">
    <div id="horizontalContent"></div>
  </div>
  </div>

<!-- Date Picker Overlay (30Ïùº Î¶¨Ïä§Ìä∏) -->
<div class="date-picker-overlay" id="datePickerOverlay">
  <div class="date-picker-list" id="datePickerList"></div>
</div>

<!-- Week Overview -->
<div class="week-section">
  <div class="week-header" id="weekToggle">
    <h3>Ï£ºÍ∞Ñ Í∞úÏöî</h3>
    <span class="arrow" id="weekArrow">‚ñº</span>
  </div>
  <div class="week-body" id="weekBody">
    <div class="week-grid" id="weekGrid"></div>
    <div class="week-offs" id="weekOffs"></div>
  </div>
</div>

<!-- Info Bar -->
<div class="info-section">
  <div class="info-header" id="infoToggle">
    <h3>Ï†ïÎ≥¥</h3>
    <span class="arrow" id="infoArrow">‚ñº</span>
  </div>
  <div class="info-body" id="infoBody">
    <div class="info-body-inner">
      <div class="info-row">
        <span class="info-icon">üå§</span>
        <span class="info-label">ÎÇ†Ïî®</span>
        <span class="info-value" id="weatherInfo"><span class="info-placeholder">Î°úÎî©Ï§ë...</span></span>
      </div>
      <div class="info-row">
        <span class="info-icon">‚öΩ</span>
        <span class="info-label">Í≤ΩÍ∏∞</span>
        <span class="info-value" id="sportsInfo"><span class="info-placeholder">Î°úÎî©Ï§ë...</span></span>
      </div>
    </div>
  </div>
</div>

<!-- AI Scheduling Section -->
<div class="ai-section">
  <div class="ai-header" id="aiToggle">
    <h3>AI Ïä§ÏºÄÏ§ÑÎßÅ</h3>
    <span class="arrow" id="aiArrow">‚ñº</span>
  </div>
  <div class="ai-body" id="aiBody">
    <div class="ai-chat-list" id="aiChatList">
      <div class="ai-msg ai" style="color:#9090A8;font-size:.8rem;">Ïä§ÏºÄÏ§Ñ ÏöîÏ≤≠ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî. Ïòà: "ÎÇ¥Ïùº Ïä§ÏºÄÏ§Ñ ÏßúÏ§ò", "Ïù¥Î≤àÏ£º Î∞∞ÏπòÌï¥Ï§ò"</div>
    </div>
    <div class="ai-input-area">
      <input class="form-input" id="aiInput" type="text" placeholder="Ïä§ÏºÄÏ§Ñ ÏöîÏ≤≠..." enterkeyhint="send">
      <button class="btn btn-accent btn-sm" id="aiSendBtn" style="min-width:52px;">Ï†ÑÏÜ°</button>
    </div>
    <div class="ai-quick-btns">
      <button class="btn btn-sm ai-quick" data-prompt="Ïò§Îäò Ïä§ÏºÄÏ§Ñ ÏßúÏ§ò">Ïò§Îäò</button>
      <button class="btn btn-sm ai-quick" data-prompt="ÎÇ¥Ïùº Ïä§ÏºÄÏ§Ñ ÏßúÏ§ò">ÎÇ¥Ïùº</button>
      <button class="btn btn-sm ai-quick" data-prompt="Ïù¥Î≤àÏ£º Ïä§ÏºÄÏ§Ñ ÏßúÏ§ò">Ïù¥Î≤àÏ£º</button>
      <button class="btn btn-sm ai-quick" data-prompt="ÎÇ¥Ïùº Ïù∏Ïõê Î∂ÄÏ°±Ìïú ÏãúÍ∞ÑÎåÄ ÏïåÎ†§Ï§ò">Î∂ÄÏ°±Ï≤¥ÌÅ¨</button>
    </div>
  </div>
</div>

<!-- Share Section -->
<div class="share-section">
  <div class="share-header" id="shareToggle">
    <h3>Í≥µÏú†</h3>
    <span class="arrow" id="shareArrow">‚ñº</span>
  </div>
  <div class="share-body" id="shareBody">
    <div class="share-btns">
      <button class="btn btn-accent" id="shareImageBtn">Ïù¥ÎØ∏ÏßÄ Í≥µÏú†</button>
      <button class="btn" id="shareTextBtn">ÌÖçÏä§Ìä∏ Í≥µÏú†</button>
      <button class="btn" id="copyUrlBtn">URL Î≥µÏÇ¨</button>
    </div>
    <div class="cal-section">
      <div style="font-size:.8rem;color:#9090A8;margin-bottom:6px;">Ï∫òÎ¶∞Îçî (.ics) ‚Äî ÏïÑÏù¥Ìè∞/Í∞§Îü≠Ïãú Ìò∏Ìôò</div>
      <div class="cal-btns" id="calBtns"></div>
      <button class="btn btn-sm" id="calAllBtn" style="margin-top:6px;width:100%;font-size:.8rem;">Ï†ÑÏ≤¥ Ï∫òÎ¶∞Îçî Îã§Ïö¥Î°úÎìú</button>
    </div>
  </div>
</div>

<!-- Shift Edit Modal (ÌÖçÏä§Ìä∏+Í≤åÏù¥ÏßÄ ÎìÄÏñº ÏàòÏ†ï) -->
<div class="modal-overlay" id="shiftModal">
  <div class="modal-content" style="max-width:420px;">
    <button class="modal-close" id="shiftModalClose">&times;</button>
    <div class="modal-title" id="shiftTitle">Í∑ºÎ¨¥ ÏàòÏ†ï</div>
    <div class="form-group">
      <label>ÏßÅÏõê</label>
      <div class="emp-chips" id="shiftEmpChips"></div>
    </div>
    <div class="form-group">
      <label>Ïó≠Ìï† <span id="shiftRoleNote" style="color:#707088;font-size:.65rem;"></span></label>
      <div class="role-pills" id="shiftRolePills">
        <div class="role-pill" data-role="Ï£ºÎ∞©" style="--pill-color:#E67E22;">Ï£ºÎ∞©</div>
        <div class="role-pill" data-role="Ï∞®Î∞∞Îã¨" style="--pill-color:#4ECDC4;">Ï∞®Î∞∞Îã¨</div>
        <div class="role-pill" data-role="Ïò§ÌÜ†Î∞îÏù¥" style="--pill-color:#FFD700;">Ïò§ÌÜ†Î∞îÏù¥</div>
      </div>
    </div>
    <!-- Í≤åÏù¥ÏßÄÌòï ÏãúÍ∞Ñ ÏÑ†ÌÉù -->
    <div class="form-group">
      <label>ÏãúÍ∞Ñ (Í≤åÏù¥ÏßÄ ÎìúÎûòÍ∑∏)</label>
      <div class="shift-gauge-wrap">
        <div class="shift-gauge" id="shiftGauge">
          <div class="shift-gauge-fill" id="shiftGaugeFill"></div>
          <div class="shift-gauge-labels" id="shiftGaugeLabels"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:.6rem;color:#707088;margin-top:2px;">
          <span>06</span><span>10</span><span>14</span><span>18</span><span>22</span><span>02</span>
        </div>
      </div>
    </div>
    <!-- ÌÖçÏä§Ìä∏ ÏãúÍ∞Ñ ÏÑ†ÌÉù -->
    <div class="form-group" style="display:flex;gap:8px;align-items:center;">
      <div style="flex:1;">
        <label style="font-size:.7rem;">ÏãúÏûë</label>
        <select class="form-input" id="shiftStartSel" style="font-size:.9rem;"></select>
      </div>
      <span style="color:#707088;margin-top:14px;">~</span>
      <div style="flex:1;">
        <label style="font-size:.7rem;">Ï¢ÖÎ£å</label>
        <select class="form-input" id="shiftEndSel" style="font-size:.9rem;"></select>
      </div>
    </div>
    <div class="form-group">
      <label>Îπ†Î•∏ÏÑ†ÌÉù</label>
      <div class="presets" id="shiftPresets">
        <button class="preset-btn" data-start="10:00" data-end="18:00">10-18</button>
        <button class="preset-btn" data-start="10:00" data-end="20:00">10-20</button>
        <button class="preset-btn" data-start="17:00" data-end="03:00">17-03</button>
        <button class="preset-btn" data-start="18:00" data-end="03:00">18-03</button>
        <button class="preset-btn" data-start="16:00" data-end="00:00">16-24</button>
        <button class="preset-btn" data-start="10:00" data-end="03:00">ÌíÄ</button>
      </div>
    </div>
    <div class="modal-footer" style="flex-wrap:wrap;">
      <button class="btn btn-danger btn-sm" id="shiftDayoff" style="font-size:.7rem;">Ìú¥Î¨¥ÏßÄÏ†ï</button>
      <button class="btn btn-danger" id="shiftDelete" style="display:none;">ÏÇ≠Ï†ú</button>
      <button class="btn btn-gold btn-sm" id="shiftSaveFixed" style="font-size:.7rem;">Í≥†Ï†ï</button>
      <button class="btn" id="shiftCancel">Ï∑®ÏÜå</button>
      <button class="btn btn-accent" id="shiftSave">Ï†ÄÏû•</button>
    </div>
  </div>
</div>

<!-- Month View Modal -->
<div class="modal-overlay" id="monthModal">
  <div class="modal-content">
    <button class="modal-close" id="monthModalClose">&times;</button>
    <div class="modal-title" id="monthModalTitle">ÏõîÍ∞Ñ Î≥¥Í∏∞</div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
      <button class="btn btn-sm nav-btn" id="monthPrev">‚óÄ</button>
      <span id="monthModalLabel" style="font-size:1rem;font-weight:600;color:#FFD700;"></span>
      <button class="btn btn-sm nav-btn" id="monthNext">‚ñ∂</button>
    </div>
    <div class="month-grid" id="monthGrid"></div>
  </div>
</div>

<!-- Employee Management Modal -->
<div class="modal-overlay" id="empModal">
  <div class="modal-content">
    <button class="modal-close" id="empModalClose">&times;</button>
    <div class="modal-title">ÏßÅÏõêÍ¥ÄÎ¶¨</div>
    <div id="empList"></div>
    <button class="btn btn-accent" id="addEmpBtn" style="width:100%;margin-top:8px;">+ ÏßÅÏõê Ï∂îÍ∞Ä</button>
    <button class="btn contact-import-btn" id="contactImportBtn">Ïó∞ÎùΩÏ≤òÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞</button>
  </div>
</div>

<!-- Employee Edit Modal -->
<div class="modal-overlay" id="empEditModal">
  <div class="modal-content">
    <button class="modal-close" id="empEditClose">&times;</button>
    <div class="modal-title" id="empEditTitle">ÏßÅÏõê Ï∂îÍ∞Ä</div>
    <div class="form-group">
      <label>Ïù¥Î¶Ñ</label>
      <input class="form-input" id="empName" type="text" placeholder="ÌôçÍ∏∏Îèô">
    </div>
    <div class="form-group">
      <label>Ï†ÑÌôîÎ≤àÌò∏</label>
      <input class="form-input" id="empPhone" type="tel" placeholder="010-0000-0000">
    </div>
    <div class="form-group">
      <label>ÏÉâÏÉÅ</label>
      <div class="color-picker" id="colorPicker"></div>
    </div>
    <div class="form-group">
      <label>Ïó≠Ìï†</label>
      <select class="form-input" id="empRole">
        <option value="">ÎØ∏ÏßÄÏ†ï</option>
        <option value="Ï£ºÎ∞©">Ï£ºÎ∞©</option>
        <option value="Ï∞®Î∞∞Îã¨">Ï∞®Î∞∞Îã¨</option>
        <option value="Ïò§ÌÜ†Î∞îÏù¥">Ïò§ÌÜ†Î∞îÏù¥</option>
      </select>
    </div>
    <div class="form-group">
      <label>ÏãúÍ∏â</label>
      <input class="form-input" id="empHourlyRate" type="number" placeholder="0" min="0">
    </div>
    <div class="form-group">
      <label>Ï£ºÍ∞Ñ ÏµúÎåÄ ÏãúÍ∞Ñ</label>
      <input class="form-input" id="empMaxHours" type="number" placeholder="40" min="0" max="168">
    </div>
    <div class="modal-footer">
      <button class="btn" id="empEditCancel">Ï∑®ÏÜå</button>
      <button class="btn btn-accent" id="empEditSave">Ï†ÄÏû•</button>
    </div>
  </div>
</div>

<!-- Day-off Management Modal -->
<div class="modal-overlay" id="dayoffModal">
  <div class="modal-content">
    <button class="modal-close" id="dayoffModalClose">&times;</button>
    <div class="modal-title">Ìú¥Î¨¥ Í¥ÄÎ¶¨</div>
    <div style="margin-bottom:10px;">
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;">
        <select class="form-input" id="dayoffEmpSelect" style="flex:1;"></select>
        <input class="form-input" id="dayoffDate" type="date" style="flex:1;">
        <button class="btn btn-accent btn-sm" id="dayoffAddBtn">Ï∂îÍ∞Ä</button>
      </div>
      <div style="margin-bottom:8px;">
        <textarea class="form-input" id="dayoffBulkInput" placeholder="Ïó¨Îü¨ ÌòïÌÉúÎ°ú ÏûÖÎ†• Í∞ÄÎä•:&#10;Ïù¥ÏõêÍ∑ú 2/25, 2/26&#10;Í∂åÏó∞Ïò• 3/1~3/3&#10;Î¶¨ 2025-03-05&#10;ÌûàÏò§ Ìôî,Î™© (Ïù¥Î≤àÏ£º)" rows="4" style="font-size:.8rem;"></textarea>
        <button class="btn btn-sm" id="dayoffBulkBtn" style="width:100%;margin-top:4px;color:#FFD700;border-color:#FFD700;">ÏùºÍ¥Ñ Îì±Î°ù</button>
      </div>
    </div>
    <div style="font-size:.85rem;color:#FFD700;font-weight:600;margin-bottom:6px;" id="dayoffListTitle">Îì±Î°ùÎêú Ìú¥Î¨¥</div>
    <div id="dayoffList" style="max-height:300px;overflow-y:auto;"></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
(function(){
'use strict';

// ============================================================
// Firebase Config
// ============================================================
const FB_BASE = 'https://poskds-4ba60-default-rtdb.asia-southeast1.firebasedatabase.app';
const FB_WS = FB_BASE + '/workschedule';
const FB_EMPLOYEES = FB_WS + '/employees';
const FB_SCHEDULES = FB_WS + '/schedules';
const FB_SETTINGS = FB_WS + '/settings';

// ============================================================
// Timeline hours: 06~03(+1) = 22 columns
// ============================================================
const TL_HOURS = [6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,0,1,2,3];
const TL_START_HOUR = 6; // 06:00
const TL_TOTAL_HOURS = 22; // 06:00 ~ 03:00(+1) = 21h span, but 22 columns (inclusive)

// ============================================================
// Default employees
// ============================================================
const DEFAULT_EMPLOYEES = {
  emp1: {name:'Ïù¥ÏõêÍ∑ú', phone:'', role:'', hourlyRate:9860, maxHours:40},
  emp2: {name:'Í∂åÏó∞Ïò•', phone:'', role:'', hourlyRate:9860, maxHours:40},
  emp3: {name:'Î¶¨', phone:'', role:'', hourlyRate:9860, maxHours:40},
  emp4: {name:'ÌûàÏò§', phone:'', role:'', hourlyRate:9860, maxHours:40},
  emp5: {name:'Î∞ïÏ§ÄÎ™®', phone:'', role:'', hourlyRate:9860, maxHours:40},
  emp6: {name:'Ï†ÑÎ¨òÏ†ï', phone:'', role:'', hourlyRate:9860, maxHours:40},
  emp7: {name:'ÎåÄÏú†', phone:'', role:'', hourlyRate:9860, maxHours:40}
};

// ============================================================
// Í∑ºÎ¨¥ÌòïÌÉú(Shift Type) ÏÉâÏÉÅ ÏãúÏä§ÌÖú ‚Äî Material Design 200 tone
// ============================================================
const SHIFT_TYPES = {
  'Ïò§Ï†Ñ':   {color:'#81D4FA', bg:'rgba(129,212,250,0.15)', label:'Ïò§Ï†Ñ', order:0},
  'ÌîºÌÅ¨':   {color:'#FFD180', bg:'rgba(255,209,128,0.15)', label:'ÌîºÌÅ¨', order:1},
  'ÎßàÍ∞ê':   {color:'#FFAB91', bg:'rgba(255,171,145,0.15)', label:'ÎßàÍ∞ê', order:2},
  'ÌíÄÌÉÄÏûÑ': {color:'#80CBC4', bg:'rgba(128,203,196,0.15)', label:'ÌíÄÌÉÄÏûÑ', order:3},
  'ÏïºÍ∞Ñ':   {color:'#B39DDB', bg:'rgba(179,157,219,0.15)', label:'ÏïºÍ∞Ñ', order:4},
  'Ìú¥Î¨¥':   {color:'#E74C3C', bg:'rgba(231,76,60,0.10)', label:'Ìú¥Î¨¥', order:5},
  'ÎØ∏ÏûÖÎ†•': {color:'#707088', bg:'transparent', label:'ÎØ∏ÏûÖÎ†•', order:6},
};

function getShiftType(startStr, endStr){
  if(!startStr || !endStr) return SHIFT_TYPES['ÎØ∏ÏûÖÎ†•'];
  const sh = parseInt(startStr.split(':')[0]);
  const eh = parseInt(endStr.split(':')[0]);
  const hours = calcHours(startStr, endStr);
  if(hours >= 12) return SHIFT_TYPES['ÌíÄÌÉÄÏûÑ'];
  if(sh >= 5 && sh < 12) return SHIFT_TYPES['Ïò§Ï†Ñ'];
  if(sh >= 12 && sh < 18) return SHIFT_TYPES['ÌîºÌÅ¨'];
  if(sh >= 18 || sh < 5) return SHIFT_TYPES['ÎßàÍ∞ê'];
  return SHIFT_TYPES['Ïò§Ï†Ñ'];
}

// ÏßßÏùÄ Ïù¥Î¶Ñ (Ìïú Í∏ÄÏûê, Ï§ëÎ≥µ ÏóÜÍ≤å)
const SHORT_NAMES = {};
function buildShortNames(){
  const names = Object.values(employees).map(e => e.name);
  const used = new Set();
  names.forEach(name => {
    // ÏÑ±(Ï≤´ Í∏ÄÏûê) ÏãúÎèÑ
    let short = name.charAt(0);
    if(!used.has(short)){ used.add(short); SHORT_NAMES[name] = short; return; }
    // ÎëòÏß∏ Í∏ÄÏûê ÏãúÎèÑ
    if(name.length > 1){ short = name.charAt(1); if(!used.has(short)){ used.add(short); SHORT_NAMES[name] = short; return; } }
    // Îëê Í∏ÄÏûê
    short = name.substring(0,2);
    used.add(short); SHORT_NAMES[name] = short;
  });
}
function shortName(empName){ return SHORT_NAMES[empName] || empName?.charAt(0) || '?'; }

// ============================================================
// Í≥†Ï†ï Ïä§ÏºÄÏ§Ñ (ÏûêÎèô ÏûÖÎ†•)
// ============================================================
// ÏßÅÏõêÏù¥Î¶Ñ ‚Üí {start, end, role, type}
// type: 'fixed'=Îß§Ïùº Í≥†Ï†ï, 'variable'=Î≥ÄÏπô(ÏàòÎèô)
// Í≥†Ï†ï Ïä§ÏºÄÏ§Ñ Í∏∞Î≥∏Í∞í (ÏàòÏ†ï ÌåùÏóÖ "Í≥†Ï†ïÏúºÎ°ú Ï†ÄÏû•"ÏúºÎ°ú Î≥ÄÍ≤Ω Í∞ÄÎä•)
let FIXED_SCHEDULES = {
  'Ïù¥ÏõêÍ∑ú': {start:'06:00', end:'20:00', role:'Ï£ºÎ∞©,Ïò§ÌÜ†Î∞îÏù¥', type:'fixed'},
  'ÌûàÏò§':   {start:'18:00', end:'03:00', role:'Ï£ºÎ∞©', type:'fixed'},
  'Î¶¨':     {start:'18:00', end:'03:00', role:'Ï£ºÎ∞©', type:'fixed'},
  'Î∞ïÏ§ÄÎ™®': {start:'17:00', end:'03:00', role:'Ï£ºÎ∞©,Ï∞®Î∞∞Îã¨', type:'fixed'},
  'Ï†ÑÎ¨òÏ†ï': {start:'17:00', end:'03:00', role:'Ï£ºÎ∞©', type:'fixed'},
  'ÎåÄÏú†':   {start:null, end:null, role:'', type:'variable'}, // Î≥ÄÏπô ‚Äî ÏàòÎèô ÏûÖÎ†•
};
// localStorage/Firebase Ï†ÄÏû•Îêú Í≥†Ï†ïÍ∞í ÎçÆÏñ¥Ïì∞Í∏∞
try{
  const saved=JSON.parse(localStorage.getItem('ws_fixed_schedules'));
  if(saved) Object.assign(FIXED_SCHEDULES, saved);
}catch(e){}
// FirebaseÏóêÏÑúÎèÑ Î°úÎìú (ÎπÑÎèôÍ∏∞)
(async()=>{try{
  const fb=await fbGet('/workschedule/fixed_schedules');
  if(fb){Object.assign(FIXED_SCHEDULES,fb);localStorage.setItem('ws_fixed_schedules',JSON.stringify(FIXED_SCHEDULES));}
}catch(e){}})();

// ÏßÅÏõêÎ≥Ñ Í∞ÄÎä• Ïó≠Ìï† (Îä•Î†•)
const EMP_CAPABILITIES = {
  'Ïù¥ÏõêÍ∑ú': ['Ï£ºÎ∞©','Ï∞®Î∞∞Îã¨','Ïò§ÌÜ†Î∞îÏù¥'],
  'Î∞ïÏ§ÄÎ™®': ['Ï£ºÎ∞©','Ï∞®Î∞∞Îã¨'],
  'ÎåÄÏú†':   ['Ï£ºÎ∞©','Ï∞®Î∞∞Îã¨'],
  'Ï†ÑÎ¨òÏ†ï': ['Ï£ºÎ∞©'],
  'Î¶¨':     ['Ï£ºÎ∞©'],
  'ÌûàÏò§':   ['Ï£ºÎ∞©'],
  'Í∂åÏó∞Ïò•': ['Ï£ºÎ∞©'],
};

// Ïó≠Ìï† ÌëúÏãú (ÏÉâÏÉÅ ÌÖçÏä§Ìä∏, Ïù¥Î™®ÏßÄ ÏßÄÏñë)
const ROLE_LABELS = {'Ï£ºÎ∞©':'Ï£ºÎ∞©','Ï∞®Î∞∞Îã¨':'Ï∞®','Ïò§ÌÜ†Î∞îÏù¥':'Î∞îÏù¥ÌÅ¨'};
const ROLE_COLORS = {'Ï£ºÎ∞©':'#E67E22','Ï∞®Î∞∞Îã¨':'#4ECDC4','Ïò§ÌÜ†Î∞îÏù¥':'#FFD700'};

// ========== Ïù∏Ïõê Í∏∞Ï§Ä ÏÑ§Ï†ï (ÏòàÏÉÅÎß§Ï∂ú Í∏∞Î∞ò) ==========
// ========== ÏãúÍ∞ÑÎ≥Ñ Ïù∏Ïõê Í∏∞Ï§Ä (per-hour) ==========
const GAUGE_HOURS = [6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,0,1,2];
// 4 Îß§Ï∂úÍµ¨Í∞Ñ ÌîÑÎ¶¨ÏÖã ‚Äî Í∞Å ÏãúÍ∞ÑÎ≥Ñ {Ï£ºÎ∞©:{min,max}, Ïò§ÌÜ†Î∞îÏù¥:{min,max}, Ï∞®:{min,max}}
function makeHourlyPreset(label, rules){
  // rules: [{hours:[...], kitchen:{min,max}, bike:{min,max}, car:{min,max}}]
  const hourly = {};
  GAUGE_HOURS.forEach(h => { hourly[h] = {kitchen:{min:0,max:0},bike:{min:0,max:0},car:{min:0,max:0}}; });
  rules.forEach(r => { r.hours.forEach(h => { if(hourly[h]!==undefined){ hourly[h] = {kitchen:r.kitchen, bike:r.bike, car:r.car}; }}); });
  return {label, hourly, daStart:10, daEnd:1};
}
const STAFF_PRESETS = {
  'ÌïúÍ∞Ä': makeHourlyPreset('ÌïúÍ∞Ä(~80Îßå)', [
    {hours:[6,7,8,9,10,11,12,13,14,15,16], kitchen:{min:1,max:1}, bike:{min:0,max:1}, car:{min:0,max:0}},
    {hours:[17,18,19], kitchen:{min:1,max:2}, bike:{min:0,max:1}, car:{min:0,max:1}},
    {hours:[20,21], kitchen:{min:1,max:2}, bike:{min:0,max:1}, car:{min:0,max:1}},
    {hours:[22,23,0], kitchen:{min:1,max:2}, bike:{min:0,max:1}, car:{min:0,max:1}},
    {hours:[1,2], kitchen:{min:1,max:1}, bike:{min:1,max:1}, car:{min:0,max:1}},
  ]),
  'Î≥¥ÌÜµ': makeHourlyPreset('Î≥¥ÌÜµ(80~150Îßå)', [
    {hours:[6,7,8,9,10,11,12,13,14,15,16], kitchen:{min:1,max:1}, bike:{min:0,max:1}, car:{min:0,max:1}},
    {hours:[17,18,19], kitchen:{min:2,max:3}, bike:{min:0,max:1}, car:{min:0,max:1}},
    {hours:[20,21], kitchen:{min:2,max:3}, bike:{min:0,max:1}, car:{min:0,max:1}},
    {hours:[22,23,0], kitchen:{min:1,max:2}, bike:{min:0,max:1}, car:{min:0,max:1}},
    {hours:[1,2], kitchen:{min:1,max:2}, bike:{min:1,max:1}, car:{min:0,max:1}},
  ]),
  'Î∞îÏÅ®': makeHourlyPreset('Î∞îÏÅ®(150~250Îßå)', [
    {hours:[6,7,8,9,10,11,12,13,14,15,16], kitchen:{min:1,max:2}, bike:{min:0,max:1}, car:{min:0,max:1}},
    {hours:[17,18,19], kitchen:{min:2,max:4}, bike:{min:0,max:1}, car:{min:0,max:1}},
    {hours:[20,21], kitchen:{min:2,max:3}, bike:{min:0,max:1}, car:{min:0,max:1}},
    {hours:[22,23,0], kitchen:{min:1,max:3}, bike:{min:0,max:1}, car:{min:0,max:1}},
    {hours:[1,2], kitchen:{min:1,max:2}, bike:{min:1,max:1}, car:{min:0,max:1}},
  ]),
  'Îß§Ïö∞Î∞îÏÅ®': makeHourlyPreset('Îß§Ïö∞Î∞îÏÅ®(250Îßå~)', [
    {hours:[6,7,8,9,10,11,12,13,14,15,16], kitchen:{min:1,max:2}, bike:{min:0,max:1}, car:{min:0,max:1}},
    {hours:[17,18,19], kitchen:{min:3,max:5}, bike:{min:0,max:1}, car:{min:0,max:1}},
    {hours:[20,21], kitchen:{min:2,max:4}, bike:{min:0,max:1}, car:{min:0,max:1}},
    {hours:[22,23,0], kitchen:{min:2,max:3}, bike:{min:0,max:1}, car:{min:0,max:1}},
    {hours:[1,2], kitchen:{min:1,max:2}, bike:{min:1,max:1}, car:{min:0,max:1}},
  ]),
};
let staffSettings = JSON.parse(localStorage.getItem('ws_staff_settings') || 'null') || {
  preset: 'Î≥¥ÌÜµ',
  hourlyOverrides: null, // {hour: {kitchen:{min,max},bike:{min,max},car:{min,max}}}
  dailyRevenue: null // ÎãπÏùº Îß§Ï∂ú ÏòàÏÉÅ Íµ¨Í∞Ñ ÌÇ§ (nullÏù¥Î©¥ preset ÏÇ¨Ïö©)
};
// Í∏∞Ï°¥ ÌòïÌÉú ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò (custom ÌïÑÎìú ÏûàÏúºÎ©¥ Î¶¨ÏÖã)
if(staffSettings.custom){ staffSettings = {preset:'Î≥¥ÌÜµ', hourlyOverrides:null, dailyRevenue:null}; }
function saveStaffSettings(){ localStorage.setItem('ws_staff_settings', JSON.stringify(staffSettings)); fbPut('/workschedule/staff_settings', staffSettings); }

// ÎÇ†ÏßúÎ≥Ñ Îß§Ï∂úÍµ¨Í∞Ñ Îßµ
let dailyRevenueMap = JSON.parse(localStorage.getItem('ws_daily_revenue') || '{}');
function getActivePresetKey(){
  const dk = dateKey(currentDate);
  return dailyRevenueMap[dk] || staffSettings.preset || 'Î≥¥ÌÜµ';
}
function getActivePreset(){ return STAFF_PRESETS[getActivePresetKey()] || STAFF_PRESETS['Î≥¥ÌÜµ']; }

// ÏãúÍ∞ÑÎåÄÎ≥Ñ Ïó≠Ìï† Ï†úÌïú (per-hour)
function getRoleLimits(hour){
  // ÏãúÍ∞ÑÎ≥Ñ Ïò§Î≤ÑÎùºÏù¥Îìú Ïö∞ÏÑ†
  if(staffSettings.hourlyOverrides && staffSettings.hourlyOverrides[hour]){
    return {
      'Ï£ºÎ∞©': staffSettings.hourlyOverrides[hour].kitchen,
      'Ïò§ÌÜ†Î∞îÏù¥': staffSettings.hourlyOverrides[hour].bike,
      'Ï∞®Î∞∞Îã¨': staffSettings.hourlyOverrides[hour].car,
    };
  }
  const preset = getActivePreset();
  const h = preset.hourly[hour] || {kitchen:{min:0,max:0},bike:{min:0,max:0},car:{min:0,max:0}};
  return {
    'Ï£ºÎ∞©': h.kitchen,
    'Ïò§ÌÜ†Î∞îÏù¥': h.bike,
    'Ï∞®Î∞∞Îã¨': h.car,
  };
}

// Ï∂©Îèå Í∞êÏßÄ: ÏãúÍ∞ÑÎåÄÎ≥Ñ Ïó≠Ìï† Ïù∏Ïõê Ï¥àÍ≥º/Î∂ÄÏ°± Ï≤¥ÌÅ¨
function detectConflicts(empKeys, dk){
  const conflicts = {}; // empId ‚Üí [{hour, role, type, msg}]
  const checkHours = [10,11,12,13,14,15,16,17,18,19,20,21,22,23,0,1,2];

  for(const h of checkHours){
    const hStr = pad(h)+':00';
    const hMin = timeToMinutesFrom6(hStr);
    const roleEmps = {'Ï£ºÎ∞©':[],'Ï∞®Î∞∞Îã¨':[],'Ïò§ÌÜ†Î∞îÏù¥':[]};

    empKeys.forEach(empId => {
      if(isDayOff(empId, dk)) return;
      const shift = daySchedule[empId];
      if(!shift || !shift.start || !shift.end) return;
      const sMin = timeToMinutesFrom6(shift.start);
      let eMin = timeToMinutesFrom6(shift.end);
      if(eMin <= sMin) eMin += 24*60;
      if(hMin >= sMin && hMin < eMin){
        const roles = shift.role ? shift.role.split(',').filter(Boolean) : [];
        if(roles.length === 0) roleEmps['Ï£ºÎ∞©'].push(empId);
        roles.forEach(r => { if(roleEmps[r]) roleEmps[r].push(empId); });
      }
    });

    const limits = getRoleLimits(h);

    for(const role in limits){
      const emps = roleEmps[role] || [];
      const lim = limits[role];
      // max Ï¥àÍ≥º ‚Üí Îí§Ï™Ω ÏßÅÏõê Ï∂©Îèå
      if(emps.length > lim.max){
        for(let i = lim.max; i < emps.length; i++){
          if(!conflicts[emps[i]]) conflicts[emps[i]] = [];
          conflicts[emps[i]].push({hour:h, role, type:'over', msg:h+'Ïãú '+role+' Ï¥àÍ≥º('+emps.length+'/'+lim.max+')'});
        }
      }
      // min Î∂ÄÏ°± Ï≤¥ÌÅ¨ (Ï†ÑÏ≤¥ Ìï¥Îãπ Ïó≠Ìï† Ïù∏Ïõê Î∂ÄÏ°± Ïãú)
      if(lim.min > 0 && emps.length < lim.min){
        // Î∂ÄÏ°±ÏùÄ empIdÍ∞Ä ÏïÑÎãå ÏãúÍ∞ÑÎåÄ Ï†ÑÏ≤¥ Í≤ΩÍ≥† ‚Üí hourConflictsÏóê Ï†ÄÏû•
        if(!conflicts['_hour_'+h]) conflicts['_hour_'+h] = [];
        conflicts['_hour_'+h].push({hour:h, role, type:'under', msg:h+'Ïãú '+role+' Î∂ÄÏ°±('+emps.length+'/'+lim.min+')'});
      }
    }
  }
  return conflicts;
}

function getFixedSchedule(empName){
  return FIXED_SCHEDULES[empName] || null;
}

function findEmpIdByName(name){
  for(const id in employees){
    if(employees[id].name === name) return id;
  }
  return null;
}

// ============================================================
// State
// ============================================================
let currentTab = 'list'; // 'list' | 'vertical' | 'calendar' | 'horizontal'
let currentDate = new Date();
let employees = {};
let daySchedule = {}; // schedule for currentDate
let weekSchedules = {}; // schedules for the week (dateStr -> data)
let monthScheduleSummary = {}; // monthKey -> {dateStr: count}
let sseEmployees = null;
let sseSchedule = null;
let sseGeneration = 0;
let monthViewYear, monthViewMonth;
let dataLoaded = false;
let confirmedDays = {}; // { 'yyyy-MM-dd': true } ‚Äî ÌôïÏ†ïÎêú ÎÇ†Ïßú
let shiftStatus = {}; // { 'yyyy-MM-dd_empId': 'auto'|'confirmed'|'pending' } ‚Äî Î≥¥Ï†ï ÏÉÅÌÉú

// ÏÉâÏÉÅ ÏÉÅÏàò (Ï†ÑÏó≠)
const C_OK = '#2ECC71';   // ÌôïÏ†ï
const C_DEF = '#9090A8';  // Î≥¥Ï†ï(Í∏∞Î≥∏)
const C_OFF = '#E74C3C';  // Ìú¥Î¨¥/Ï∂©Îèå
const C_BG = '#1A1A30';

const LS_CONFIRMED = 'ws_confirmed';
const LS_SHIFT_STATUS = 'ws_shift_status';
const LS_PATTERNS = 'ws_patterns'; // AI ÌïôÏäµÏö© ÌôïÏ†ï Ìå®ÌÑ¥
function lsLoadConfirmed(){ try{ return JSON.parse(localStorage.getItem(LS_CONFIRMED)) || {}; }catch(e){ return {}; } }
function lsSaveConfirmed(data){ localStorage.setItem(LS_CONFIRMED, JSON.stringify(data)); }
function isConfirmed(dk){ return !!confirmedDays[dk]; }
function lsLoadShiftStatus(){ try{ return JSON.parse(localStorage.getItem(LS_SHIFT_STATUS)) || {}; }catch(e){ return {}; } }
function lsSaveShiftStatus(){ localStorage.setItem(LS_SHIFT_STATUS, JSON.stringify(shiftStatus)); }
function getShiftStatus(dk, empId){ return shiftStatus[dk+'_'+empId] || 'auto'; }
function setShiftStatus(dk, empId, st){
  const key = dk+'_'+empId;
  if(st==='auto') delete shiftStatus[key]; else shiftStatus[key]=st;
  lsSaveShiftStatus();
  // ÌôïÏ†ï Ïãú Ìå®ÌÑ¥ Í∏∞Î°ù (AI ÌïôÏäµ)
  if(st==='confirmed'){
    const shift = daySchedule[empId];
    if(shift && shift.start) recordPattern(empId, dk, shift);
  }
  renderAll();
}
function recordPattern(empId, dk, shift){
  try{
    const patterns = JSON.parse(localStorage.getItem(LS_PATTERNS)||'{}');
    const d = new Date(dk+'T00:00:00+09:00');
    const dow = d.getDay();
    const empName = employees[empId]?.name||empId;
    const key = empName+'_'+dow;
    if(!patterns[key]) patterns[key]={count:0,times:{}};
    const timeKey = shift.start+'~'+shift.end;
    patterns[key].count = (patterns[key].count||0)+1;
    patterns[key].times[timeKey] = (patterns[key].times[timeKey]||0)+1;
    patterns[key].lastRole = shift.role||'';
    patterns[key].lastDate = dk;
    localStorage.setItem(LS_PATTERNS, JSON.stringify(patterns));
    // Firebase Î∞±ÏóÖ
    fbPut('/workschedule/patterns/'+encodeURIComponent(key), patterns[key]);
  }catch(e){}
}
function getPatternSuggestion(empId, dk){
  try{
    const patterns = JSON.parse(localStorage.getItem(LS_PATTERNS)||'{}');
    const d = new Date(dk+'T00:00:00+09:00');
    const dow = d.getDay();
    const empName = employees[empId]?.name||empId;
    const key = empName+'_'+dow;
    const p = patterns[key];
    if(!p || p.count < 2) return null;
    // Í∞ÄÏû• ÎπàÎ≤àÌïú ÏãúÍ∞ÑÎåÄ Ï∂îÏ≤ú
    let bestTime=null, bestCount=0;
    for(const t in p.times){ if(p.times[t]>bestCount){bestCount=p.times[t];bestTime=t;} }
    if(!bestTime) return null;
    const [start,end] = bestTime.split('~');
    return {start, end, role:p.lastRole||'', confidence:Math.min(100,Math.round(bestCount/p.count*100)), count:p.count};
  }catch(e){ return null; }
}

// ============================================================
// DOM refs
// ============================================================
const $ = id => document.getElementById(id);
const $dateDisplay = $('dateDisplay');
const $loading = $('loadingIndicator');
const $tabContent = $('tabContent');
const $timelineContent = $('timelineContent');
const $weekGrid = $('weekGrid');
const $weekOffs = $('weekOffs');
const $shiftModal = $('shiftModal');
const $monthModal = $('monthModal');
const $empModal = $('empModal');
const $empEditModal = $('empEditModal');
const $toast = $('toast');

// ============================================================
// Utility
// ============================================================
function pad(n){ return n < 10 ? '0'+n : ''+n; }
function dateStr(d){ return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate()); }
function dateKey(d){ return dateStr(d); }
function daysInMonth(y,m){ return new Date(y,m,0).getDate(); }
const DOW_KR = ['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'];
const DOW_KR_SHORT = ['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'];

function showToast(msg){
  $toast.textContent = msg;
  $toast.classList.add('show');
  setTimeout(()=> $toast.classList.remove('show'), 2000);
}
function openModal(el){ el.classList.add('active'); }
function closeModal(el){ el.classList.remove('active'); }

function isSameDay(a,b){
  return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
}

function getMonday(d){
  const dt = new Date(d);
  const day = dt.getDay();
  const diff = day === 0 ? -6 : 1 - day;
  dt.setDate(dt.getDate() + diff);
  dt.setHours(0,0,0,0);
  return dt;
}

// Convert time string "HH:MM" to minutes from 06:00
// Hours 00-05 are treated as next day (24-29)
function timeToMinutesFrom6(timeStr){
  const [h,m] = timeStr.split(':').map(Number);
  let hour = h;
  if(hour < 6) hour += 24; // next day: 00->24, 01->25, ..., 05->29
  return (hour - 6) * 60 + m;
}

// Calculate hours between start and end
function calcHours(start, end){
  let sm = timeToMinutesFrom6(start);
  let em = timeToMinutesFrom6(end);
  if(em <= sm) em += 24*60;
  return Math.round((em - sm)/60*10)/10;
}

// Get the percentage position of a time in the timeline (0-100%)
// Timeline spans 06:00 to 03:00(+1) = 21 hours = 1260 minutes
const TL_TOTAL_MINUTES = 21 * 60; // 1260 minutes
function timeToPercent(timeStr){
  const mins = timeToMinutesFrom6(timeStr);
  return Math.max(0, Math.min(100, (mins / TL_TOTAL_MINUTES) * 100));
}

// ============================================================
// Firebase REST
// ============================================================
async function fbGet(url){
  try{
    const r = await fetch(url+'.json');
    if(!r.ok) throw new Error(r.status);
    return await r.json();
  }catch(e){ console.error('fbGet error',url,e); return null; }
}
async function fbPut(url, data){
  try{
    const r = await fetch(url+'.json',{
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(data)
    });
    if(!r.ok) throw new Error(r.status);
    return true;
  }catch(e){ console.error('fbPut error',url,e); showToast('Ï†ÄÏû• Ïã§Ìå®'); return false; }
}
async function fbPatch(url, data){
  try{
    const r = await fetch(url+'.json',{
      method:'PATCH',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(data)
    });
    if(!r.ok) throw new Error(r.status);
    return true;
  }catch(e){ console.error('fbPatch error',url,e); showToast('Ï†ÄÏû• Ïã§Ìå®'); return false; }
}
async function fbDelete(url){
  try{
    const r = await fetch(url+'.json',{method:'DELETE'});
    if(!r.ok) throw new Error(r.status);
    return true;
  }catch(e){ console.error('fbDelete error',url,e); showToast('ÏÇ≠Ï†ú Ïã§Ìå®'); return false; }
}

// ============================================================
// localStorage ‚Äî single source of truth (Firebase = backup)
// ============================================================
const LS_EMPLOYEES = 'ws_employees';
const LS_SCHEDULE_PREFIX = 'ws_sched_';

function lsSaveEmployees(data){
  try{ localStorage.setItem(LS_EMPLOYEES, JSON.stringify(data)); }catch(e){}
}
function lsLoadEmployees(){
  try{
    const s = localStorage.getItem(LS_EMPLOYEES);
    return s ? JSON.parse(s) : null;
  }catch(e){ return null; }
}
function lsSaveSchedule(dateKey, data){
  try{ localStorage.setItem(LS_SCHEDULE_PREFIX + dateKey, JSON.stringify(data)); }catch(e){}
}
function lsLoadSchedule(dateKey){
  try{
    const s = localStorage.getItem(LS_SCHEDULE_PREFIX + dateKey);
    return s ? JSON.parse(s) : null;
  }catch(e){ return null; }
}
function lsDeleteShift(dateKey, empId){
  const sched = lsLoadSchedule(dateKey) || {};
  delete sched[empId];
  lsSaveSchedule(dateKey, sched);
}

// ============================================================
// SSE with generation counter
// ============================================================
function connectSSE(){
  sseGeneration++;
  const gen = sseGeneration;

  // Employees SSE
  if(sseEmployees){ try{sseEmployees.close();}catch(e){} sseEmployees = null; }
  try{
    sseEmployees = new EventSource(FB_EMPLOYEES+'.json');
    sseEmployees.addEventListener('put', function(e){
      if(gen !== sseGeneration){ sseEmployees.close(); return; }
      try{
        const d = JSON.parse(e.data);
        if(d.path === '/'){
          employees = d.data || {};
        } else {
          const key = d.path.replace(/^\//,'');
          if(d.data === null) delete employees[key];
          else employees[key] = d.data;
        }
        lsSaveEmployees(employees);
        renderAll();
      }catch(err){ console.error('SSE emp parse',err); }
    });
    sseEmployees.addEventListener('patch', function(e){
      if(gen !== sseGeneration){ sseEmployees.close(); return; }
      try{
        const d = JSON.parse(e.data);
        const key = d.path.replace(/^\//,'');
        if(key && d.data) employees[key] = Object.assign(employees[key]||{}, d.data);
        else if(!key && d.data) Object.assign(employees, d.data);
        lsSaveEmployees(employees);
        renderAll();
      }catch(err){ console.error('SSE emp patch parse',err); }
    });
    sseEmployees.onerror = function(){
      if(gen !== sseGeneration) return;
      try{sseEmployees.close();}catch(e){}
      sseEmployees = null;
      setTimeout(()=>{ if(gen === sseGeneration) connectSSE(); }, 3000);
    };
  }catch(e){ console.error('SSE emp connect fail',e); }

  // Schedule SSE for current date
  connectScheduleSSE(gen);
}

function connectScheduleSSE(gen){
  if(sseSchedule){ try{sseSchedule.close();}catch(e){} sseSchedule = null; }
  const dk = dateKey(currentDate);
  try{
    sseSchedule = new EventSource(FB_SCHEDULES+'/'+dk+'.json');
    sseSchedule.addEventListener('put', function(e){
      if(gen !== sseGeneration){ sseSchedule.close(); return; }
      try{
        const d = JSON.parse(e.data);
        if(d.path === '/'){
          daySchedule = d.data || {};
        } else {
          const key = d.path.replace(/^\//,'').split('/')[0];
          if(d.data === null) delete daySchedule[key];
          else {
            if(d.path.split('/').filter(Boolean).length === 1){
              daySchedule[key] = d.data;
            } else {
              if(!daySchedule[key]) daySchedule[key] = {};
              const subkey = d.path.replace(/^\//,'').split('/')[1];
              if(d.data === null) delete daySchedule[key][subkey];
              else daySchedule[key][subkey] = d.data;
            }
          }
        }
        lsSaveSchedule(dateKey(currentDate), daySchedule);
        renderAll();
      }catch(err){ console.error('SSE sched parse',err); }
    });
    sseSchedule.addEventListener('patch', function(e){
      if(gen !== sseGeneration){ sseSchedule.close(); return; }
      try{
        const d = JSON.parse(e.data);
        const parts = d.path.replace(/^\//,'').split('/').filter(Boolean);
        if(parts.length === 0 && d.data){
          Object.keys(d.data).forEach(k=>{
            daySchedule[k] = Object.assign(daySchedule[k]||{}, d.data[k]);
          });
        } else if(parts.length === 1 && d.data){
          daySchedule[parts[0]] = Object.assign(daySchedule[parts[0]]||{}, d.data);
        }
        renderAll();
      }catch(err){ console.error('SSE sched patch parse',err); }
    });
    sseSchedule.onerror = function(){
      if(gen !== sseGeneration) return;
      try{sseSchedule.close();}catch(e){}
      sseSchedule = null;
      setTimeout(()=>{ if(gen === sseGeneration) connectScheduleSSE(gen); }, 3000);
    };
  }catch(e){ console.error('SSE sched connect fail',e); }
}

// ============================================================
// Data loading
// ============================================================
async function loadData(){
  const dk = dateKey(currentDate);

  // 1) localStorage Ï¶âÏãú Î°úÎìú (Îç∞Ïù¥ÌÑ∞ Ïú†Ïã§ Î∞©ÏßÄ)
  confirmedDays = lsLoadConfirmed();
  shiftStatus = lsLoadShiftStatus();
  const localEmp = lsLoadEmployees();
  const localSched = lsLoadSchedule(dk);
  if(localEmp && Object.keys(localEmp).length > 0){
    employees = localEmp;
    // hourlyRate ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò (Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Ïóê ÏóÜÏúºÎ©¥ ÏµúÏ†ÄÏãúÍ∏â Ï†ÅÏö©)
    Object.keys(employees).forEach(id => {
      if(!employees[id].hourlyRate) employees[id].hourlyRate = 9860;
    });
  }
  if(localSched){
    daySchedule = localSched;
  }

  // Ïù¥ÎØ∏ Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÏûàÏúºÎ©¥ Ï¶âÏãú Î†åÎçî (Î°úÎî© ÏóÜÏù¥)
  if(localEmp || localSched){
    dataLoaded = true;
    $loading.style.display = 'none';
    $tabContent.style.display = '';
    renderAll();
  } else {
    $loading.style.display = 'flex';
    $tabContent.style.display = 'none';
  }

  // 2) Firebase Î∞±Í∑∏ÎùºÏö¥Îìú ÎèôÍ∏∞Ìôî
  try {
    const [empData, schedData] = await Promise.all([
      fbGet(FB_EMPLOYEES),
      fbGet(FB_SCHEDULES+'/'+dk)
    ]);

    if(empData && Object.keys(empData).length > 0){
      employees = empData;
      lsSaveEmployees(empData);
    } else if(!localEmp || Object.keys(employees).length === 0){
      employees = JSON.parse(JSON.stringify(DEFAULT_EMPLOYEES));
      lsSaveEmployees(employees);
      fbPut(FB_EMPLOYEES, employees);
    }

    if(schedData){
      // Firebase Îç∞Ïù¥ÌÑ∞ÏôÄ Î°úÏª¨ Î≥ëÌï© (Î°úÏª¨ Ïö∞ÏÑ†)
      const merged = Object.assign({}, schedData, localSched || {});
      daySchedule = merged;
      lsSaveSchedule(dk, merged);
    }
  } catch(err){
    console.error('loadData Firebase sync error:', err);
  }
  dataLoaded = true;

  try {
    // ÏßßÏùÄ Ïù¥Î¶Ñ ÎπåÎìú
    buildShortNames();
    // ÏûêÎèô Ìú¥Î¨¥ ÏÉùÏÑ± + Í≥†Ï†ï Ïä§ÏºÄÏ§Ñ Ï†ÅÏö©
    generateAutoDayoffs();
    autoApplyFixed(dk);

    // Ï≤´ Ïã§Ìñâ Ïãú Ï†Ñ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú ÌõÑ Í≥†Ï†ïÍ∞í Ï¥àÍ∏∞Ìôî
    const initVer = localStorage.getItem('ws_init_ver');
    if(initVer !== 'v4'){
      // Í∏∞Ï°¥ Ïä§ÏºÄÏ§Ñ Ï†ÑÎ∂Ä ÌÅ¥Î¶¨Ïñ¥
      for(let i=0; i<localStorage.length; i++){
        const key = localStorage.key(i);
        if(key && key.startsWith('ws_sched_')){
          localStorage.removeItem(key);
          i--; // ÌÇ§ ÏÇ≠Ï†ú ÌõÑ Ïù∏Îç±Ïä§ Ï°∞Ï†ï
        }
      }
      daySchedule = {};
      autoApplyFixed(dk);
      localStorage.setItem('ws_init_ver', 'v4');
    }
  } catch(e) { console.error('loadData init error:', e); }

  $loading.style.display = 'none';
  $tabContent.style.display = '';
  try { renderAll(); } catch(e) { console.error('renderAll error:', e); }
  loadWeekSchedules();
  updateConfirmBtn();
}

async function loadWeekSchedules(){
  const monday = getMonday(currentDate);
  const promises = [];
  const keys = [];
  for(let i=0; i<7; i++){
    const d = new Date(monday);
    d.setDate(d.getDate()+i);
    const dk = dateKey(d);
    keys.push(dk);
    promises.push(fbGet(FB_SCHEDULES+'/'+dk));
  }
  const results = await Promise.all(promises);
  weekSchedules = {};
  keys.forEach((k,i)=>{
    weekSchedules[k] = results[i] || {};
  });
  renderWeek();
}

// Í≥†Ï†ï Ïä§ÏºÄÏ§Ñ + Ìú¥Î¨¥Ïûê ÏûêÎèô Ï†ÅÏö© (Îπà ÎÇ†ÏßúÏóêÎßå)
function autoApplyFixed(dk){
  let changed = false;
  for(const empName in FIXED_SCHEDULES){
    const fix = FIXED_SCHEDULES[empName];
    if(fix.type === 'variable' || !fix.start) continue;
    const empId = findEmpIdByName(empName);
    if(!empId) continue;
    // Ïù¥ÎØ∏ ÏûÖÎ†•Îêú Í≤ΩÏö∞ Í±¥ÎìúÎ¶¨ÏßÄ ÏïäÏùå
    if(daySchedule[empId]) continue;
    // Ìú¥Î¨¥Ïù∏ Í≤ΩÏö∞ Í±¥ÎìúÎ¶¨ÏßÄ ÏïäÏùå
    if(isDayOff(empId, dk)) continue;
    daySchedule[empId] = {start:fix.start, end:fix.end, role:fix.role};
    changed = true;
  }
  if(changed){
    lsSaveSchedule(dk, daySchedule);
    // FirebaseÏóêÎèÑ Ï†ÄÏû•
    for(const empId in daySchedule){
      const s = daySchedule[empId];
      if(s && s.start) fbPut(FB_SCHEDULES+'/'+dk+'/'+empId, s);
    }
  }
  return changed;
}

// Í≥†Ï†ïÍ∑ºÎ¨¥Ïûê ÌÅ¥Î¶¨Ïñ¥ ÌõÑ Ïû¨Î∞∞Ïπò (Í≥†Ï†ï Ïä§ÏºÄÏ§Ñ Í∞ïÏ†ú ÎçÆÏñ¥Ïì∞Í∏∞)
function resetToFixed(dk){
  for(const empName in FIXED_SCHEDULES){
    const fix = FIXED_SCHEDULES[empName];
    if(fix.type === 'variable' || !fix.start) continue;
    const empId = findEmpIdByName(empName);
    if(!empId) continue;
    if(isDayOff(empId, dk)){
      delete daySchedule[empId];
    } else {
      daySchedule[empId] = {start:fix.start, end:fix.end, role:fix.role};
    }
  }
  lsSaveSchedule(dk, daySchedule);
  for(const empName in FIXED_SCHEDULES){
    const fix = FIXED_SCHEDULES[empName];
    if(fix.type === 'variable' || !fix.start) continue;
    const empId = findEmpIdByName(empName);
    if(!empId) continue;
    const s = daySchedule[empId];
    fbPut(FB_SCHEDULES+'/'+dk+'/'+empId, s || null);
  }
  renderCurrentTab();
  showToast('Í≥†Ï†ï Ïä§ÏºÄÏ§Ñ Ïû¨Î∞∞Ïπò ÏôÑÎ£å');
}

function showDateFlash(){
  const m = currentDate.getMonth()+1;
  const d = currentDate.getDate();
  const dow = DOW_KR[currentDate.getDay()];
  let el = document.getElementById('dateFlash');
  if(!el){
    el = document.createElement('div');
    el.id = 'dateFlash';
    el.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2.5rem;font-weight:900;color:#fff;opacity:0;pointer-events:none;z-index:999;text-shadow:0 2px 12px #000a;transition:opacity .15s;';
    document.body.appendChild(el);
  }
  el.textContent = m+'/'+d+' '+dow;
  el.style.opacity = '.35';
  clearTimeout(el._t);
  el._t = setTimeout(()=>{ el.style.opacity = '0'; }, 600);
}

async function onDateChange(){
  showDateFlash();
  updateDateDisplay();
  // Reconnect schedule SSE for new date
  if(sseSchedule){ try{sseSchedule.close();}catch(e){} sseSchedule = null; }
  connectScheduleSSE(sseGeneration);
  const dk = dateKey(currentDate);
  // localStorage Î®ºÏ†Ä
  const localSched = lsLoadSchedule(dk);
  if(localSched) daySchedule = localSched;
  else daySchedule = {};
  // ÏûêÎèô Ìú¥Î¨¥ ÏÉùÏÑ± + Í≥†Ï†ï Ïä§ÏºÄÏ§Ñ Ï†ÅÏö©
  generateAutoDayoffs();
  autoApplyFixed(dk);
  renderCurrentTab();
  // Firebase ÎèôÍ∏∞Ìôî
  try{
    const schedData = await fbGet(FB_SCHEDULES+'/'+dk);
    if(schedData){
      const merged = Object.assign({}, schedData, localSched || {});
      daySchedule = merged;
      lsSaveSchedule(dk, merged);
      renderCurrentTab();
    }
  }catch(e){}
  loadWeekSchedules();
  updateConfirmBtn();
}

// ============================================================
// Date display
// ============================================================
function updateDateDisplay(){
  const m = currentDate.getMonth()+1;
  const d = currentDate.getDate();
  const dow = DOW_KR[currentDate.getDay()];
  $dateDisplay.textContent = m+'/'+d+' '+dow;
}

// ============================================================
// Render all
// ============================================================
function renderAll(){
  try {
    updateDateDisplay();
    renderBriefing();
    renderCurrentTab();
    renderDateStrip();
    renderWeek();
    checkLogistics();
    buildCalButtons();
  } catch(e) { console.error('renderAll error:', e); }
}

// ============================================================
// ÎãπÏùº Î∏åÎ¶¨Ìïë Ìå®ÎÑê ‚Äî ÌïúÎààÏóê ÏóºÎëêÏÇ¨Ìï≠ Î™®ÏïÑÎ≥¥Í∏∞
// ============================================================
function renderBriefing(){
  const panel = $('briefingPanel');
  if(!panel) return;
  const dk = dateKey(currentDate);
  const empKeys = Object.keys(employees);

  let html = '';

  // ===== KPI ÏöîÏïΩ Ïπ¥Îìú =====
  const offToday = [];
  let workingCount = 0, totalHours = 0, totalCost = 0;
  let fixedCount=0, variableCount=0, emptyCount=0;
  empKeys.forEach(id => {
    if(isDayOff(id, dk)){ offToday.push(employees[id]?.name || id); return; }
    const s = daySchedule[id];
    if(s && s.start){
      workingCount++;
      const h = calcHours(s.start, s.end);
      totalHours += h;
      totalCost += h * (employees[id]?.hourlyRate || 0);
      const fix = getFixedSchedule(employees[id]?.name);
      if(fix && fix.type==='fixed' && s.start===fix.start && s.end===fix.end) fixedCount++;
      else variableCount++;
    } else {
      emptyCount++;
    }
  });

  // Ï∂©Ï°±Î•† Í≥ÑÏÇ∞
  const staffing = calcStaffing(empKeys, dk);
  let okHours = 0, totalCheckHours = 0;
  for(const hStr in staffing){
    const s = staffing[hStr];
    totalCheckHours++;
    const kitchenOk = !s.kitchenOver && !s.kitchenUnder;
    // Î∞∞Îã¨ÎåÄÌñâ Í∞ÄÏö© ÏãúÍ∞Ñ or Î∞∞Îã¨ 1Î™Ö Ïù¥ÏÉÅÏù¥Î©¥ OK, ÎåÄÌñâ ÏãúÍ∞Ñ Î∞ñ(6~9Ïãú)Ïù¥Î©¥ Î∞∞Îã¨ Î∂àÌïÑÏöî
    const deliveryOk = s.deliveryWithDA >= 1 || !s.daAvail && s.delivery === 0 && parseInt(hStr) < 10;
    if(kitchenOk && deliveryOk && !s.carOver && !s.bikeOver) okHours++;
  }
  const complianceRate = totalCheckHours > 0 ? Math.round((okHours/totalCheckHours)*100) : 0;

  html += '<div style="display:flex;gap:6px;margin-bottom:6px;">';
  // Ïπ¥Îìú1: Ï∂úÍ∑º Ïù∏Ïõê
  html += '<div style="flex:1;background:#242444;border-radius:8px;padding:6px 8px;text-align:center;">';
  html += '<div style="font-size:1.1rem;font-weight:800;color:#FFFFFF;">'+workingCount+'<span style="font-size:.6rem;color:#707088;">/'+empKeys.length+'</span></div>';
  html += '<div style="font-size:.55rem;color:#9090A8;">Ï∂úÍ∑º</div></div>';
  // Ïπ¥Îìú2: Ï¥ù ÏãúÍ∞Ñ
  html += '<div style="flex:1;background:#242444;border-radius:8px;padding:6px 8px;text-align:center;">';
  html += '<div style="font-size:1.1rem;font-weight:800;color:#FFD700;">'+totalHours.toFixed(1).replace('.0','')+'<span style="font-size:.6rem;color:#707088;">h</span></div>';
  html += '<div style="font-size:.55rem;color:#9090A8;">Ï¥ùÏãúÍ∞Ñ</div></div>';
  // Ïπ¥Îìú3: Ï∂©Ï°±Î•†
  const compColor = complianceRate >= 80 ? '#2ECC71' : complianceRate >= 50 ? '#E67E22' : '#E74C3C';
  html += '<div style="flex:1;background:#242444;border-radius:8px;padding:6px 8px;text-align:center;">';
  html += '<div style="font-size:1.1rem;font-weight:800;color:'+compColor+';">'+complianceRate+'<span style="font-size:.6rem;color:#707088;">%</span></div>';
  html += '<div style="font-size:.55rem;color:#9090A8;">Ï∂©Ï°±Î•†</div></div>';
  // Ïπ¥Îìú4: Ïù∏Í±¥ÎπÑ
  html += '<div style="flex:1;background:#242444;border-radius:8px;padding:6px 8px;text-align:center;">';
  html += '<div style="font-size:.85rem;font-weight:800;color:#E0E0EC;">'+(totalCost > 0 ? (totalCost/10000).toFixed(1)+'Îßå' : '-')+'</div>';
  html += '<div style="font-size:.55rem;color:#9090A8;">Ïù∏Í±¥ÎπÑ</div></div>';
  // Ïπ¥Îìú5: Ìú¥Î¨¥
  html += '<div style="flex:1;background:#242444;border-radius:8px;padding:6px 8px;text-align:center;">';
  html += '<div style="font-size:1.1rem;font-weight:800;color:#E74C3C;">'+offToday.length+'</div>';
  html += '<div style="font-size:.55rem;color:#9090A8;">Ìú¥Î¨¥</div></div>';
  html += '</div>';

  // ===== ÏÉÅÌÉú ÌïúÏ§Ñ ÏöîÏïΩ =====
  html += '<div style="display:flex;flex-wrap:wrap;gap:6px;font-size:.65rem;margin-bottom:4px;">';
  html += '<span style="color:#2ECC71;">Í≥†Ï†ï'+fixedCount+'</span>';
  if(variableCount > 0) html += '<span style="color:#E67E22;">ÏàòÎèô'+variableCount+'</span>';
  if(emptyCount > 0) html += '<span style="color:#E74C3C;font-weight:700;">ÎØ∏ÏûÖÎ†•'+emptyCount+'</span>';
  if(offToday.length > 0) html += '<span style="color:#E74C3C;">Ìú¥:'+offToday.join(',')+'</span>';
  // ÎåÄÏú† Í≤ΩÍ≥†
  const daeyuId = findEmpIdByName('ÎåÄÏú†');
  if(daeyuId && !isDayOff(daeyuId, dk) && (!daySchedule[daeyuId] || !daySchedule[daeyuId].start)){
    html += '<span style="color:#F0A500;font-weight:700;">ÎåÄÏú†ÎØ∏ÏûÖÎ†•</span>';
  }
  // ÎÇ†Ïî®
  const wxNow = hourlyWeather[new Date().getHours()];
  if(wxNow){
    html += '<span style="color:#9090A8;">'+wxNow.i+wxNow.t+'¬∞</span>';
  }
  // Ïä§Ìè¨Ï∏† (Ïù¥Ïäà ÏóÜÏúºÎ©¥ ÌëúÍ∏∞X)
  const sportsEl = $('sportsInfo');
  if(sportsEl && sportsEl.textContent && !sportsEl.textContent.includes('Î°úÎî©') && !sportsEl.textContent.includes('Í≤ΩÍ∏∞ÏóÜÏùå') && !sportsEl.textContent.includes('ÏóÜÏùå')){
    html += '<span style="color:#2AC1BC;">'+sportsEl.textContent.substring(0,25)+'</span>';
  }
  html += '</div>';

  // ===== ÎãπÏùº Îß§Ï∂ú ÏòàÏÉÅ + 3Ï§Ñ Ïù∏Ïõê Í≤åÏù¥ÏßÄ =====
  const hmHours = GAUGE_HOURS;
  const gaugeRows = [
    {key:'kitchen', roleKey:'Ï£ºÎ∞©', label:'Ï£ºÎ∞©', color:'#E67E22', getVal:s=>s.kitchen},
    {key:'bikeDel', roleKey:'Ïò§ÌÜ†Î∞îÏù¥', label:'Î∞îÏù¥ÌÅ¨', color:'#FFD700', getVal:s=>s.bikeDel},
    {key:'carDel', roleKey:'Ï∞®Î∞∞Îã¨', label:'Ï∞®', color:'#4ECDC4', getVal:s=>s.carDel},
  ];
  // Îß§Ï∂ú Íµ¨Í∞Ñ ÏÑ†ÌÉù Î≤ÑÌäº (4Íµ¨Í∞Ñ) + ÏÑ§Ï†ï Î≤ÑÌäº
  const activeKey = getActivePresetKey();
  const presetLabels = JSON.parse(localStorage.getItem('ws_preset_labels') || '{}');
  html += '<div style="display:flex;gap:3px;margin-bottom:3px;align-items:center;">';
  for(const [key, pre] of Object.entries(STAFF_PRESETS)){
    const sel = activeKey === key;
    const label = presetLabels[key] || pre.label;
    html += '<div data-revenue-key="'+key+'" style="flex:1;padding:4px 2px;border-radius:4px;text-align:center;cursor:pointer;font-size:.5rem;font-weight:700;'
      +(sel?'background:#FFD70033;border:1.5px solid #FFD700;color:#FFD700;':'background:#1A1A30;border:1.5px solid #2E2E52;color:#707088;')
      +'">'+label+'</div>';
  }
  html += '<div data-revenue-edit style="padding:4px 5px;border-radius:4px;cursor:pointer;font-size:.5rem;color:#707088;background:#1A1A30;border:1px solid #2E2E52;">‚öô</div>';
  html += '</div>';
  if(staffSettings.hourlyOverrides) html += '<div style="font-size:.45rem;color:#E67E22;margin-bottom:1px;">Ïª§Ïä§ÌÖÄ ÏàòÏ†ï Ï†ÅÏö©Ï§ë <span data-clear-overrides style="text-decoration:underline;cursor:pointer;">Ï¥àÍ∏∞Ìôî</span></div>';

  gaugeRows.forEach(row => {
    html += '<div style="display:flex;align-items:center;gap:2px;margin-bottom:1px;">';
    html += '<span style="font-size:.5rem;font-weight:700;color:'+row.color+';min-width:28px;">'+row.label+'</span>';
    html += '<div style="flex:1;display:flex;gap:1px;height:20px;">';
    hmHours.forEach(h => {
      const hStr = pad(h)+':00';
      const s = staffing[hStr];
      const val = s ? row.getVal(s) : 0;
      const lim = getRoleLimits(h)[row.roleKey];
      const isBikeDA = row.key==='bikeDel' && val===0 && s && s.daAvail;
      const hasOverride = staffSettings.hourlyOverrides && staffSettings.hourlyOverrides[h];
      let bg = '#1A1A30', tc = '#707088', txt = '';
      if(isBikeDA){
        bg = '#E67E2230'; tc = '#E67E22'; txt = 'ÎåÄ';
      } else if(val > 0){
        if(val > lim.max){ bg = C_OFF; tc = '#fff'; }
        else if(val < lim.min){ bg = C_OFF+'55'; tc = C_OFF; }
        else { bg = '#3498DB40'; tc = '#E0E0EC'; }
        txt = val%1===0 ? val : val.toFixed(1);
      } else if(lim.min > 0){
        bg = C_OFF+'22'; tc = C_OFF; txt = '!';
      }
      html += '<div data-gauge-hour="'+h+'" style="flex:1;background:'+bg+';display:flex;align-items:center;justify-content:center;font-size:.45rem;color:'+tc+';font-weight:700;border-radius:1px;cursor:pointer;'+(hasOverride?'border-bottom:2px solid #FFD700;':'')+'">';
      html += txt;
      html += '</div>';
    });
    html += '</div></div>';
  });
  // ÏãúÍ∞Ñ Î†àÏù¥Î∏î
  html += '<div style="display:flex;align-items:center;gap:2px;">';
  html += '<span style="min-width:28px;"></span>';
  html += '<div style="flex:1;display:flex;gap:1px;">';
  hmHours.forEach(h => { html += '<div style="flex:1;text-align:center;font-size:.4rem;color:#707088;">'+h+'</div>'; });
  html += '</div></div>';

  panel.innerHTML = html;

  // Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ: Îß§Ï∂úÍµ¨Í∞Ñ Î≤ÑÌäº + Í≤åÏù¥ÏßÄ ÏÖÄ + Ï¥àÍ∏∞Ìôî
  panel.querySelectorAll('[data-revenue-key]').forEach(btn => {
    btn.addEventListener('click', () => setDailyRevenue(btn.dataset.revenueKey));
  });
  const rvEdit = panel.querySelector('[data-revenue-edit]');
  if(rvEdit) rvEdit.addEventListener('click', () => openRevenueEditModal());
  const clrBtn = panel.querySelector('[data-clear-overrides]');
  if(clrBtn) clrBtn.addEventListener('click', () => clearHourlyOverrides());
  panel.querySelectorAll('[data-gauge-hour]').forEach(cell => {
    cell.addEventListener('click', (e) => {
      e.stopPropagation();
      openHourLimitEdit(parseInt(cell.dataset.gaugeHour));
    });
  });
}

// ============================================================
// Timeline Rendering ‚Äî VERTICAL, FIT TO SCREEN
// ============================================================
let hourlyWeather = {}; // {hour: {t:temp, i:icon}}

function renderTimeline(){
  if(!dataLoaded) return;
  const container = $timelineContent;
  container.innerHTML = '';

  const empKeys = Object.keys(employees);

  if(empKeys.length === 0){
    container.innerHTML = '<div style="padding:30px;text-align:center;color:#9090A8;font-size:.9rem;">ÏßÅÏõêÏùÑ Î®ºÏ†Ä Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî</div>';
    return;
  }

  // --- Header (employee names) ---
  const header = document.createElement('div');
  header.className = 'vt-header';

  const timeHdr = document.createElement('div');
  timeHdr.className = 'vt-time-hdr';
  timeHdr.textContent = '';
  header.appendChild(timeHdr);

  const dk = dateKey(currentDate);
  empKeys.forEach(empId => {
    const emp = employees[empId];
    const off = isDayOff(empId, dk);
    const hdr = document.createElement('div');
    hdr.className = 'vt-emp-hdr';
    const empShift = daySchedule[empId];
    const dotColor = off ? '#E74C3C' : (empShift && empShift.start ? getShiftType(empShift.start, empShift.end).color : '#707088');
    hdr.innerHTML = '<div class="vt-dot" style="background:'+dotColor+'"></div><div class="vt-name">'+(off?'<span style="color:#E74C3C;">Ìú¥</span> ':'')+emp.name+'</div>';
    if(off) hdr.style.opacity = '.5';
    header.appendChild(hdr);
  });
  container.appendChild(header);

  // --- Body (fills remaining screen) ---
  const wrapper = document.createElement('div');
  wrapper.className = 'vt-wrapper';

  const body = document.createElement('div');
  body.className = 'vt-body';

  // Time column with weather
  const timeCol = document.createElement('div');
  timeCol.className = 'vt-time-col';
  const SHOW_HOURS = new Set([6,9,12,15,18,21,0,3]);
  TL_HOURS.forEach((h, idx) => {
    const pct = (idx / TL_HOURS.length) * 100;
    const tick = document.createElement('div');
    tick.className = 'vt-hour-tick';
    tick.style.top = pct + '%';
    tick.style.height = (100 / TL_HOURS.length) + '%';
    let html = SHOW_HOURS.has(h) ? '<span>'+pad(h)+'</span>' : '';
    // Weather at this hour
    // Ïò®ÎèÑ ÌëúÍ∏∞ ÏÇ≠Ï†ú (Í∞ÄÏãúÏÑ± Ï†ÄÌï¥)
    tick.innerHTML = html;
    timeCol.appendChild(tick);
  });
  body.appendChild(timeCol);

  // Ï∂©Îèå Í∞êÏßÄ
  const conflictsMap = detectConflicts(empKeys, dk);

  // Employee columns with drag support
  empKeys.forEach(empId => {
    const emp = employees[empId];
    const shift = daySchedule[empId];
    const off = isDayOff(empId, dk);
    const col = document.createElement('div');
    col.className = 'vt-emp-col';
    col.dataset.empid = empId;
    const hasConflict = !!conflictsMap[empId];

    // Grid lines at each hour
    TL_HOURS.forEach((h, idx) => {
      const pct = (idx / TL_HOURS.length) * 100;
      const line = document.createElement('div');
      line.className = 'vt-grid-line';
      line.style.top = pct + '%';
      line.style.height = (100 / TL_HOURS.length) + '%';
      col.appendChild(line);
    });

    // Day-off overlay
    if(off){
      const offBlock = document.createElement('div');
      offBlock.style.cssText = 'position:absolute;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;background:#E74C3C10;z-index:1;';
      offBlock.innerHTML = '<span style="color:#E74C3C;font-size:.75rem;font-weight:700;writing-mode:vertical-rl;opacity:.6;">Ìú¥ Î¨¥</span>';
      col.appendChild(offBlock);
      col.style.opacity = '.4';
    }

    // Shift block
    if(!off && shift && shift.start && shift.end){
      const block = document.createElement('div');
      block.className = 'vt-shift';
      const topPct = timeToPercent(shift.start);
      const bottomPct = timeToPercent(shift.end);
      let heightPct = bottomPct - topPct;
      if(heightPct <= 0) heightPct += 100;

      block.style.top = topPct + '%';
      block.style.height = Math.min(heightPct, 100 - topPct) + '%';

      // Í∑ºÎ¨¥ÌòïÌÉú ÏÉâÏÉÅ
      const shiftType = getShiftType(shift.start, shift.end);
      if(hasConflict){
        block.style.background = '#E74C3C44';
        block.style.borderLeft = '3px solid #E74C3C';
        block.style.borderTop = '1px solid #E74C3Caa';
        block.style.boxShadow = 'inset 0 0 8px #E74C3C33';
      } else {
        block.style.background = shiftType.bg;
        block.style.borderLeft = '3px solid '+shiftType.color;
        block.style.borderTop = '1px solid '+shiftType.color+'55';
      }

      const roles = shift.role ? shift.role.split(',').filter(Boolean) : [];
      const roleHtml = roles.map(r => '<span style="color:'+(ROLE_COLORS[r]||'#9090A8')+';font-weight:700;">'+(ROLE_LABELS[r]||r)+'</span>').join(' ');
      const timeText = shift.start.replace(/^0/,'')+'-'+shift.end.replace(/^0/,'');
      const hours = calcHours(shift.start, shift.end);

      const nameLbl = emp.name;
      let conflictBadge = '';
      if(hasConflict){
        const reasons = conflictsMap[empId].map(c=>c.msg);
        const uniqueReasons = [...new Set(reasons)];
        conflictBadge = '<span style="font-size:.55rem;color:#FF6B6B;font-weight:700;background:#E74C3C33;padding:1px 3px;border-radius:3px;">'+uniqueReasons[0]+'</span>';
      }
      block.innerHTML =
        '<span style="font-size:.75rem;font-weight:700;color:#FFFFFF;text-shadow:0 1px 2px #000;">'+nameLbl+'</span>'+
        '<span style="font-size:.7rem;font-weight:600;color:#FFFFFF;">'+timeText+'</span>'+
        (roleHtml ? '<span style="font-size:.6rem;">'+roleHtml+'</span>' : '')+
        '<span style="font-size:.6rem;color:#FFD700;font-weight:600;">'+hours+'h</span>'+
        conflictBadge;

      block.addEventListener('click', (e)=>{
        e.stopPropagation();
        openShiftModal(empId);
      });
      col.appendChild(block);
    }

    // Ï∂©Îèå Ïª¨Îüº Î∞∞Í≤Ω (Ìó§ÎçîÏôÄ Ïó∞Îèô)
    if(hasConflict && !off){
      col.style.background = '#E74C3C0A';
    }

    // ÌÑ∞Ïπò Ïãú ÌåùÏóÖ Ïó¥Í∏∞ (ÎìúÎûòÍ∑∏ ÏûÖÎ†• Ï†úÍ±∞ ‚Äî ÏàòÏ†ïÏ∞ΩÏóêÏÑúÎßå ÏûÖÎ†•)
    col.addEventListener('click', ()=> openShiftModal(empId));

    body.appendChild(col);
  });

  wrapper.appendChild(body);
  container.appendChild(wrapper);

  // --- Summary row ---
  const summary = document.createElement('div');
  summary.className = 'vt-summary';

  const sumTime = document.createElement('div');
  sumTime.className = 'vt-summary-time';
  sumTime.textContent = 'Ìï©Í≥Ñ';
  summary.appendChild(sumTime);

  empKeys.forEach(empId => {
    const shift = daySchedule[empId];
    const off = isDayOff(empId, dk);
    const cell = document.createElement('div');
    cell.className = 'vt-summary-cell';
    if(off){
      cell.textContent = 'Ìú¥';
      cell.style.color = '#E74C3C';
      cell.style.fontSize = '.6rem';
    } else if(shift && shift.start && shift.end){
      cell.textContent = calcHours(shift.start, shift.end) + 'h';
    } else {
      cell.textContent = '-';
      cell.style.color = '#707088';
    }
    summary.appendChild(cell);
  });
  container.appendChild(summary);

  // --- Role-Based Coverage View (Ïó≠Ìï†Î≥Ñ Ïª§Î≤ÑÎ¶¨ÏßÄ) ---
  const staffing = calcStaffing(empKeys, dk);
  const staffDiv = document.createElement('div');
  staffDiv.style.cssText = 'padding:6px 8px;background:#1A1A30;border-top:1px solid #2E2E52;';

  const checkHours = [6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,0,1,2];
  const totalSlots = checkHours.length;

  let html = '<div style="font-size:.7rem;color:#FFD700;font-weight:600;margin-bottom:6px;">Ïó≠Ìï†Î≥Ñ Ïª§Î≤ÑÎ¶¨ÏßÄ</div>';

  // === Ïó≠Ìï†Î≥Ñ ÏàòÌèâ Î∞î ===
  const roles = [
    {key:'kitchen', label:'Ï£ºÎ∞©', color:'#E67E22', getVal:(s)=>s.kitchen, getLimits:(h)=>getRoleLimits(h)['Ï£ºÎ∞©']},
    {key:'bikeDel', label:'Î∞îÏù¥ÌÅ¨', color:'#FFD700', getVal:(s)=>s.bikeDel, getLimits:(h)=>getRoleLimits(h)['Ïò§ÌÜ†Î∞îÏù¥']},
    {key:'carDel', label:'Ï∞®', color:'#4ECDC4', getVal:(s)=>s.carDel, getLimits:(h)=>getRoleLimits(h)['Ï∞®Î∞∞Îã¨']},
  ];

  roles.forEach(role => {
    html += '<div style="margin-bottom:4px;">';
    html += '<div style="display:flex;align-items:center;gap:4px;margin-bottom:1px;">';
    html += '<span style="font-size:.6rem;font-weight:700;color:'+role.color+';min-width:38px;">'+role.label+'</span>';
    html += '<div style="flex:1;display:flex;gap:1px;height:16px;">';
    checkHours.forEach(h => {
      const hStr = pad(h)+':00';
      const s = staffing[hStr];
      const val = s ? role.getVal(s) : 0;
      const lim = role.getLimits(h);
      const isBikeDA = role.key==='bikeDel' && val===0 && s && s.daAvail;
      let bg = '#1A1A30', textColor = '#707088', txt = '';
      if(isBikeDA){
        bg = '#E67E2230'; textColor = '#E67E22'; txt = 'ÎåÄ';
      } else if(val > 0){
        if(val > lim.max){ bg = C_OFF; textColor = '#fff'; }
        else if(val < lim.min){ bg = C_OFF+'55'; textColor = C_OFF; }
        else { bg = '#3498DB40'; textColor = '#E0E0EC'; }
        txt = val%1===0 ? val : val.toFixed(1);
      } else if(lim.min > 0){
        bg = C_OFF+'22'; textColor = C_OFF; txt = '!';
      }
      html += '<div style="flex:1;background:'+bg+';display:flex;align-items:center;justify-content:center;font-size:.45rem;color:'+textColor+';font-weight:700;border-radius:1px;">';
      html += txt;
      html += '</div>';
    });
    html += '</div></div></div>';
  });

  // === Î∞∞Îã¨ÎåÄÌñâ Ìñâ ===
  html += '<div style="margin-bottom:4px;">';
  html += '<div style="display:flex;align-items:center;gap:4px;margin-bottom:1px;">';
  html += '<span style="font-size:.6rem;font-weight:700;color:#E67E22;min-width:38px;">ÎåÄÌñâ</span>';
  html += '<div style="flex:1;display:flex;gap:1px;height:12px;">';
  checkHours.forEach(h => {
    const hStr = pad(h)+':00';
    const s = staffing[hStr];
    const delivery = s ? s.delivery : 0;
    const daAvail = s ? s.daAvail : false;
    const needDA = daAvail && delivery < 1;
    html += '<div style="flex:1;background:'+(needDA?'#E67E2233':'#1A1A30')+';display:flex;align-items:center;justify-content:center;font-size:.4rem;color:'+(needDA?'#E67E22':'#707088')+';font-weight:600;border-radius:1px;">';
    html += needDA ? 'ÎåÄ' : '';
    html += '</div>';
  });
  html += '</div></div></div>';

  // === ÏãúÍ∞Ñ Î†àÏù¥Î∏î ===
  html += '<div style="display:flex;align-items:center;gap:4px;">';
  html += '<span style="min-width:38px;"></span>';
  html += '<div style="flex:1;display:flex;gap:1px;">';
  checkHours.forEach(h => {
    html += '<div style="flex:1;text-align:center;font-size:.4rem;color:#707088;">'+h+'</div>';
  });
  html += '</div></div>';

  // === Ìï©Í≥Ñ Ïù∏Ïõê Ìñâ ===
  html += '<div style="display:flex;align-items:center;gap:4px;margin-top:2px;">';
  html += '<span style="font-size:.55rem;color:#9090A8;min-width:38px;">Ìï©Í≥Ñ</span>';
  html += '<div style="flex:1;display:flex;gap:1px;height:14px;">';
  checkHours.forEach(h => {
    const hStr = pad(h)+':00';
    const s = staffing[hStr];
    const total = s ? s.total : 0;
    const anyConflict = s && (s.kitchenOver || s.kitchenUnder || s.carOver || s.bikeOver);
    html += '<div style="flex:1;background:'+(anyConflict?'#E74C3C22':'#2ECC7115')+';display:flex;align-items:center;justify-content:center;font-size:.5rem;color:'+(anyConflict?'#E74C3C':'#2ECC71')+';font-weight:700;border-radius:1px;">';
    html += total > 0 ? total : '';
    html += '</div>';
  });
  html += '</div></div>';

  // Î≤îÎ°Ä
  html += '<div style="font-size:.5rem;color:#707088;margin-top:4px;display:flex;gap:8px;flex-wrap:wrap;">';
  html += '<span><span style="color:#2ECC71;">‚ñ†</span> Ï∂©Ï°±</span>';
  html += '<span><span style="color:#E74C3C;">‚ñ†</span> Ï¥àÍ≥º</span>';
  html += '<span><span style="color:#E67E22;">‚ñ†</span> Î∂ÄÏ°±</span>';
  html += '<span><span style="color:#E67E22;">!</span> ÏµúÏÜåÎØ∏Îã¨</span>';
  html += '<span>ÎåÄÌñâ=Î∞∞Îã¨ÎåÄÌñâ(10~01Ïãú)</span>';
  html += '</div>';

  staffDiv.innerHTML = html;
  container.appendChild(staffDiv);
}

// Staffing calculation (Ìé∏ÏûÖ Î°úÏßÅ Ìè¨Ìï®)
function calcStaffing(empKeys, dk){
  const result = {};
  const checkHours = [6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,0,1,2];
  const preset = getActivePreset();

  for(const h of checkHours){
    const hStr = pad(h)+':00';
    const hMin = timeToMinutesFrom6(hStr);
    let kitchen = 0, carDel = 0, bikeDel = 0, total = 0;
    let hasBikeWorker = false; // Ïò§ÌÜ†Î∞îÏù¥ Ï∂úÍ∑ºÏûê Ï°¥Ïû¨ Ïó¨Î∂Ä

    empKeys.forEach(empId => {
      if(isDayOff(empId, dk)) return;
      const shift = daySchedule[empId];
      if(!shift || !shift.start || !shift.end) return;

      const sMin = timeToMinutesFrom6(shift.start);
      let eMin = timeToMinutesFrom6(shift.end);
      if(eMin <= sMin) eMin += 24*60;

      if(hMin >= sMin && hMin < eMin){
        total++;
        const roles = shift.role ? shift.role.split(',').filter(Boolean) : [];
        const weight = roles.length > 1 ? 0.5 : 1; // Î©ÄÌã∞Ïó≠Ìï† 0.5Î™Ö
        if(roles.includes('Ï£ºÎ∞©')) kitchen += weight;
        if(roles.includes('Ï∞®Î∞∞Îã¨')) carDel += weight;
        if(roles.includes('Ïò§ÌÜ†Î∞îÏù¥')){ bikeDel += weight; hasBikeWorker = true; }
        if(roles.length === 0) kitchen += 1; // ÎØ∏ÏßÄÏ†ï ‚Üí Ï£ºÎ∞©
      }
    });

    const limits = getRoleLimits(h);

    // === Ìé∏ÏûÖ Î°úÏßÅ: Ï£ºÎ∞© Ï¥àÍ≥º Ïãú Î∞∞Îã¨Î°ú Ìé∏ÏûÖ ===
    // Ïò§ÌÜ†Î∞îÏù¥ Ïö∞ÏÑ†, Ï∞® Ï∞®Ïàú. Ïò§ÌÜ†Î∞îÏù¥ Ï∂úÍ∑ºÏûê ÏûàÏúºÎ©¥ Ï∞®Î°ú Ìé∏ÏûÖ.
    let kitchenFinal = kitchen, carFinal = carDel, bikeFinal = bikeDel;
    const kitchenMax = limits['Ï£ºÎ∞©'].max;
    if(kitchenFinal > kitchenMax){
      let overflow = kitchenFinal - kitchenMax;
      // Ïò§ÌÜ†Î∞îÏù¥ Ï∂úÍ∑ºÏûêÍ∞Ä Ïù¥ÎØ∏ ÏûàÏúºÎ©¥ ‚Üí Ï∞®Î°ú Ìé∏ÏûÖ
      if(hasBikeWorker && bikeFinal >= limits['Ïò§ÌÜ†Î∞îÏù¥'].max){
        // Ïò§ÌÜ†Î∞îÏù¥ ÌíÄ ‚Üí Ï∞®Î°ú Ìé∏ÏûÖ
        const carSpace = limits['Ï∞®Î∞∞Îã¨'].max - carFinal;
        if(carSpace > 0){
          const move = Math.min(overflow, carSpace);
          carFinal += move; kitchenFinal -= move; overflow -= move;
        }
        if(overflow > 0){
          const bikeSpace = limits['Ïò§ÌÜ†Î∞îÏù¥'].max - bikeFinal;
          if(bikeSpace > 0){ const move = Math.min(overflow, bikeSpace); bikeFinal += move; kitchenFinal -= move; overflow -= move; }
        }
      } else {
        // Ïò§ÌÜ†Î∞îÏù¥ Ïö∞ÏÑ† Ìé∏ÏûÖ
        const bikeSpace = limits['Ïò§ÌÜ†Î∞îÏù¥'].max - bikeFinal;
        if(bikeSpace > 0){
          const move = Math.min(overflow, bikeSpace);
          bikeFinal += move; kitchenFinal -= move; overflow -= move;
        }
        if(overflow > 0){
          const carSpace = limits['Ï∞®Î∞∞Îã¨'].max - carFinal;
          if(carSpace > 0){ const move = Math.min(overflow, carSpace); carFinal += move; kitchenFinal -= move; overflow -= move; }
        }
      }
    }

    // === Ïó≠Î∞©Ìñ• Ìé∏ÏûÖ: Î∞∞Îã¨ Î∂ÄÏ°± Ïãú Ï£ºÎ∞© Í∞ÄÎä•ÏûêÎ•º Î∞∞Îã¨Î°ú Ìé∏ÏûÖ ===
    // Ïò§ÌÜ†Î∞îÏù¥ min Î∂ÄÏ°± ‚Üí Ï£ºÎ∞©ÏóêÏÑú Ïò§ÌÜ†Î∞îÏù¥ Í∞ÄÎä•Ïûê Ìé∏ÏûÖ
    const bikeMin = limits['Ïò§ÌÜ†Î∞îÏù¥'].min;
    if(bikeFinal < bikeMin && kitchenFinal > limits['Ï£ºÎ∞©'].min){
      // Ìï¥Îãπ ÏãúÍ∞ÑÎåÄ Í∑ºÎ¨¥Ïûê Ï§ë Ïò§ÌÜ†Î∞îÏù¥ Í∞ÄÎä•Ïûê ÌôïÏù∏
      let bikeCapable = 0;
      empKeys.forEach(empId => {
        if(isDayOff(empId, dk)) return;
        const shift = daySchedule[empId];
        if(!shift || !shift.start || !shift.end) return;
        const sMin = timeToMinutesFrom6(shift.start);
        let eMin = timeToMinutesFrom6(shift.end);
        if(eMin <= sMin) eMin += 24*60;
        if(hMin >= sMin && hMin < eMin){
          const caps = employees[empId]?.capabilities || [];
          const roles = shift.role ? shift.role.split(',').filter(Boolean) : [];
          if(caps.includes('Ïò§ÌÜ†Î∞îÏù¥') && !roles.includes('Ïò§ÌÜ†Î∞îÏù¥')) bikeCapable++;
        }
      });
      if(bikeCapable > 0){
        const need = Math.min(bikeMin - bikeFinal, kitchenFinal - limits['Ï£ºÎ∞©'].min, bikeCapable);
        if(need > 0){ bikeFinal += need; kitchenFinal -= need; }
      }
    }
    // Ï∞®Î∞∞Îã¨ min Î∂ÄÏ°±ÎèÑ ÎèôÏùº
    const carMin = limits['Ï∞®Î∞∞Îã¨'].min;
    if(carFinal < carMin && kitchenFinal > limits['Ï£ºÎ∞©'].min){
      let carCapable = 0;
      empKeys.forEach(empId => {
        if(isDayOff(empId, dk)) return;
        const shift = daySchedule[empId];
        if(!shift || !shift.start || !shift.end) return;
        const sMin = timeToMinutesFrom6(shift.start);
        let eMin = timeToMinutesFrom6(shift.end);
        if(eMin <= sMin) eMin += 24*60;
        if(hMin >= sMin && hMin < eMin){
          const caps = employees[empId]?.capabilities || [];
          const roles = shift.role ? shift.role.split(',').filter(Boolean) : [];
          if(caps.includes('Ï∞®Î∞∞Îã¨') && !roles.includes('Ï∞®Î∞∞Îã¨')) carCapable++;
        }
      });
      if(carCapable > 0){
        const need = Math.min(carMin - carFinal, kitchenFinal - limits['Ï£ºÎ∞©'].min, carCapable);
        if(need > 0){ carFinal += need; kitchenFinal -= need; }
      }
    }

    const delivery = carFinal + bikeFinal;
    // Î∞∞Îã¨ÎåÄÌñâ Í∞ÄÏö© Ïó¨Î∂Ä
    const DA_START = timeToMinutesFrom6(pad(preset.daStart||10)+':00');
    const DA_END = timeToMinutesFrom6(pad(preset.daEnd||1)+':00');
    const daAvail = hMin >= DA_START && hMin < DA_END;
    // Î∞∞Îã¨ÎåÄÌñâ Ìè¨Ìï® Ìï©ÏÇ∞
    const deliveryWithDA = delivery + (daAvail && delivery < 1 ? 1 : 0);

    // Ï∂©Îèå Ï≤¥ÌÅ¨ (Ìé∏ÏûÖ ÌõÑ Í∏∞Ï§Ä)
    const carOver = carFinal > limits['Ï∞®Î∞∞Îã¨'].max;
    const bikeOver = bikeFinal > limits['Ïò§ÌÜ†Î∞îÏù¥'].max;
    const kitchenOver = kitchenFinal > limits['Ï£ºÎ∞©'].max;
    const kitchenUnder = kitchenFinal < limits['Ï£ºÎ∞©'].min;

    result[hStr] = {
      kitchen: kitchenFinal, carDel: carFinal, bikeDel: bikeFinal,
      kitchenRaw: kitchen, carRaw: carDel, bikeRaw: bikeDel,
      delivery, deliveryWithDA, total, daAvail, hasBikeWorker,
      carOver, bikeOver, kitchenOver, kitchenUnder
    };
  }
  return result;
}

// ============================================================
// Touch Drag to Create/Edit Shifts
// ============================================================
let dragState = null;

function yToTime(y, totalH){
  const pct = Math.max(0, Math.min(1, y / totalH));
  const totalMin = pct * TL_TOTAL_MINUTES;
  let h = Math.floor(totalMin / 60) + 6;
  if(h >= 24) h -= 24;
  let m = Math.round((totalMin % 60) / 30) * 30;
  if(m >= 60){ m = 0; h = (h+1) >= 24 ? h+1-24 : h+1; }
  return pad(h)+':'+pad(m);
}

function onDragStart(e){
  const col = e.currentTarget;
  const empId = col.dataset.empid;
  if(!empId) return;
  // Tap on existing shift ‚Üí open modal
  if(e.target.closest && e.target.closest('.vt-shift')) return;

  const rect = col.getBoundingClientRect();
  const y = e.touches[0].clientY - rect.top;
  dragState = {
    empId: empId,
    col: col,
    rect: rect,
    startY: y,
    endY: y,
    moved: false,
    preview: null
  };
  // Attach move/end to document for reliable tracking
  document.addEventListener('touchmove', onDragMove, {passive:false});
  document.addEventListener('touchend', onDragEnd, {passive:false});
}

function onDragMove(e){
  if(!dragState) return;
  const touch = e.touches[0];
  if(!touch) return;
  const y = touch.clientY - dragState.rect.top;
  if(Math.abs(y - dragState.startY) > 10) dragState.moved = true;
  if(!dragState.moved) return;
  e.preventDefault();
  e.stopPropagation();
  dragState.endY = y;

  const totalH = dragState.rect.height;
  const topY = Math.max(0, Math.min(dragState.startY, dragState.endY));
  const botY = Math.min(totalH, Math.max(dragState.startY, dragState.endY));
  const topPct = (topY / totalH) * 100;
  const heightPct = Math.max(2, ((botY - topY) / totalH) * 100);

  if(!dragState.preview){
    dragState.preview = document.createElement('div');
    dragState.preview.className = 'vt-drag';
    dragState.col.appendChild(dragState.preview);
  }
  const startTime = yToTime(topY, totalH);
  const endTime = yToTime(botY, totalH);
  dragState.preview.style.top = topPct + '%';
  dragState.preview.style.height = heightPct + '%';
  dragState.preview.textContent = startTime + '~' + endTime;
}

function onDragEnd(e){
  // Always remove document listeners
  document.removeEventListener('touchmove', onDragMove);
  document.removeEventListener('touchend', onDragEnd);

  if(!dragState) return;
  const ds = dragState;
  dragState = null;

  if(ds.preview) ds.preview.remove();

  if(!ds.moved){
    // Tap ‚Üí open modal for this employee
    openShiftModal(ds.empId);
    return;
  }

  const totalH = ds.rect.height;
  const topY = Math.max(0, Math.min(ds.startY, ds.endY));
  const botY = Math.min(totalH, Math.max(ds.startY, ds.endY));

  if(botY - topY < 12) return;

  const startTime = yToTime(topY, totalH);
  const endTime = yToTime(botY, totalH);
  if(startTime === endTime) return;

  const dk = dateKey(currentDate);
  // ÎìúÎûòÍ∑∏ ÏÉùÏÑ± Ïãú Îä•Î†• Í∏∞Î∞ò Í∏∞Î≥∏ Ïó≠Ìï† ÏßÄÏ†ï
  const empName = employees[ds.empId]?.name || '';
  const caps = EMP_CAPABILITIES[empName] || ['Ï£ºÎ∞©'];
  const defaultRole = caps.join(',');
  const data = {start: startTime, end: endTime, role: defaultRole};
  daySchedule[ds.empId] = data;
  lsSaveSchedule(dk, daySchedule);
  renderAll();
  fbPut(FB_SCHEDULES+'/'+dk+'/'+ds.empId, data).then(ok => {
    if(ok){
      showToast(employees[ds.empId].name+' '+startTime+'~'+endTime);
      loadWeekSchedules();
    }
  });
}

// ============================================================
// Hourly Weather (Gemini ‚Üí display in timeline)
// ============================================================
async function loadHourlyWeather(){
  const todayStr = dateStr(new Date());
  const cacheKey = 'ws_hourly_wx';
  const cached = localStorage.getItem(cacheKey);
  if(cached){
    try{
      const c = JSON.parse(cached);
      if(c.date === todayStr && c.data){
        hourlyWeather = {};
        c.data.forEach(w => { hourlyWeather[w.h] = {t:w.t, i:w.i}; });
        return;
      }
    }catch(e){}
  }
  if(!geminiKey) return;
  try{
    const prompt = 'Ïò§Îäò '+todayStr+' Í≤ΩÍ∏∞ÎèÑ Ïù¥Ï≤úÏãú ÏãúÍ∞ÑÎ≥Ñ ÎÇ†Ïî®. JSON Î∞∞Ïó¥Îßå ÏùëÎãµ: [{"h":10,"t":5,"i":"‚òÄ"},{"h":11,"t":6,"i":"‚òÅ"},...] h=Ïãú(10~3Ïãú, Ï†ïÏàò), t=Í∏∞Ïò®(Ï†ïÏàò), i=ÎÇ†Ïî®Ïù¥Î™®ÏßÄ(‚òÄ‚òÅüåßüå®‚ùÑüå´ Ï§ë 1Í∞ú). 10Ïãú~ÏÉàÎ≤Ω3ÏãúÎßå, ÏàúÏàò JSONÎßå(ÎßàÌÅ¨Îã§Ïö¥ Í∏àÏßÄ).';
    const result = await callGemini(prompt);
    const clean = result.replace(/```json\s*/g,'').replace(/```\s*/g,'').trim();
    const arr = JSON.parse(clean);
    if(Array.isArray(arr)){
      hourlyWeather = {};
      arr.forEach(w => { hourlyWeather[w.h] = {t:w.t, i:w.i}; });
      localStorage.setItem(cacheKey, JSON.stringify({date:todayStr, data:arr}));
    }
  }catch(e){ console.error('hourly wx error', e); }
}

function isHourInShift(hour, start, end){
  // Check if 'hour' (e.g., 10) falls within [start, end)
  const hourMin = timeToMinutesFrom6(pad(hour)+':00');
  const startMin = timeToMinutesFrom6(start);
  let endMin = timeToMinutesFrom6(end);
  if(endMin <= startMin) endMin += 24*60;
  return hourMin >= startMin && hourMin < endMin;
}

// ============================================================
// Date Strip (60Ïùº Ïä§ÌÅ¨Î°§ ÎÇ†Ïßú Î∞î)
// ============================================================
function renderDateStrip(){
  const con = $('dateStrip');
  if(!con) return;
  const today = new Date(); today.setHours(0,0,0,0);
  const empKeys = Object.keys(employees);
  const totalEmp = empKeys.length;
  const selectedDk = dateKey(currentDate);
  const DOW_SHORT = ['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'];

  let html = '';
  // -7Ïùº ~ +52Ïùº = 60Ïùº
  for(let i=-7; i<53; i++){
    const d = new Date(today);
    d.setDate(d.getDate()+i);
    const dk = dateKey(d);
    const dow = d.getDay();
    const isToday = i===0;
    const isSelected = dk===selectedDk;

    // ÌôïÏ†ï: confirmedÎßå. auto/pending = ÎØ∏ÌôïÏ†ï
    let confirmedCount = 0;
    let assignedCount = 0;
    const sched = dk===selectedDk ? daySchedule : (weekSchedules[dk] || lsLoadSchedule(dk));
    if(sched){
      empKeys.forEach(eid => {
        if(sched[eid] && sched[eid].start){
          assignedCount++;
          if(getShiftStatus(dk, eid)==='confirmed') confirmedCount++;
        }
      });
    }

    // ÌÖåÎëêÎ¶¨: Ï†ÑÏõêÌôïÏ†ï=Ï¥àÎ°ù, ÏùºÎ∂Ä=Ïó∞Ï¥àÎ°ù, ÏóÜÏùå=ÌöåÏÉâ
    let borderColor = '#2E2E52';
    let statusLabel = '';
    if(assignedCount > 0){
      if(confirmedCount === assignedCount){ borderColor = C_OK; statusLabel = 'ÌôïÏ†ï'; }
      else if(confirmedCount > 0){ borderColor = C_OK+'88'; statusLabel = confirmedCount+'/'+assignedCount; }
      else { borderColor = C_DEF; statusLabel = 'ÎØ∏ÌôïÏ†ï'; }
    }

    const dowCls = dow===0 ? ' sun' : dow===6 ? ' sat' : '';
    const selStyle = isSelected ? 'background:#2A2A45;opacity:1;' : 'opacity:.4;';

    html += '<div class="date-strip-item" data-dk="'+dk+'" style="border-color:'+borderColor+';'+selStyle+'">';
    if(isToday){
      html += '<div class="ds-dow" style="color:'+C_OK+';font-weight:700;">Ïò§Îäò</div>';
    } else {
      html += '<div class="ds-dow">'+DOW_SHORT[dow]+'</div>';
    }
    html += '<div class="ds-date'+dowCls+'">'+d.getDate()+'</div>';
    if(statusLabel) html += '<div style="font-size:.4rem;color:'+borderColor+';font-weight:700;line-height:1;">'+statusLabel+'</div>';
    html += '</div>';
  }
  con.innerHTML = html;

  // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
  con.querySelectorAll('.date-strip-item').forEach(el => {
    el.addEventListener('click', ()=>{
      const parts = el.dataset.dk.split('-');
      currentDate = new Date(parseInt(parts[0]), parseInt(parts[1])-1, parseInt(parts[2]));
      onDateChange();
    });
  });

  // ÏÑ†ÌÉùÎêú ÎÇ†ÏßúÎ•º Ï§ëÏïôÏúºÎ°ú Ïä§ÌÅ¨Î°§
  const sel = con.querySelector('[data-dk="'+selectedDk+'"]');
  if(sel){
    setTimeout(()=>{
      sel.scrollIntoView({inline:'center', behavior:'smooth', block:'nearest'});
    }, 50);
  }
}

// ============================================================
// Week Overview Rendering
// ============================================================
function renderWeek(){
  if(!dataLoaded) return;
  const monday = getMonday(currentDate);
  const empKeys = Object.keys(employees);
  const today = new Date();

  $weekGrid.innerHTML = '';
  const daysOff = {}; // empId -> count of days off

  empKeys.forEach(id => { daysOff[id] = 0; });

  const todayMidnight = new Date(today);
  todayMidnight.setHours(0,0,0,0);

  for(let i=0; i<7; i++){
    const d = new Date(monday);
    d.setDate(d.getDate()+i);
    const dk = dateKey(d);
    const sched = weekSchedules[dk] || {};
    const dow = d.getDay();
    const isCurrentDay = isSameDay(d, currentDate);
    const isTodayDay = isSameDay(d, today);
    const isPast = d < todayMidnight;

    // ÌôïÏ†ï ÏÉÅÌÉú Ï≤¥ÌÅ¨ (auto+confirmed=ÌôïÏ†ï, pendingÎßå ÎØ∏ÌôïÏ†ï)
    let cfCount = 0;
    let scheduledCount = 0;
    empKeys.forEach(empId => {
      if(sched[empId] && sched[empId].start){
        scheduledCount++;
        if(getShiftStatus(dk, empId)==='confirmed') cfCount++;
      } else {
        daysOff[empId] = (daysOff[empId]||0) + 1;
      }
    });
    const allConfirmed = scheduledCount > 0 && cfCount === scheduledCount;
    const borderC = scheduledCount > 0 ? (allConfirmed ? C_OK : (cfCount > 0 ? C_OK+'88' : C_DEF)) : '#2E2E52';

    const cell = document.createElement('div');
    cell.className = 'week-day';
    cell.style.borderColor = borderC;
    if(isCurrentDay) cell.style.background = '#2A2A45';
    if(isPast) cell.style.opacity = '.3';

    const label = document.createElement('div');
    label.className = 'day-label';
    if(isTodayDay){
      label.textContent = 'Ïò§Îäò';
      label.style.color = C_OK;
      label.style.fontWeight = '700';
    } else {
      label.textContent = DOW_KR_SHORT[dow];
    }
    cell.appendChild(label);

    const dateNum = document.createElement('div');
    dateNum.className = 'day-date';
    if(dow === 0) dateNum.classList.add('sun');
    if(dow === 6) dateNum.classList.add('sat');
    dateNum.textContent = d.getDate();
    cell.appendChild(dateNum);

    // Ïù∏ÏõêÏàò + ÌôïÏ†ï ÎπÑÏú®
    if(scheduledCount > 0){
      const cnt = document.createElement('div');
      cnt.className = 'day-count';
      cnt.style.color = allConfirmed ? C_OK : C_DEF;
      cnt.textContent = scheduledCount+'Î™Ö';
      cell.appendChild(cnt);
    }

    cell.addEventListener('click', ()=>{
      currentDate = new Date(d);
      onDateChange();
    });

    $weekGrid.appendChild(cell);
  }

  // Days off summary
  $weekOffs.innerHTML = '';
  empKeys.forEach(empId => {
    const emp = employees[empId];
    if(!emp) return;
    const offCount = daysOff[empId]||0;
    if(offCount === 0) return;
    const chip = document.createElement('div');
    chip.className = 'off-chip';
    chip.innerHTML = '<span class="off-text" style="color:'+C_DEF+';">'+emp.name+' <span style="color:'+C_OFF+';">Ìú¥'+offCount+'</span></span>';
    $weekOffs.appendChild(chip);
  });
}

// ============================================================
// Shift Modal
// ============================================================
let shiftSelectedEmpId = null;
let shiftSelectedRoles = []; // ['Ï£ºÎ∞©'], ['Ï∞®Î∞∞Îã¨'], ['Ïò§ÌÜ†Î∞îÏù¥'], etc
let shiftSelectedStart = null;
let shiftSelectedEnd = null;
let shiftEditMode = false; // editing existing shift

function buildTimeSelects(){
  const $start = $('shiftStartSel');
  const $end = $('shiftEndSel');
  $start.innerHTML = '';
  $end.innerHTML = '';

  // 06:00 ~ 02:30 (30min) for start
  for(let h=6; h<=26; h++){
    const rh = h>=24?h-24:h;
    for(let m=0; m<60; m+=30){
      if(h===26 && m>30) break;
      const t = pad(rh)+':'+pad(m);
      const opt = document.createElement('option');
      opt.value = t; opt.textContent = t;
      $start.appendChild(opt);
    }
  }
  // 06:30 ~ 03:00 for end
  for(let h=6; h<=27; h++){
    const rh = h>=24?h-24:h;
    for(let m=0; m<60; m+=30){
      if(h===6&&m===0) continue;
      if(h===27&&m>0) break;
      const t = pad(rh)+':'+pad(m);
      const opt = document.createElement('option');
      opt.value = t; opt.textContent = t;
      $end.appendChild(opt);
    }
  }

  // sync select ‚Üî gauge
  $start.addEventListener('change', ()=>{
    shiftSelectedStart = $start.value;
    updateShiftGauge();
  });
  $end.addEventListener('change', ()=>{
    shiftSelectedEnd = $end.value;
    updateShiftGauge();
  });

  // Gauge drag
  setupShiftGauge();
}

function selectStartTime(t){
  shiftSelectedStart = t;
  $('shiftStartSel').value = t;
  updateShiftGauge();
}
function selectEndTime(t){
  shiftSelectedEnd = t;
  $('shiftEndSel').value = t;
  updateShiftGauge();
}

function updateShiftGauge(){
  const fill = $('shiftGaugeFill');
  const labels = $('shiftGaugeLabels');
  if(!shiftSelectedStart || !shiftSelectedEnd){ fill.style.display='none'; labels.textContent=''; return; }
  fill.style.display='';
  const left = timeToPercent(shiftSelectedStart);
  const right = timeToPercent(shiftSelectedEnd);
  let width = right - left;
  if(width<=0) width+=100;
  fill.style.left = left+'%';
  fill.style.width = Math.min(width,100-left)+'%';
  const hours = calcHours(shiftSelectedStart, shiftSelectedEnd);
  labels.textContent = shiftSelectedStart+' ~ '+shiftSelectedEnd+' ('+hours+'h)';
}

function setupShiftGauge(){
  const gauge = $('shiftGauge');
  let dragging = null; // 'start' | 'end'
  function xToTime(x){
    const rect = gauge.getBoundingClientRect();
    const pct = Math.max(0, Math.min(1, (x-rect.left)/rect.width));
    const totalMin = pct * TL_TOTAL_MINUTES;
    let h = Math.floor(totalMin/60)+6;
    if(h>=24) h-=24;
    let m = Math.round((totalMin%60)/30)*30;
    if(m>=60){m=0;h=(h+1)>=24?h+1-24:h+1;}
    return pad(h)+':'+pad(m);
  }
  gauge.addEventListener('touchstart', (e)=>{
    const t = xToTime(e.touches[0].clientX);
    // decide if adjusting start or end
    if(!shiftSelectedStart) dragging='start';
    else{
      const tMin = timeToMinutesFrom6(t);
      const sMin = shiftSelectedStart ? timeToMinutesFrom6(shiftSelectedStart) : 0;
      const eMin = shiftSelectedEnd ? timeToMinutesFrom6(shiftSelectedEnd) : TL_TOTAL_MINUTES;
      dragging = Math.abs(tMin-sMin) < Math.abs(tMin-eMin) ? 'start' : 'end';
    }
    const tv = xToTime(e.touches[0].clientX);
    if(dragging==='start') selectStartTime(tv);
    else selectEndTime(tv);
  }, {passive:true});
  gauge.addEventListener('touchmove', (e)=>{
    if(!dragging) return;
    const tv = xToTime(e.touches[0].clientX);
    if(dragging==='start') selectStartTime(tv);
    else selectEndTime(tv);
  }, {passive:true});
  gauge.addEventListener('touchend', ()=>{ dragging=null; });
}

function buildEmpChips(){
  const $chips = $('shiftEmpChips');
  $chips.innerHTML = '';
  Object.keys(employees).forEach(empId => {
    const emp = employees[empId];
    const chip = document.createElement('div');
    chip.className = 'emp-chip';
    if(empId === shiftSelectedEmpId) chip.classList.add('selected');
    chip.innerHTML = '<div class="chip-dot" style="background:'+(emp.color||'#9090A8')+'"></div>'+emp.name;
    chip.addEventListener('click', ()=>{
      shiftSelectedEmpId = empId;
      $chips.querySelectorAll('.emp-chip').forEach(c => c.classList.remove('selected'));
      chip.classList.add('selected');
      // Load existing shift if any
      const existing = daySchedule[empId];
      if(existing && existing.start){
        selectStartTime(existing.start);
        selectEndTime(existing.end);
        shiftSelectedRoles = existing.role ? existing.role.split(',').filter(Boolean) : [];
        updateRolePills();
        $('shiftDelete').style.display = '';
        shiftEditMode = true;
      } else {
        $('shiftDelete').style.display = 'none';
        shiftEditMode = false;
      }
    });
    $chips.appendChild(chip);
  });
}

function updateRolePills(){
  const empName = shiftSelectedEmpId ? (employees[shiftSelectedEmpId]?.name || '') : '';
  const caps = EMP_CAPABILITIES[empName] || ['Ï£ºÎ∞©'];
  document.querySelectorAll('#shiftRolePills .role-pill').forEach(pill => {
    const r = pill.dataset.role;
    pill.classList.toggle('selected', shiftSelectedRoles.includes(r));
    pill.classList.toggle('disabled', !caps.includes(r));
  });
  // Îä•Î†• ÏïàÎÇ¥ ÌëúÏãú
  $('shiftRoleNote').textContent = empName ? '('+empName+': '+caps.map(c=>ROLE_LABELS[c]||c).join('+')+' Í∞ÄÎä•)' : '';
}

// ========== ÎãπÏùº Îß§Ï∂ú ÏòàÏÉÅ ÏÑ§Ï†ï ==========
function saveDailyRevenueMap(){ localStorage.setItem('ws_daily_revenue', JSON.stringify(dailyRevenueMap)); fbPut('/workschedule/daily_revenue', dailyRevenueMap); }

function setDailyRevenue(key){
  const dk = dateKey(currentDate);
  dailyRevenueMap[dk] = key;
  saveDailyRevenueMap();
  staffSettings.hourlyOverrides = null;
  saveStaffSettings();
  renderAll();
}
function clearHourlyOverrides(){
  staffSettings.hourlyOverrides = null;
  saveStaffSettings();
  renderAll();
}
// Íµ¨Í∞Ñ Îß§Ï∂ú Í∏àÏï° ÏàòÏ†ï Î™®Îã¨
function openRevenueEditModal(){
  let overlay = document.getElementById('revenueEditOverlay');
  if(overlay) overlay.remove();
  overlay = document.createElement('div');
  overlay.id = 'revenueEditOverlay';
  overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:9999;display:flex;align-items:center;justify-content:center;';
  // Íµ¨Í∞ÑÎ≥Ñ ÎùºÎ≤® ÏàòÏ†ï
  const presetLabels = JSON.parse(localStorage.getItem('ws_preset_labels') || 'null') || {};
  let h = '<div style="background:#1E1E3A;border-radius:12px;padding:16px;width:85%;max-width:320px;">';
  h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">';
  h += '<span style="font-size:.85rem;font-weight:800;color:#FFD700;">Îß§Ï∂ú Íµ¨Í∞Ñ ÏÑ§Ï†ï</span>';
  h += '<span id="rvClose" style="font-size:1.2rem;color:#707088;cursor:pointer;">&times;</span>';
  h += '</div>';
  h += '<div style="font-size:.55rem;color:#9090A8;margin-bottom:6px;">Íµ¨Í∞ÑÎ™ÖÏùÑ ÏàòÏ†ïÌïòÎ©¥ Î≤ÑÌäº ÎùºÎ≤®Ïù¥ Î≥ÄÍ≤ΩÎê©ÎãàÎã§</div>';
  Object.entries(STAFF_PRESETS).forEach(([key, pre]) => {
    const customLabel = presetLabels[key] || pre.label;
    h += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;padding:6px 8px;background:#242444;border-radius:6px;">';
    h += '<span style="font-size:.6rem;color:#FFD700;font-weight:700;min-width:40px;">'+key+'</span>';
    h += '<input type="text" value="'+customLabel+'" data-rv-key="'+key+'" style="flex:1;background:#1A1A30;border:1px solid #2E2E52;color:#E0E0EC;font-size:.65rem;border-radius:3px;padding:4px 6px;">';
    h += '</div>';
  });
  h += '<div id="rvSaveBtn" style="padding:8px;border-radius:6px;text-align:center;cursor:pointer;font-size:.7rem;font-weight:700;background:#FFD70033;border:1px solid #FFD700;color:#FFD700;margin-top:6px;">Ï†ÄÏû•</div>';
  h += '</div>';
  overlay.innerHTML = h;
  document.body.appendChild(overlay);
  overlay.querySelector('#rvClose').addEventListener('click', ()=> overlay.remove());
  overlay.addEventListener('click', e=>{ if(e.target===overlay) overlay.remove(); });
  overlay.querySelector('#rvSaveBtn').addEventListener('click', ()=>{
    const labels = {};
    overlay.querySelectorAll('[data-rv-key]').forEach(inp => { labels[inp.dataset.rvKey] = inp.value.trim(); });
    localStorage.setItem('ws_preset_labels', JSON.stringify(labels));
    overlay.remove();
    renderAll();
  });
}

// ========== ÏãúÍ∞ÑÎ≥Ñ Ïù∏Ïõê ÏàòÏ†ï ÌåùÏóÖ (Í≤åÏù¥ÏßÄ ÏÖÄ ÌÑ∞Ïπò) ==========
function openHourLimitEdit(hour){
  let overlay = document.getElementById('hourLimitOverlay');
  if(overlay) overlay.remove();
  overlay = document.createElement('div');
  overlay.id = 'hourLimitOverlay';
  overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:9999;display:flex;align-items:center;justify-content:center;';

  const limits = getRoleLimits(hour);
  const roles = [
    {key:'kitchen', roleKey:'Ï£ºÎ∞©', label:'Ï£ºÎ∞©', color:'#E67E22', lim:limits['Ï£ºÎ∞©']},
    {key:'bike', roleKey:'Ïò§ÌÜ†Î∞îÏù¥', label:'Î∞îÏù¥ÌÅ¨', color:'#FFD700', lim:limits['Ïò§ÌÜ†Î∞îÏù¥']},
    {key:'car', roleKey:'Ï∞®Î∞∞Îã¨', label:'Ï∞®', color:'#4ECDC4', lim:limits['Ï∞®Î∞∞Îã¨']},
  ];

  let h = '<div style="background:#1E1E3A;border-radius:12px;padding:16px;width:280px;">';
  h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">';
  h += '<span style="font-size:.9rem;font-weight:800;color:#FFD700;">'+hour+'Ïãú Ïù∏Ïõê ÏÑ§Ï†ï</span>';
  h += '<span id="hlClose" style="font-size:1.2rem;color:#707088;cursor:pointer;">&times;</span>';
  h += '</div>';

  roles.forEach(r => {
    h += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;padding:6px 8px;background:#242444;border-radius:6px;">';
    h += '<span style="font-size:.7rem;font-weight:700;color:'+r.color+';min-width:40px;">'+r.label+'</span>';
    h += '<span style="font-size:.6rem;color:#707088;">ÏµúÏÜå</span>';
    h += '<div style="display:flex;align-items:center;gap:2px;">';
    h += '<span onclick="hlAdj(\''+r.key+'_min\',-1)" style="width:22px;height:22px;display:flex;align-items:center;justify-content:center;background:#1A1A30;border-radius:4px;color:#E0E0EC;font-weight:700;cursor:pointer;">-</span>';
    h += '<input type="number" value="'+r.lim.min+'" min="0" max="9" data-hl="'+r.key+'_min" style="width:28px;background:#1A1A30;border:1px solid #2E2E52;color:#FFD700;text-align:center;font-size:.8rem;border-radius:3px;padding:2px;">';
    h += '<span onclick="hlAdj(\''+r.key+'_min\',1)" style="width:22px;height:22px;display:flex;align-items:center;justify-content:center;background:#1A1A30;border-radius:4px;color:#E0E0EC;font-weight:700;cursor:pointer;">+</span>';
    h += '</div>';
    h += '<span style="font-size:.6rem;color:#707088;">ÏµúÎåÄ</span>';
    h += '<div style="display:flex;align-items:center;gap:2px;">';
    h += '<span onclick="hlAdj(\''+r.key+'_max\',-1)" style="width:22px;height:22px;display:flex;align-items:center;justify-content:center;background:#1A1A30;border-radius:4px;color:#E0E0EC;font-weight:700;cursor:pointer;">-</span>';
    h += '<input type="number" value="'+r.lim.max+'" min="0" max="9" data-hl="'+r.key+'_max" style="width:28px;background:#1A1A30;border:1px solid #2E2E52;color:#FFD700;text-align:center;font-size:.8rem;border-radius:3px;padding:2px;">';
    h += '<span onclick="hlAdj(\''+r.key+'_max\',1)" style="width:22px;height:22px;display:flex;align-items:center;justify-content:center;background:#1A1A30;border-radius:4px;color:#E0E0EC;font-weight:700;cursor:pointer;">+</span>';
    h += '</div>';
    h += '</div>';
  });

  h += '<div style="display:flex;gap:6px;margin-top:8px;">';
  h += '<div onclick="saveHourLimit('+hour+')" style="flex:1;padding:8px;border-radius:6px;text-align:center;cursor:pointer;font-size:.7rem;font-weight:700;background:#FFD70033;border:1px solid #FFD700;color:#FFD700;">Ï†ÄÏû•</div>';
  h += '<div onclick="deleteHourLimit('+hour+')" style="flex:1;padding:8px;border-radius:6px;text-align:center;cursor:pointer;font-size:.7rem;font-weight:700;background:#24244480;border:1px solid #2E2E52;color:#9090A8;">ÌîÑÎ¶¨ÏÖãÎ≥µÍ∑Ä</div>';
  h += '</div>';
  h += '</div>';

  overlay.innerHTML = h;
  document.body.appendChild(overlay);
  overlay.querySelector('#hlClose').onclick = ()=> overlay.remove();
  overlay.addEventListener('click', e=>{ if(e.target===overlay) overlay.remove(); });
}
function hlAdj(key, delta){
  const inp = document.querySelector('[data-hl="'+key+'"]');
  if(inp){ inp.value = Math.max(0, Math.min(9, parseInt(inp.value||'0')+delta)); }
}
function saveHourLimit(hour){
  const g = (k) => parseInt(document.querySelector('[data-hl="'+k+'"]')?.value||'0');
  if(!staffSettings.hourlyOverrides) staffSettings.hourlyOverrides = {};
  staffSettings.hourlyOverrides[hour] = {
    kitchen:{min:g('kitchen_min'),max:g('kitchen_max')},
    bike:{min:g('bike_min'),max:g('bike_max')},
    car:{min:g('car_min'),max:g('car_max')},
  };
  saveStaffSettings();
  document.getElementById('hourLimitOverlay')?.remove();
  renderAll();
}
function deleteHourLimit(hour){
  if(staffSettings.hourlyOverrides){ delete staffSettings.hourlyOverrides[hour]; if(!Object.keys(staffSettings.hourlyOverrides).length) staffSettings.hourlyOverrides = null; }
  saveStaffSettings();
  document.getElementById('hourLimitOverlay')?.remove();
  renderAll();
}

// ========== Í∏∞Ï°¥ Ìò∏ÌôòÏö© ==========
function openStaffSettingsModal(){ /* Í≤åÏù¥ÏßÄ ÏÖÄ ÌÑ∞ÏπòÎ°ú ÎåÄÏ≤¥Îê® */ }
function applyStaffPreset(key){ setDailyRevenue(key); }
function resetStaffToPreset(){ clearHourlyOverrides(); }

function openShiftModal(empId){
  shiftSelectedEmpId = empId || null;
  shiftSelectedRoles = [];
  shiftSelectedStart = null;
  shiftSelectedEnd = null;
  shiftEditMode = false;

  buildEmpChips();

  // If empId provided and has existing shift, load it
  if(empId && daySchedule[empId] && daySchedule[empId].start){
    const shift = daySchedule[empId];
    shiftSelectedRoles = shift.role ? shift.role.split(',').filter(Boolean) : [];
    shiftEditMode = true;
    selectStartTime(shift.start);
    selectEndTime(shift.end);
    $('shiftDelete').style.display = '';
  } else {
    $('shiftStartSel').selectedIndex = 0;
    $('shiftEndSel').selectedIndex = 0;
    updateShiftGauge();
    $('shiftDelete').style.display = 'none';
  }

  updateRolePills();

  const m = currentDate.getMonth()+1;
  const d = currentDate.getDate();
  const dow = DOW_KR[currentDate.getDay()];
  const empName = empId ? (employees[empId]?.name||'') : '';
  $('shiftTitle').textContent = 'Í∑ºÎ¨¥ ' + (shiftEditMode ? 'ÏàòÏ†ï' : 'Ï∂îÍ∞Ä') + ' - ' + m+'/'+d+' ('+dow+')';

  // Í≥†Ï†ï/Ìú¥Î¨¥ Î≤ÑÌäº ÌëúÏãú
  $('shiftSaveFixed').style.display = empId ? '' : 'none';
  $('shiftDayoff').style.display = empId ? '' : 'none';
  // Ìú¥Î¨¥ ÏÉÅÌÉúÎ©¥ Î≤ÑÌäºÏùÑ "Ìú¥Î¨¥Ìï¥Ï†ú"Î°ú Î≥ÄÍ≤Ω
  const isOff = empId && isDayOff(empId, dateKey(currentDate));
  if(isOff){
    $('shiftDayoff').textContent = 'Ìú¥Î¨¥Ìï¥Ï†ú';
    $('shiftDayoff').classList.remove('btn-danger');
    $('shiftDayoff').style.background = '#333';
    $('shiftDayoff').style.color = '#9090A8';
  } else {
    $('shiftDayoff').textContent = 'Ìú¥Î¨¥ÏßÄÏ†ï';
    $('shiftDayoff').classList.add('btn-danger');
    $('shiftDayoff').style.background = '';
    $('shiftDayoff').style.color = '';
  }

  openModal($shiftModal);
}

// Role pill clicks (multi-select toggle)
document.querySelectorAll('#shiftRolePills .role-pill').forEach(pill => {
  pill.addEventListener('click', ()=>{
    if(pill.classList.contains('disabled')) return;
    const r = pill.dataset.role;
    const idx = shiftSelectedRoles.indexOf(r);
    if(idx >= 0) shiftSelectedRoles.splice(idx, 1);
    else shiftSelectedRoles.push(r);
    updateRolePills();
  });
});

// Presets
document.querySelectorAll('#shiftPresets .preset-btn').forEach(btn => {
  btn.addEventListener('click', ()=>{
    selectStartTime(btn.dataset.start);
    selectEndTime(btn.dataset.end);
  });
});

// Save shift
$('shiftSave').addEventListener('click', async()=>{
  if(!shiftSelectedEmpId){
    showToast('ÏßÅÏõêÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî');
    return;
  }
  if(!shiftSelectedStart || !shiftSelectedEnd){
    showToast('ÏãúÍ∞ÑÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî');
    return;
  }
  const dk = dateKey(currentDate);
  const data = {
    start: shiftSelectedStart,
    end: shiftSelectedEnd,
    role: shiftSelectedRoles.join(',')
  };

  closeModal($shiftModal);

  // Optimistic update ‚Äî localStorage first
  daySchedule[shiftSelectedEmpId] = data;
  lsSaveSchedule(dk, daySchedule);
  // ÏàòÎèô Ï†ÄÏû• = ÌôïÏ†ï Ï≤òÎ¶¨
  setShiftStatus(dk, shiftSelectedEmpId, 'confirmed');
  renderAll();

  const ok = await fbPut(FB_SCHEDULES+'/'+dk+'/'+shiftSelectedEmpId, data);
  if(ok){
    showToast('Ï†ÄÏû• ÌôïÏ†ï');
    loadWeekSchedules();
  } else {
    showToast('Î°úÏª¨ Ï†ÄÏû•Îê® (ÏÑúÎ≤Ñ ÎèôÍ∏∞Ìôî ÎåÄÍ∏∞)');
  }
});

// Delete shift
$('shiftDelete').addEventListener('click', async()=>{
  if(!shiftSelectedEmpId) return;
  const dk = dateKey(currentDate);

  closeModal($shiftModal);

  // Optimistic ‚Äî localStorage first
  delete daySchedule[shiftSelectedEmpId];
  lsSaveSchedule(dk, daySchedule);
  renderAll();

  const ok = await fbDelete(FB_SCHEDULES+'/'+dk+'/'+shiftSelectedEmpId);
  if(ok){
    showToast('ÏÇ≠Ï†úÎê®');
    loadWeekSchedules();
  }
});

// "Í≥†Ï†ïÏúºÎ°ú Ï†ÄÏû•" ‚Äî FIXED_SCHEDULES ÏóÖÎç∞Ïù¥Ìä∏ + Firebase Ï†ÄÏû•
$('shiftSaveFixed').addEventListener('click', async()=>{
  if(!shiftSelectedEmpId || !shiftSelectedStart || !shiftSelectedEnd){
    showToast('ÏãúÍ∞ÑÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî');
    return;
  }
  const empName = employees[shiftSelectedEmpId]?.name;
  if(!empName){ showToast('ÏßÅÏõê Ïò§Î•ò'); return; }

  const newFixed = {start:shiftSelectedStart, end:shiftSelectedEnd, role:shiftSelectedRoles.join(','), type:'fixed'};
  // Î°úÏª¨ FIXED_SCHEDULES ÏóÖÎç∞Ïù¥Ìä∏
  FIXED_SCHEDULES[empName] = newFixed;
  // FirebaseÏóê Ï†ÄÏû• (Í≥†Ï†ïÍ∞í ÏòÅÍµ¨ Î≥¥Ï°¥)
  fbPut('/workschedule/fixed_schedules/'+encodeURIComponent(empName), newFixed);
  // localStorage Ï∫êÏãú
  try{ localStorage.setItem('ws_fixed_schedules', JSON.stringify(FIXED_SCHEDULES)); }catch(e){}

  // ÎãπÏùº Ïä§ÏºÄÏ§ÑÏóêÎèÑ Ï†ÅÏö©
  const dk = dateKey(currentDate);
  const data = {start:shiftSelectedStart, end:shiftSelectedEnd, role:shiftSelectedRoles.join(',')};
  daySchedule[shiftSelectedEmpId] = data;
  lsSaveSchedule(dk, daySchedule);
  setShiftStatus(dk, shiftSelectedEmpId, 'confirmed');

  closeModal($shiftModal);
  await fbPut(FB_SCHEDULES+'/'+dk+'/'+shiftSelectedEmpId, data);
  showToast(empName+' Í≥†Ï†ïÍ∞í Î≥ÄÍ≤ΩÎê®');
  renderAll();
  loadWeekSchedules();
});

// ÏàòÏ†ï ÌåùÏóÖÏóêÏÑú Ìú¥Î¨¥ ÏßÄÏ†ï
$('shiftDayoff').addEventListener('click', ()=>{
  if(!shiftSelectedEmpId) return;
  const dk = dateKey(currentDate);
  const isOff = isDayOff(shiftSelectedEmpId, dk);
  if(isOff){
    // Ìú¥Î¨¥ Ìï¥Ï†ú (false = ÏàòÎèôÌï¥Ï†ú ÌëúÏãú, ÏûêÎèôÏÉùÏÑ± Î∞©ÏßÄ)
    if(!dayoffs[shiftSelectedEmpId]) dayoffs[shiftSelectedEmpId] = {};
    dayoffs[shiftSelectedEmpId][dk] = false;
    lsSaveDayoffs();
    fbPut(FB_DAYOFFS+'/'+shiftSelectedEmpId+'/'+dk, false);
    // dayoff ÌîåÎûòÍ∑∏ Ïä§ÏºÄÏ§Ñ ÏÇ≠Ï†ú
    if(daySchedule[shiftSelectedEmpId] && daySchedule[shiftSelectedEmpId].dayoff){
      delete daySchedule[shiftSelectedEmpId];
    }
    // Í≥†Ï†ïÏä§ÏºÄÏ§Ñ Ïû¨Ï†ÅÏö©
    const empName = employees[shiftSelectedEmpId]?.name || '';
    const fix = FIXED_SCHEDULES[empName];
    if(fix && fix.type==='fixed' && fix.start){
      daySchedule[shiftSelectedEmpId] = {start:fix.start, end:fix.end, role:fix.role};
      fbPut(FB_SCHEDULES+'/'+dk+'/'+shiftSelectedEmpId, daySchedule[shiftSelectedEmpId]);
    }
    lsSaveSchedule(dk, daySchedule);
    closeModal($shiftModal);
    showToast('Ìú¥Î¨¥ Ìï¥Ï†ú');
  } else {
    // Ìú¥Î¨¥ ÏßÄÏ†ï
    if(!dayoffs[shiftSelectedEmpId]) dayoffs[shiftSelectedEmpId] = {};
    dayoffs[shiftSelectedEmpId][dk] = true;
    if(daySchedule[shiftSelectedEmpId]){
      delete daySchedule[shiftSelectedEmpId];
      lsSaveSchedule(dk, daySchedule);
      fbDelete(FB_SCHEDULES+'/'+dk+'/'+shiftSelectedEmpId);
    }
    lsSaveDayoffs();
    fbPut(FB_DAYOFFS+'/'+shiftSelectedEmpId+'/'+dk, true);
    closeModal($shiftModal);
    showToast('Ìú¥Î¨¥ ÏßÄÏ†ï');
  }
  renderAll();
});

$('shiftCancel').addEventListener('click',()=> closeModal($shiftModal));
$('shiftModalClose').addEventListener('click',()=> closeModal($shiftModal));

// ============================================================
// Month View Modal
// ============================================================
if($('monthViewBtn')) $('monthViewBtn').addEventListener('click', ()=>{
  monthViewYear = currentDate.getFullYear();
  monthViewMonth = currentDate.getMonth()+1;
  renderMonthView();
  openModal($monthModal);
});
$('monthModalClose').addEventListener('click', ()=> closeModal($monthModal));
$('monthPrev').addEventListener('click', ()=>{
  monthViewMonth--;
  if(monthViewMonth < 1){ monthViewMonth=12; monthViewYear--; }
  renderMonthView();
});
$('monthNext').addEventListener('click', ()=>{
  monthViewMonth++;
  if(monthViewMonth > 12){ monthViewMonth=1; monthViewYear++; }
  renderMonthView();
});

async function renderMonthView(){
  $('monthModalLabel').textContent = monthViewYear+'ÎÖÑ '+monthViewMonth+'Ïõî';
  const grid = $('monthGrid');
  grid.innerHTML = '';

  // DOW labels
  DOW_KR_SHORT.forEach(d => {
    const label = document.createElement('div');
    label.className = 'month-dow-label';
    label.textContent = d;
    grid.appendChild(label);
  });

  const days = daysInMonth(monthViewYear, monthViewMonth);
  const firstDow = new Date(monthViewYear, monthViewMonth-1, 1).getDay();
  const today = new Date();

  // Load month schedule counts
  const monthData = {};
  const promises = [];
  const dateKeys = [];
  for(let d=1; d<=days; d++){
    const dk = monthViewYear+'-'+pad(monthViewMonth)+'-'+pad(d);
    dateKeys.push({dk, d});
  }

  // Fetch all days in parallel (batch ‚Äî just fetch the whole month folder)
  const monthFolder = await fbGet(FB_SCHEDULES);
  const allSchedules = monthFolder || {};

  // Empty cells before first day
  for(let i=0; i<firstDow; i++){
    const cell = document.createElement('div');
    cell.className = 'month-day-cell empty';
    grid.appendChild(cell);
  }

  for(let d=1; d<=days; d++){
    const dk = monthViewYear+'-'+pad(monthViewMonth)+'-'+pad(d);
    const daySched = allSchedules[dk] || {};
    const count = Object.keys(daySched).filter(k => daySched[k] && daySched[k].start).length;
    const dow = new Date(monthViewYear, monthViewMonth-1, d).getDay();
    const isToday2 = (today.getFullYear()===monthViewYear && (today.getMonth()+1)===monthViewMonth && today.getDate()===d);

    const cell = document.createElement('div');
    cell.className = 'month-day-cell';
    if(isToday2) cell.classList.add('today');
    if(count > 0) cell.classList.add('has-staff');

    const num = document.createElement('div');
    num.className = 'md-num';
    if(dow === 0) num.classList.add('sun');
    if(dow === 6) num.classList.add('sat');
    num.textContent = d;
    cell.appendChild(num);

    if(count > 0){
      const cnt = document.createElement('div');
      cnt.className = 'md-count';
      cnt.textContent = count+'Î™Ö';
      cell.appendChild(cnt);
    }

    cell.addEventListener('click', ()=>{
      currentDate = new Date(monthViewYear, monthViewMonth-1, d);
      closeModal($monthModal);
      onDateChange();
    });

    grid.appendChild(cell);
  }
}

// ============================================================
// Employee Management Modal
// ============================================================
$('empMgrBtn').addEventListener('click', ()=>{
  renderEmpList();
  openModal($empModal);
});
$('empModalClose').addEventListener('click', ()=> closeModal($empModal));

function renderEmpList(){
  const $list = $('empList');
  $list.innerHTML = '';
  const empKeys = Object.keys(employees);
  if(empKeys.length === 0){
    $list.innerHTML = '<div style="padding:20px;text-align:center;color:#9090A8;">Îì±Î°ùÎêú ÏßÅÏõêÏù¥ ÏóÜÏäµÎãàÎã§</div>';
    return;
  }
  empKeys.forEach(id => {
    const emp = employees[id];
    const item = document.createElement('div');
    item.className = 'emp-list-item';
    const roleText = emp.role || 'ÎØ∏ÏßÄÏ†ï';
    const rateText = emp.hourlyRate ? emp.hourlyRate.toLocaleString()+'Ïõê' : '-';
    item.innerHTML =
      '<div class="emp-dot" style="background:'+(emp.color||'#9090A8')+'"></div>'+
      '<div class="emp-info">'+
        '<div class="name">'+emp.name+'</div>'+
        '<div class="detail">'+(emp.phone||'Ï†ÑÌôîÏóÜÏùå')+' | '+roleText+' | '+rateText+'</div>'+
      '</div>'+
      '<div class="emp-list-actions">'+
        '<button class="btn btn-sm" data-edit="'+id+'">ÏàòÏ†ï</button>'+
        '<button class="btn btn-sm btn-danger" data-del="'+id+'">ÏÇ≠Ï†ú</button>'+
      '</div>';
    $list.appendChild(item);
  });

  $list.querySelectorAll('[data-edit]').forEach(btn => {
    btn.addEventListener('click', ()=> openEmpEdit(btn.dataset.edit));
  });
  $list.querySelectorAll('[data-del]').forEach(btn => {
    btn.addEventListener('click', async()=>{
      if(!confirm(employees[btn.dataset.del].name+' ÏÇ≠Ï†ú?')) return;
      const ok = await fbDelete(FB_EMPLOYEES+'/'+btn.dataset.del);
      if(ok){
        delete employees[btn.dataset.del];
        renderEmpList();
        renderAll();
        showToast('ÏÇ≠Ï†úÎê®');
      }
    });
  });
}

// ============================================================
// Employee Edit Modal
// ============================================================
const PRESET_COLORS = [
  '#FF6B6B','#4ECDC4','#45B7D1','#96CEB4',
  '#FFEAA7','#DDA0DD','#F0A500','#6C5CE7',
  '#A8E6CF','#FF8A5C','#EA80FC','#00BCD4'
];
let editingEmpId = null;
let selectedColor = PRESET_COLORS[0];

function buildColorPicker(){
  const $cp = $('colorPicker');
  $cp.innerHTML = '';
  PRESET_COLORS.forEach(c => {
    const sw = document.createElement('div');
    sw.className = 'color-swatch' + (c === selectedColor ? ' selected' : '');
    sw.style.background = c;
    sw.addEventListener('click', ()=>{
      selectedColor = c;
      $cp.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
      sw.classList.add('selected');
    });
    $cp.appendChild(sw);
  });
}

function openEmpEdit(id){
  editingEmpId = id;
  if(id && employees[id]){
    const emp = employees[id];
    $('empEditTitle').textContent = 'ÏßÅÏõê ÏàòÏ†ï';
    $('empName').value = emp.name || '';
    $('empPhone').value = emp.phone || '';
    $('empRole').value = emp.role || '';
    $('empHourlyRate').value = emp.hourlyRate || 0;
    $('empMaxHours').value = emp.maxHours || 40;
    selectedColor = emp.color || PRESET_COLORS[0];
  } else {
    editingEmpId = null;
    $('empEditTitle').textContent = 'ÏßÅÏõê Ï∂îÍ∞Ä';
    $('empName').value = '';
    $('empPhone').value = '';
    $('empRole').value = '';
    $('empHourlyRate').value = 0;
    $('empMaxHours').value = 40;
    selectedColor = PRESET_COLORS[0];
  }
  buildColorPicker();
  openModal($empEditModal);
}

$('addEmpBtn').addEventListener('click', ()=> openEmpEdit(null));
$('empEditClose').addEventListener('click', ()=> closeModal($empEditModal));
$('empEditCancel').addEventListener('click', ()=> closeModal($empEditModal));

$('empEditSave').addEventListener('click', async()=>{
  const name = $('empName').value.trim();
  if(!name){ showToast('Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî'); return; }
  const data = {
    name: name,
    phone: $('empPhone').value.trim(),
    color: selectedColor,
    role: $('empRole').value,
    hourlyRate: parseInt($('empHourlyRate').value) || 0,
    maxHours: parseInt($('empMaxHours').value) || 40
  };
  let id = editingEmpId;
  if(!id) id = 'emp' + Date.now();
  closeModal($empEditModal);
  employees[id] = data;
  lsSaveEmployees(employees);
  renderEmpList();
  renderAll();
  const ok = await fbPut(FB_EMPLOYEES+'/'+id, data);
  if(ok) showToast('Ï†ÄÏû•Îê®');
  else showToast('Î°úÏª¨ Ï†ÄÏû•Îê®');
});

// ============================================================
// Day-off (Ìú¥Î¨¥) Management
// ============================================================
const LS_DAYOFFS = 'ws_dayoffs';
const FB_DAYOFFS = FB_WS + '/dayoffs';
let dayoffs = {}; // {empId: {yyyy-MM-dd: true, ...}, ...}

function lsSaveDayoffs(){ try{ localStorage.setItem(LS_DAYOFFS, JSON.stringify(dayoffs)); }catch(e){} }
function lsLoadDayoffs(){ try{ const s = localStorage.getItem(LS_DAYOFFS); return s ? JSON.parse(s) : null; }catch(e){ return null; } }

function isDayOff(empId, dk){
  return dayoffs[empId] && dayoffs[empId][dk];
}

function getDayOffEmployees(dk){
  const result = [];
  for(const empId in dayoffs){
    if(dayoffs[empId][dk]) result.push(empId);
  }
  return result;
}

async function loadDayoffs(){
  const local = lsLoadDayoffs();
  if(local) dayoffs = local;
  try{
    const fb = await fbGet(FB_DAYOFFS);
    if(fb){
      // Î≥ëÌï©: Î°úÏª¨ Ïö∞ÏÑ†
      for(const empId in fb){
        if(!dayoffs[empId]) dayoffs[empId] = {};
        for(const dk in fb[empId]){
          if(dayoffs[empId][dk] === undefined) dayoffs[empId][dk] = fb[empId][dk];
        }
      }
      lsSaveDayoffs();
    }
  }catch(e){ console.error('loadDayoffs error', e); }
}

// Îß§Ï£º Î∞òÎ≥µ Ìú¥Î¨¥ (ÏöîÏùº Í∏∞Î∞ò) + ÌäπÏ†ï Í∏∞Í∞Ñ Ìú¥Î¨¥ ÏûêÎèô ÏÉùÏÑ±
// Ïõî=1, Ìôî=2, ..., Ïùº=0
const WEEKLY_DAYOFFS = {
  'Î¶¨': [1],     // Îß§Ï£º ÏõîÏöîÏùº
  'ÌûàÏò§': [2],   // Îß§Ï£º ÌôîÏöîÏùº
};

// ÌäπÏ†ï Í∏∞Í∞Ñ Ìú¥Î¨¥
const PERIOD_DAYOFFS = [
  {name:'Í∂åÏó∞Ïò•', from:'2026-02-24', to:'2026-03-08'},
];

// ÌäπÏ†ï ÎÇ†Ïßú Ìú¥Î¨¥
const SPECIFIC_DAYOFFS = [
  {name:'Î∞ïÏ§ÄÎ™®', date:'2026-02-26'}, // Ïù¥Î≤àÏ£º ÏàòÏöîÏùº
  {name:'Ï†ÑÎ¨òÏ†ï', date:'2026-02-26'}, // Ïù¥Î≤àÏ£º ÏàòÏöîÏùº
];

function generateAutoDayoffs(){
  let changed = false;
  const today = new Date();
  // 8Ï£º ÏïûÍπåÏßÄ ÏûêÎèô ÏÉùÏÑ±
  for(let i=0; i<56; i++){
    const d = new Date(today);
    d.setDate(d.getDate()+i);
    const dk = dateKey(d);
    const dow = d.getDay();

    // Îß§Ï£º Î∞òÎ≥µ Ìú¥Î¨¥ (ÏàòÎèô Ìï¥Ï†ú=false ÌëúÏãúÎêú Í±¥ Í±¥ÎìúÎ¶¨ÏßÄ ÏïäÏùå)
    for(const empName in WEEKLY_DAYOFFS){
      if(WEEKLY_DAYOFFS[empName].includes(dow)){
        const empId = findEmpIdByName(empName);
        if(empId){
          if(!dayoffs[empId]) dayoffs[empId] = {};
          if(dayoffs[empId][dk] === undefined){
            dayoffs[empId][dk] = true;
            changed = true;
          }
        }
      }
    }
  }

  // Í∏∞Í∞Ñ Ìú¥Î¨¥
  PERIOD_DAYOFFS.forEach(pd => {
    const empId = findEmpIdByName(pd.name);
    if(!empId) return;
    if(!dayoffs[empId]) dayoffs[empId] = {};
    const from = new Date(pd.from), to = new Date(pd.to);
    for(let d = new Date(from); d <= to; d.setDate(d.getDate()+1)){
      const dk = dateKey(d);
      if(dayoffs[empId][dk] === undefined){
        dayoffs[empId][dk] = true;
        changed = true;
      }
    }
  });

  // ÌäπÏ†ï ÎÇ†Ïßú Ìú¥Î¨¥
  SPECIFIC_DAYOFFS.forEach(sd => {
    const empId = findEmpIdByName(sd.name);
    if(!empId) return;
    if(!dayoffs[empId]) dayoffs[empId] = {};
    if(dayoffs[empId][sd.date] === undefined){
      dayoffs[empId][sd.date] = true;
      changed = true;
    }
  });

  if(changed) lsSaveDayoffs();
  return changed;
}

async function addDayOff(empId, dk){
  if(!dayoffs[empId]) dayoffs[empId] = {};
  dayoffs[empId][dk] = true;
  lsSaveDayoffs();
  // Ìï¥Îãπ ÎÇ†Ïßú Ïä§ÏºÄÏ§ÑÏóê Ìú¥Î¨¥ ÎßàÌÇπ
  const schedKey = dateKey(currentDate);
  if(dk === schedKey){
    daySchedule[empId] = {start:'', end:'', role:'Ìú¥Î¨¥', dayoff:true};
    lsSaveSchedule(schedKey, daySchedule);
    renderAll();
  }
  fbPut(FB_DAYOFFS+'/'+empId+'/'+dk, true);
}

async function removeDayOff(empId, dk){
  if(dayoffs[empId]) delete dayoffs[empId][dk];
  lsSaveDayoffs();
  const schedKey = dateKey(currentDate);
  if(dk === schedKey && daySchedule[empId] && daySchedule[empId].dayoff){
    delete daySchedule[empId];
    lsSaveSchedule(schedKey, daySchedule);
    renderAll();
  }
  fbDelete(FB_DAYOFFS+'/'+empId+'/'+dk);
}

// Parse bulk dayoff input (Ïó¨Îü¨ ÌòïÌÉú ÏßÄÏõê)
function parseBulkDayoffs(text){
  const results = [];
  const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
  const now = new Date();
  const thisYear = now.getFullYear();
  const thisMonth = now.getMonth() + 1;

  for(const line of lines){
    // ÏßÅÏõêÏù¥Î¶Ñ Ï∞æÍ∏∞
    let matchedEmpId = null;
    let matchedName = '';
    let restText = line;
    for(const empId in employees){
      const name = employees[empId].name;
      if(line.startsWith(name)){
        matchedEmpId = empId;
        matchedName = name;
        restText = line.slice(name.length).trim();
        break;
      }
    }
    if(!matchedEmpId) continue;

    // ÏöîÏùº Ï≤òÎ¶¨ (Ìôî,Î™© ‚Üí Ïù¥Î≤àÏ£º Ìï¥Îãπ ÏöîÏùº)
    const dowMap = {'Ïùº':0,'Ïõî':1,'Ìôî':2,'Ïàò':3,'Î™©':4,'Í∏à':5,'ÌÜ†':6};
    const dowPattern = restText.match(/^([ÏùºÏõîÌôîÏàòÎ™©Í∏àÌÜ†])([,\s]+[ÏùºÏõîÌôîÏàòÎ™©Í∏àÌÜ†])*/);
    if(dowPattern){
      const dows = restText.match(/[ÏùºÏõîÌôîÏàòÎ™©Í∏àÌÜ†]/g);
      if(dows){
        const mon = getMonday(now);
        dows.forEach(d => {
          const target = dowMap[d];
          if(target !== undefined){
            const dt = new Date(mon);
            dt.setDate(dt.getDate() + (target === 0 ? 6 : target - 1));
            results.push({empId: matchedEmpId, date: dateKey(dt)});
          }
        });
      }
      continue;
    }

    // Î≤îÏúÑ Ï≤òÎ¶¨ (M/D~M/D ÎòêÎäî M/D-M/D)
    const rangeMatch = restText.match(/(\d{1,2})[\/\-](\d{1,2})\s*[~\-]\s*(\d{1,2})[\/\-](\d{1,2})/);
    if(rangeMatch){
      let [,m1,d1,m2,d2] = rangeMatch.map(Number);
      const start = new Date(thisYear, m1-1, d1);
      const end = new Date(thisYear, m2-1, d2);
      for(let d = new Date(start); d <= end; d.setDate(d.getDate()+1)){
        results.push({empId: matchedEmpId, date: dateKey(d)});
      }
      continue;
    }

    // yyyy-MM-dd ÌòïÌÉú
    const isoMatch = restText.match(/(\d{4})-(\d{1,2})-(\d{1,2})/g);
    if(isoMatch){
      isoMatch.forEach(ds => {
        const [y,m,d] = ds.split('-').map(Number);
        results.push({empId: matchedEmpId, date: y+'-'+pad(m)+'-'+pad(d)});
      });
      continue;
    }

    // M/D, M/D ÏΩ§Îßà Íµ¨Î∂Ñ
    const slashDates = restText.match(/(\d{1,2})[\/](\d{1,2})/g);
    if(slashDates && slashDates.length > 0){
      slashDates.forEach(ds => {
        const [m,d] = ds.split('/').map(Number);
        results.push({empId: matchedEmpId, date: thisYear+'-'+pad(m)+'-'+pad(d)});
      });
      continue;
    }

    // M-D ÏΩ§Îßà Íµ¨Î∂Ñ
    const dashDates = restText.match(/(\d{1,2})-(\d{1,2})/g);
    if(dashDates && dashDates.length > 0){
      dashDates.forEach(ds => {
        const [m,d] = ds.split('-').map(Number);
        results.push({empId: matchedEmpId, date: thisYear+'-'+pad(m)+'-'+pad(d)});
      });
    }
  }
  return results;
}

// Render dayoff modal
const $dayoffModal = $('dayoffModal');

function renderDayoffList(){
  const list = $('dayoffList');
  const select = $('dayoffEmpSelect');

  // populate employee select
  select.innerHTML = '';
  for(const empId in employees){
    const opt = document.createElement('option');
    opt.value = empId;
    opt.textContent = employees[empId].name;
    select.appendChild(opt);
  }

  // Set default date
  $('dayoffDate').value = dateKey(currentDate);

  // Render list grouped by date (upcoming first)
  const allEntries = [];
  for(const empId in dayoffs){
    for(const dk in dayoffs[empId]){
      if(dayoffs[empId][dk]) allEntries.push({empId, date:dk});
    }
  }
  allEntries.sort((a,b) => a.date.localeCompare(b.date));

  if(allEntries.length === 0){
    list.innerHTML = '<div style="color:#707088;font-size:.8rem;padding:8px;">Îì±Î°ùÎêú Ìú¥Î¨¥Í∞Ä ÏóÜÏäµÎãàÎã§</div>';
    return;
  }

  let html = '';
  let lastDate = '';
  for(const entry of allEntries){
    if(entry.date !== lastDate){
      const d = new Date(entry.date);
      const dow = DOW_KR[d.getDay()];
      html += '<div style="font-size:.75rem;color:#9090A8;margin-top:8px;margin-bottom:2px;">'+entry.date+' ('+dow+')</div>';
      lastDate = entry.date;
    }
    const emp = employees[entry.empId];
    const name = emp ? emp.name : entry.empId;
    const color = emp ? emp.color : '#9090A8';
    html += '<div style="display:flex;align-items:center;gap:6px;padding:4px 8px;background:#1A1A30;border-radius:6px;margin-bottom:3px;">';
    html += '<span style="width:8px;height:8px;border-radius:50%;background:'+color+';flex-shrink:0;"></span>';
    html += '<span style="flex:1;font-size:.85rem;">'+name+'</span>';
    html += '<button class="btn btn-sm" style="min-width:30px;min-height:26px;padding:2px 6px;font-size:.7rem;color:#E74C3C;border-color:#E74C3C55;" data-dayoff-del="'+entry.empId+'|'+entry.date+'">‚úï</button>';
    html += '</div>';
  }
  list.innerHTML = html;

  // Delete buttons
  list.querySelectorAll('[data-dayoff-del]').forEach(btn => {
    btn.addEventListener('click', async ()=>{
      const [empId, dk] = btn.dataset.dayoffDel.split('|');
      await removeDayOff(empId, dk);
      renderDayoffList();
    });
  });
}

$('dayoffMgrBtn').addEventListener('click', ()=>{
  renderDayoffList();
  openModal($dayoffModal);
});
$('dayoffModalClose').addEventListener('click', ()=> closeModal($dayoffModal));
$dayoffModal.addEventListener('click', (e)=>{ if(e.target === $dayoffModal) closeModal($dayoffModal); });

// Single add
$('dayoffAddBtn').addEventListener('click', async ()=>{
  const empId = $('dayoffEmpSelect').value;
  const dk = $('dayoffDate').value;
  if(!empId || !dk) return;
  await addDayOff(empId, dk);
  showToast((employees[empId]?.name||'')+' '+dk+' Ìú¥Î¨¥ Îì±Î°ù');
  renderDayoffList();
});

// Bulk add
$('dayoffBulkBtn').addEventListener('click', async ()=>{
  const text = $('dayoffBulkInput').value.trim();
  if(!text) return;
  const entries = parseBulkDayoffs(text);
  if(entries.length === 0){
    showToast('Ïù∏ÏãùÎêú Ìú¥Î¨¥Í∞Ä ÏóÜÏäµÎãàÎã§');
    return;
  }
  for(const e of entries){
    await addDayOff(e.empId, e.date);
  }
  $('dayoffBulkInput').value = '';
  showToast(entries.length+'Í±¥ Ìú¥Î¨¥ Îì±Î°ù ÏôÑÎ£å');
  renderDayoffList();
});

// ============================================================
// Day Navigation
// ============================================================
// 1Ïùº Ïù¥Îèô
$('prevDay1').addEventListener('click', ()=>{
  currentDate.setDate(currentDate.getDate()-1);
  onDateChange();
});
$('nextDay1').addEventListener('click', ()=>{
  currentDate.setDate(currentDate.getDate()+1);
  onDateChange();
});
// 3Ïùº Ïù¥Îèô
$('prevDay').addEventListener('click', ()=>{
  currentDate.setDate(currentDate.getDate()-3);
  onDateChange();
});
$('nextDay').addEventListener('click', ()=>{
  currentDate.setDate(currentDate.getDate()+3);
  onDateChange();
});
// ÎÇ†Ïßú ÌÑ∞Ïπò ‚Üí 30Ïùº Î¶¨Ïä§Ìä∏ ÌîºÏª§
$dateDisplay.addEventListener('click', ()=> openDatePicker());

function openDatePicker(){
  const overlay = $('datePickerOverlay');
  const list = $('datePickerList');
  const today = new Date(); today.setHours(0,0,0,0);
  const selectedDk = dateKey(currentDate);
  const todayDk = dateKey(today);
  const empKeys = Object.keys(employees);

  let html = '<div class="dp-jump">';
  html += '<button onclick="jumpDate(-7)">‚óÄ 1Ï£º</button>';
  html += '<button onclick="jumpDate(0)">Ïò§Îäò</button>';
  html += '<button onclick="jumpDate(7)">1Ï£º ‚ñ∂</button>';
  html += '</div>';

  for(let i=0; i<30; i++){
    const d = new Date(today); d.setDate(d.getDate()+i);
    const dk = dateKey(d);
    const dow = DOW_KR[d.getDay()];
    const isToday = dk === todayDk;
    const isSelected = dk === selectedDk;
    const m = d.getMonth()+1, dd = d.getDate();
    // ÏöîÏïΩ: Í∑ºÎ¨¥ÏûêÏàò / Ìú¥Î¨¥Ïàò
    let workCount=0, offCount=0;
    empKeys.forEach(id => {
      if(isDayOff(id, dk)) offCount++;
      else {
        const s = weekSchedules[dk]?.[id] || (dk===dateKey(currentDate)?daySchedule[id]:null);
        if(s && s.start) workCount++;
      }
    });
    const cls = isToday ? 'dp-item today' : isSelected ? 'dp-item selected' : 'dp-item';
    const dowColor = d.getDay()===0?'#E74C3C':d.getDay()===6?'#45B7D1':'#9090A8';
    html += '<div class="'+cls+'" data-dk="'+dk+'">';
    html += '<span class="dp-dow" style="color:'+dowColor+';">'+dow+'</span>';
    html += '<span class="dp-date">'+m+'/'+dd+'</span>';
    html += '<span class="dp-summary">';
    if(workCount>0) html += '<span style="color:#2ECC71;">'+workCount+'Î™Ö</span> ';
    if(offCount>0) html += '<span style="color:#E74C3C;">Ìú¥'+offCount+'</span>';
    if(isToday) html += ' <span style="color:#FFD700;font-weight:700;">Ïò§Îäò</span>';
    html += '</span></div>';
  }
  list.innerHTML = html;
  overlay.classList.add('open');

  list.querySelectorAll('.dp-item').forEach(item => {
    item.addEventListener('click', ()=>{
      const parts = item.dataset.dk.split('-');
      currentDate = new Date(+parts[0], +parts[1]-1, +parts[2]);
      overlay.classList.remove('open');
      onDateChange();
    });
  });
  overlay.addEventListener('click', (e)=>{
    if(e.target === overlay) overlay.classList.remove('open');
  }, {once:true});
}
function jumpDate(days){
  if(days === 0){ currentDate = new Date(); }
  else { currentDate.setDate(currentDate.getDate()+days); }
  $('datePickerOverlay').classList.remove('open');
  onDateChange();
}

// Í≥†Ï†ï Ïä§ÏºÄÏ§Ñ Ïû¨Î∞∞Ïπò Î≤ÑÌäº
$('resetFixedBtn').addEventListener('click', ()=>{
  if(!confirm('Í≥†Ï†ïÍ∑ºÎ¨¥Ïûê Ïä§ÏºÄÏ§ÑÏùÑ Ï¥àÍ∏∞ÌôîÌïòÍ≥† Ïû¨Î∞∞ÏπòÌï©ÎãàÎã§.\n(Î≥ÄÏπô ÏßÅÏõê Ïä§ÏºÄÏ§ÑÏùÄ Ïú†ÏßÄ)')) return;
  const dk = dateKey(currentDate);
  resetToFixed(dk);
});

// ÌôïÏ†ï/ÏûëÏóÖÏ§ë ÌÜ†Í∏Ä
$('confirmDayBtn').addEventListener('click', ()=>{
  const dk = dateKey(currentDate);
  confirmedDays = lsLoadConfirmed();
  if(confirmedDays[dk]){
    delete confirmedDays[dk];
    showToast(dk+' ÏûëÏóÖÏ§ëÏúºÎ°ú Î≥ÄÍ≤Ω');
  } else {
    confirmedDays[dk] = true;
    showToast(dk+' ÌôïÏ†ï ÏôÑÎ£å');
  }
  lsSaveConfirmed(confirmedDays);
  fbPut('/workschedule/confirmed/'+dk, confirmedDays[dk]||null);
  updateConfirmBtn();
});

function updateConfirmBtn(){
  const dk = dateKey(currentDate);
  const btn = $('confirmDayBtn');
  if(confirmedDays[dk]){
    btn.textContent = 'ÌôïÏ†ï';
    btn.style.color = '#2ECC71';
    btn.style.borderColor = '#2ECC71';
    btn.style.background = '#2ECC7120';
  } else {
    btn.textContent = 'ÏûëÏóÖÏ§ë';
    btn.style.color = '#E67E22';
    btn.style.borderColor = '#E67E2255';
    btn.style.background = 'transparent';
  }
}

// ============================================================
// Layout Tab Switching
// ============================================================
const TAB_ORDER = ['list','vertical','horizontal','calendar'];
function switchTab(tabName){
  currentTab = tabName;
  document.querySelectorAll('.layout-tab').forEach(t => t.classList.toggle('active', t.dataset.tab===tabName));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  const panelMap = {list:'panelList',vertical:'panelVertical',calendar:'panelCalendar',horizontal:'panelHorizontal'};
  const panel = $(panelMap[tabName]);
  if(panel) panel.classList.add('active');
  renderCurrentTab();
}
document.querySelectorAll('.layout-tab').forEach(tab => {
  tab.addEventListener('click', ()=> switchTab(tab.dataset.tab));
});

// Ïä§ÏôÄÏù¥ÌîÑ ‚Üí ÎÇ†Ïßú Î≥ÄÍ≤Ω (Ï¢å=Îã§ÏùåÎÇ†, Ïö∞=Ïù¥Ï†ÑÎÇ†)
let swipeStartX=0, swipeStartY=0;
$('tabContent').addEventListener('touchstart', (e)=>{
  swipeStartX = e.touches[0].clientX;
  swipeStartY = e.touches[0].clientY;
}, {passive:true});
$('tabContent').addEventListener('touchend', (e)=>{
  const dx = e.changedTouches[0].clientX - swipeStartX;
  const dy = e.changedTouches[0].clientY - swipeStartY;
  if(Math.abs(dx) < 60 || Math.abs(dy) > Math.abs(dx)*0.7) return;
  if(dx < 0){ currentDate.setDate(currentDate.getDate()+1); onDateChange(); }
  else { currentDate.setDate(currentDate.getDate()-1); onDateChange(); }
}, {passive:true});

function renderCurrentTab(){
  if(currentTab==='list') renderListView();
  else if(currentTab==='vertical') renderTimeline();
  else if(currentTab==='calendar') renderCalendarView();
  else if(currentTab==='horizontal') renderHorizontalView();
}

// Calendar view renderer (ÎØ∏Îûò ÎÇ†ÏßúÎßå ÌëúÏãú)
function renderCalendarView(){
  const con = $('calendarContent');
  if(!con) return;
  const dk = dateKey(currentDate);
  const today = new Date();
  today.setHours(0,0,0,0);
  const y = currentDate.getFullYear(), m = currentDate.getMonth();
  const days = daysInMonth(y, m+1);
  const firstDow = new Date(y,m,1).getDay();
  const empKeys = Object.keys(employees);

  let html = '<div class="cal-grid">';
  ['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'].forEach(d => html+='<div class="cal-hdr">'+d+'</div>');

  for(let i=0;i<firstDow;i++) html+='<div class="cal-cell other"></div>';

  for(let d=1;d<=days;d++){
    const cellDate = new Date(y,m,d);
    const cdk = dateKey(cellDate);
    const isToday = cdk===dk;
    const isPast = cellDate < today;
    if(isPast){
      html+='<div class="cal-cell other" style="pointer-events:none;"><div class="cal-date" style="color:#707088;">'+d+'</div></div>';
      continue;
    }
    html+='<div class="cal-cell'+(isToday?' today':'')+'" data-date="'+cdk+'">';
    html+='<div class="cal-date" style="font-size:.7rem;font-weight:700;'+(cellDate.getDay()===0?'color:#E74C3C;':cellDate.getDay()===6?'color:#45B7D1;':'color:#E0E0EC;')+'">'+d+'<span style="font-size:.55rem;color:#707088;margin-left:2px;">'+DOW_KR[cellDate.getDay()]+'</span></div>';

    // Í∑ºÎ¨¥Ïûê ÏöîÏïΩ (ÏÉâÏÉÅ ÎèÑÌä∏ + Ïù¥Î¶Ñ)
    html+='<div class="cal-emp">';
    let empCount = 0, offCount = 0;
    empKeys.forEach(id => {
      const off = isDayOff(id, cdk);
      const sched = weekSchedules[cdk]?.[id] || (cdk===dk ? daySchedule[id] : null);
      if(off){
        offCount++;
        html+='<div style="color:#E74C3C;font-size:.5rem;font-weight:600;">'+shortName(employees[id].name)+' Ìú¥</div>';
      } else if(sched && sched.start){
        empCount++;
        const st = getShiftType(sched.start, sched.end);
        html+='<div style="color:'+st.color+';font-size:.5rem;font-weight:600;">'+shortName(employees[id].name)+' '+sched.start.replace(/^0/,'')+'-'+sched.end.replace(/^0/,'')+'</div>';
      }
    });
    if(empCount===0 && offCount===0){
      html+='<div style="color:#707088;font-size:.5rem;">ÎØ∏ÏûÖÎ†•</div>';
    }
    html+='</div></div>';
  }
  html+='</div>';
  con.innerHTML = html;

  con.querySelectorAll('.cal-cell[data-date]').forEach(cell => {
    cell.addEventListener('click', ()=>{
      const parts = cell.dataset.date.split('-');
      currentDate = new Date(+parts[0], +parts[1]-1, +parts[2]);
      onDateChange();
      document.querySelector('.layout-tab[data-tab="list"]').click();
    });
  });
}

// List view renderer ‚Äî Î≥¥Ï†ï Í∏∞Î∞ò Î¶¨Ïä§Ìä∏ (Î©îÏù∏ Î∑∞)
function renderListView(){
  const con = $('listContent');
  if(!con) return;
  const dk = dateKey(currentDate);
  const empKeys = Object.keys(employees);
  const m = currentDate.getMonth()+1, d = currentDate.getDate();
  const dow = DOW_KR[currentDate.getDay()];
  const confirmed = isConfirmed(dk);

  // Ï£ºÍ∞Ñ Ìú¥Î¨¥ ÎàÑÏ†ÅÏùº Í≥ÑÏÇ∞
  const weekOffCount = {};
  const mon = getMonday(currentDate);
  for(let i=0;i<7;i++){
    const wd = new Date(mon); wd.setDate(wd.getDate()+i);
    const wdk = dateKey(wd);
    empKeys.forEach(id => { if(isDayOff(id,wdk)) weekOffCount[id] = (weekOffCount[id]||0)+1; });
  }

  // Î∂ÑÎ•ò
  const working = [], offList = [], empty = [];
  let totalHours = 0, confirmedCount = 0, unconfirmedCount = 0;
  empKeys.forEach(id => {
    const emp = employees[id];
    const off = isDayOff(id, dk);
    const shift = daySchedule[id];
    if(off){ offList.push({id, emp}); return; }
    if(shift && shift.start){
      const st = getShiftStatus(dk, id);
      const fix = getFixedSchedule(emp.name);
      const isFixed = fix && fix.type==='fixed' && shift.start===fix.start && shift.end===fix.end;
      const hours = calcHours(shift.start, shift.end);
      totalHours += hours;
      if(st==='confirmed') confirmedCount++;
      else unconfirmedCount++; // auto + pending = ÎØ∏ÌôïÏ†ï
      working.push({id, emp, shift, status:st, isFixed, hours});
    } else {
      empty.push({id, emp});
    }
  });
  working.sort((a,b) => timeToMinutesFrom6(a.shift.start) - timeToMinutesFrom6(b.shift.start));

  let html = '<div style="padding:6px 8px;">';

  // === Ìó§Îçî (ÌôïÏ†ïÏùºÏùÄ Ï¥àÎ°ù ÌëúÏãú) ===
  const hdrBorder = confirmed ? 'border-bottom:2px solid '+C_OK+';' : 'border-bottom:1px solid #2E2E52;';
  const hdrDateC = confirmed ? C_OK : '#FFF';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;padding-bottom:5px;'+hdrBorder+'">';
  html += '<div>';
  html += '<span style="font-size:1rem;font-weight:800;color:'+hdrDateC+';">'+m+'/'+d+' '+dow+'</span>';
  if(confirmed) html += ' <span style="font-size:.6rem;color:'+C_OK+';">ÌôïÏ†ï</span>';
  html += '</div>';
  html += '<div style="display:flex;gap:4px;align-items:center;">';
  if(unconfirmedCount > 0){
    html += '<span onclick="confirmAllShifts()" style="font-size:.55rem;padding:3px 6px;border-radius:4px;background:'+C_OK+'22;color:'+C_OK+';cursor:pointer;font-weight:700;">Ï†ÑÏ≤¥ÌôïÏ†ï</span>';
  }
  html += '</div></div>';

  // === ÏßÑÌñâÎ•† Í≤åÏù¥ÏßÄ (Ï¥àÎ°ù+ÌöåÏÉâ 2ÌÜ§) ===
  const total = working.length + empty.length;
  const pctCf = total > 0 ? Math.round(confirmedCount/total*100) : 0;
  const pctRest = 100 - pctCf;

  html += '<div style="margin-bottom:6px;">';
  html += '<div style="display:flex;height:5px;border-radius:3px;overflow:hidden;background:'+C_BG+';">';
  if(pctCf > 0) html += '<div style="width:'+pctCf+'%;background:'+C_OK+';"></div>';
  if(pctRest > 0) html += '<div style="width:'+pctRest+'%;background:#2E2E52;"></div>';
  html += '</div>';
  html += '<div style="display:flex;gap:8px;margin-top:3px;font-size:.55rem;">';
  html += '<span style="color:'+C_OK+';font-weight:700;">ÌôïÏ†ï '+confirmedCount+'</span>';
  if(unconfirmedCount) html += '<span style="color:'+C_DEF+';font-weight:700;">ÎØ∏ÌôïÏ†ï '+unconfirmedCount+'</span>';
  if(empty.length) html += '<span style="color:#707088;">ÎØ∏ÏûÖÎ†• '+empty.length+'</span>';
  html += '<span style="color:#707088;margin-left:auto;">'+working.length+'Î™Ö '+totalHours.toFixed(1).replace('.0','')+'h</span>';
  if(offList.length) html += '<span style="color:'+C_OFF+';">Ìú¥'+offList.length+'</span>';
  html += '</div></div>';

  // === Í∑ºÎ¨¥Ïûê Î¶¨Ïä§Ìä∏ (Í≤åÏù¥ÏßÄ + Ï∂úÌá¥Í∑º ÌÖçÏä§Ìä∏ + ÏÉÅÌÉú Î≤ÑÌäº) ===
  const GAUGE_START = 6; // 06:00
  const GAUGE_END = 27; // 03:00 (27h Í∏∞Ï§Ä)
  const GAUGE_RANGE = GAUGE_END - GAUGE_START; // 21ÏãúÍ∞Ñ

  working.forEach(w => {
    const hasConflict = !!detectConflicts(empKeys, dk)[w.id];
    const roles = w.shift.role ? w.shift.role.split(',').filter(Boolean) : [];
    const roleHtml = roles.map(r => '<span style="color:'+(ROLE_COLORS[r]||'#9090A8')+';font-size:.6rem;font-weight:700;">'+(ROLE_LABELS[r]||r)+'</span>').join(' ');

    // Í≤åÏù¥ÏßÄ ÏúÑÏπò Í≥ÑÏÇ∞
    let sH = parseInt(w.shift.start.split(':')[0]), sM = parseInt(w.shift.start.split(':')[1]||0);
    let eH = parseInt(w.shift.end.split(':')[0]), eM = parseInt(w.shift.end.split(':')[1]||0);
    if(sH < 6) sH += 24;
    if(eH < 6) eH += 24;
    const startPct = Math.max(0, ((sH + sM/60) - GAUGE_START) / GAUGE_RANGE * 100);
    const endPct = Math.min(100, ((eH + eM/60) - GAUGE_START) / GAUGE_RANGE * 100);
    const widthPct = Math.max(1, endPct - startPct);

    // ÏÉÅÌÉú ÏÉâÏÉÅ: confirmedÎßå ÌôïÏ†ï, ÎÇòÎ®∏ÏßÄ(auto+pending)Îäî ÎØ∏ÌôïÏ†ï
    const isConfirmed = w.status==='confirmed';
    const stColor = isConfirmed ? C_OK : C_DEF;
    const stBg = isConfirmed ? C_OK+'10' : C_DEF+'08';
    const borderC = hasConflict ? C_OFF : stColor;

    // Ìå®ÌÑ¥ Ï†úÏïà
    const pattern = getPatternSuggestion(w.id, dk);
    const patternMatch = pattern && w.shift.start===pattern.start && w.shift.end===pattern.end;

    const barC = hasConflict ? C_OFF : stColor;
    const timeLabel = w.shift.start.replace(/^0/,'')+'-'+w.shift.end.replace(/^0/,'');

    html += '<div style="display:flex;align-items:center;gap:4px;margin-bottom:2px;padding:4px 6px;background:'+stBg+';border-left:3px solid '+borderC+';border-radius:6px;cursor:pointer;" data-empid="'+w.id+'">';
    // Ïù¥Î¶Ñ + Ï£ºÍ∞ÑÌú¥Î¨¥
    const wOff = weekOffCount[w.id]||0;
    html += '<span style="font-size:.8rem;font-weight:800;color:#FFF;min-width:38px;">'+w.emp.name+(wOff?'<span style="font-size:.55rem;color:'+C_OFF+';font-weight:600;">('+wOff+')</span>':'')+'</span>';
    // Ïó≠Ìï† (ÏÉâÏÉÅÌÖçÏä§Ìä∏, ÏûàÏùÑÎïåÎßå)
    if(roles.length) html += '<span style="font-size:.55rem;">'+roles.map(r=>'<span style="color:'+(ROLE_COLORS[r]||C_DEF)+';font-weight:700;">'+(ROLE_LABELS[r]||r)+'</span>').join(' ')+'</span>';
    // Í≤åÏù¥ÏßÄ (ÏãúÍ∞Ñ ÎÇ¥Ïû•)
    html += '<div style="position:relative;flex:1;height:18px;background:#1A1A30;border-radius:3px;overflow:hidden;">';
    html += '<div style="position:absolute;left:'+startPct+'%;width:'+widthPct+'%;top:1px;bottom:1px;background:'+barC+'40;border-radius:2px;border-left:2px solid '+barC+';"></div>';
    html += '<span style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:.55rem;color:#E0E0EC;font-weight:600;white-space:nowrap;text-shadow:0 0 3px #000;">'+timeLabel+' ('+w.hours+'h)</span>';
    html += '</div>';
    // ÏÉÅÌÉú Î≤ÑÌäº: confirmed=ÌôïÏ†ï(Ï¥àÎ°ù), Í∑∏Ïô∏=ÎØ∏ÌôïÏ†ï(ÌöåÏÉâ) ‚Äî ÌÑ∞ÏπòÎ°ú ÌÜ†Í∏Ä
    if(isConfirmed){
      html += '<span onclick="event.stopPropagation();setShiftStatus(\''+dk+'\',\''+w.id+'\',\'auto\')" style="font-size:.55rem;padding:2px 5px;border-radius:3px;cursor:pointer;background:'+C_OK+';color:#fff;font-weight:700;">ÌôïÏ†ï</span>';
    } else {
      html += '<span onclick="event.stopPropagation();setShiftStatus(\''+dk+'\',\''+w.id+'\',\'confirmed\')" style="font-size:.55rem;padding:2px 5px;border-radius:3px;cursor:pointer;background:#333;color:'+C_DEF+';font-weight:700;">ÎØ∏ÌôïÏ†ï</span>';
    }
    if(hasConflict) html += '<span style="font-size:.5rem;color:'+C_OFF+';font-weight:700;">!</span>';
    html += '</div>';
  });

  // === ÎØ∏ÏûÖÎ†• ÏßÅÏõê ===
  if(empty.length > 0){
    html += '<div style="margin-top:4px;padding-top:4px;border-top:1px solid #2E2E5240;">';
    html += '<div style="font-size:.6rem;color:'+C_DEF+';font-weight:700;margin-bottom:3px;padding-left:4px;border-left:2px solid '+C_DEF+';">ÎØ∏ÏûÖÎ†• ('+empty.length+'Î™Ö)</div>';
    empty.forEach(e => {
      const pattern = getPatternSuggestion(e.id, dk);
      html += '<div style="display:flex;align-items:center;gap:6px;padding:6px 8px;margin-bottom:2px;background:#1A1A30;border-radius:6px;border-left:3px solid #707088;cursor:pointer;" data-empid="'+e.id+'">';
      html += '<span style="font-size:.85rem;font-weight:800;color:#707088;min-width:44px;">'+e.emp.name+'</span>';
      if(pattern){
        html += '<span style="font-size:.65rem;color:'+C_OK+';">AIÏ∂îÏ≤ú '+pattern.start+'~'+pattern.end+'</span>';
        html += '<span onclick="event.stopPropagation();applyPatternSuggestion(\''+e.id+'\',\''+dk+'\')" style="font-size:.55rem;padding:2px 6px;border-radius:3px;background:'+C_OK+'33;color:'+C_OK+';cursor:pointer;font-weight:700;">Ï†ÅÏö©</span>';
      } else {
        html += '<span style="font-size:.7rem;color:#707088;">ÎØ∏ÏûÖÎ†•</span>';
      }
      html += '<span style="margin-left:auto;display:flex;gap:3px;">';
      html += '<span onclick="event.stopPropagation();toggleDayOffFromList(\''+e.id+'\')" style="font-size:.55rem;padding:2px 6px;border-radius:3px;background:#333;color:#E74C3C;cursor:pointer;font-weight:700;">Ìú¥</span>';
      html += '</span>';
      html += '</div>';
    });
    html += '</div>';
  }

  // === Ìú¥Î¨¥ ===
  if(offList.length > 0){
    html += '<div style="margin-top:4px;padding-top:4px;border-top:1px solid #2E2E5240;">';
    html += '<div style="font-size:.6rem;color:#E74C3C;font-weight:700;margin-bottom:3px;padding-left:4px;border-left:2px solid #E74C3C;">Ìú¥Î¨¥ ('+offList.length+'Î™Ö)</div>';
    offList.forEach(o => {
      html += '<div style="display:flex;align-items:center;gap:8px;padding:5px 8px;margin-bottom:2px;background:#E74C3C08;border-radius:6px;border-left:3px solid #E74C3C;cursor:pointer;" data-empid="'+o.id+'">';
      const oOff = weekOffCount[o.id]||0;
      html += '<span style="font-size:.8rem;font-weight:800;color:#E74C3C;">'+o.emp.name+(oOff?'<span style="font-size:.55rem;color:'+C_OFF+';font-weight:600;">('+oOff+')</span>':'')+'</span>';
      html += '<span style="font-size:.65rem;color:#E74C3C;">Ìú¥Î¨¥</span>';
      html += '<span onclick="event.stopPropagation();toggleDayOffFromList(\''+o.id+'\')" style="margin-left:auto;font-size:.55rem;padding:2px 6px;border-radius:3px;background:#333;color:#9090A8;cursor:pointer;font-weight:700;">Ìï¥Ï†ú</span>';
      html += '</div>';
    });
    html += '</div>';
  }

  html += '</div>';
  con.innerHTML = html;

  // ÌÑ∞Ïπò ‚Üí ÏàòÏ†ïÏ∞Ω
  con.querySelectorAll('[data-empid]').forEach(row => {
    row.addEventListener('click', (e)=>{
      if(e.target.closest('[onclick]')) return; // Î≤ÑÌäº ÌÅ¥Î¶≠ Î¨¥Ïãú
      openShiftModal(row.dataset.empid);
    });
  });
}

// ÎãπÏùº Ìú¥Î¨¥ ÌÜ†Í∏Ä (Î¶¨Ïä§Ìä∏ÏóêÏÑú ÏßÅÏ†ë)
function toggleDayOffFromList(empId){
  const dk = dateKey(currentDate);
  if(!dayoffs[empId]) dayoffs[empId] = {};
  if(dayoffs[empId][dk] === true){
    // Ìú¥Î¨¥ Ìï¥Ï†ú (false = ÏàòÎèôÌï¥Ï†ú, ÏûêÎèôÏÉùÏÑ± Î∞©ÏßÄ)
    dayoffs[empId][dk] = false;
    if(daySchedule[empId] && daySchedule[empId].dayoff) delete daySchedule[empId];
    const empName = employees[empId]?.name || '';
    const fix = FIXED_SCHEDULES[empName];
    if(fix && fix.type==='fixed' && fix.start){
      daySchedule[empId] = {start:fix.start, end:fix.end, role:fix.role};
      fbPut(FB_SCHEDULES+'/'+dk+'/'+empId, daySchedule[empId]);
    }
    lsSaveSchedule(dk, daySchedule);
    showToast('Ìú¥Î¨¥ Ìï¥Ï†ú');
  } else {
    // Ìú¥Î¨¥ ÏßÄÏ†ï
    dayoffs[empId][dk] = true;
    if(daySchedule[empId]){
      delete daySchedule[empId];
      lsSaveSchedule(dk, daySchedule);
      fbDelete(FB_SCHEDULES+'/'+dk+'/'+empId);
    }
    showToast('Ìú¥Î¨¥ ÏßÄÏ†ï');
  }
  lsSaveDayoffs();
  const dval = dayoffs[empId]?.[dk];
  fbPut(FB_DAYOFFS+'/'+empId+'/'+dk, dval === undefined ? null : dval);
  renderAll();
}

// Ï†ÑÏ≤¥ ÌôïÏ†ï
function confirmAllShifts(){
  const dk = dateKey(currentDate);
  Object.keys(employees).forEach(id => {
    if(daySchedule[id] && daySchedule[id].start && !isDayOff(id, dk)){
      shiftStatus[dk+'_'+id] = 'confirmed';
      recordPattern(id, dk, daySchedule[id]);
    }
  });
  lsSaveShiftStatus();
  renderAll();
}
// Ï†ÑÏ≤¥ Î≥¥Ï†ï(Î¶¨ÏÖã)
function resetAllShifts(){
  const dk = dateKey(currentDate);
  Object.keys(employees).forEach(id => {
    delete shiftStatus[dk+'_'+id];
  });
  lsSaveShiftStatus();
  renderAll();
}
// AI Ìå®ÌÑ¥ Ï∂îÏ≤ú Ï†ÅÏö©
function applyPatternSuggestion(empId, dk){
  const pattern = getPatternSuggestion(empId, dk);
  if(!pattern) return;
  const data = {start:pattern.start, end:pattern.end, role:pattern.role||''};
  daySchedule[empId] = data;
  lsSaveSchedule(dk, daySchedule);
  fbPut(FB_SCHEDULES+'/'+dk+'/'+empId, data);
  showToast('AI Ï∂îÏ≤ú Ï†ÅÏö©');
  renderAll();
}

// Horizontal view renderer
function renderHorizontalView(){
  const con = $('horizontalContent');
  if(!con) return;
  const dk = dateKey(currentDate);
  const empKeys = Object.keys(employees);

  // Ïó≠Ìï†Î≥Ñ Í∑∏Î£πÌôî
  const groups = {'Ï£ºÎ∞©':[], 'Ï∞®Î∞∞Îã¨':[], 'Ïò§ÌÜ†Î∞îÏù¥':[], 'ÎØ∏ÏßÄÏ†ï':[]};
  const offList = [];
  empKeys.forEach(id => {
    const emp = employees[id];
    const off = isDayOff(id, dk);
    const shift = daySchedule[id];
    if(off){ offList.push({id, emp}); return; }
    const roles = shift && shift.role ? shift.role.split(',').filter(Boolean) : [];
    let placed = false;
    // Ï£º Ïó≠Ìï† Í∏∞Ï§ÄÏúºÎ°ú Î∂ÑÎ•ò (Ï≤´Î≤àÏß∏ Ïó≠Ìï†)
    if(roles.includes('Ï∞®Î∞∞Îã¨')){ groups['Ï∞®Î∞∞Îã¨'].push({id, emp, shift}); placed = true; }
    else if(roles.includes('Ïò§ÌÜ†Î∞îÏù¥')){ groups['Ïò§ÌÜ†Î∞îÏù¥'].push({id, emp, shift}); placed = true; }
    if(roles.includes('Ï£ºÎ∞©') || !placed){ groups['Ï£ºÎ∞©'].push({id, emp, shift}); if(!placed) placed = true; }
    if(!placed) groups['ÎØ∏ÏßÄÏ†ï'].push({id, emp, shift});
  });

  let html = '';
  // hour labels row
  html += '<div class="ht-row" style="border-bottom:2px solid #2E2E52;">';
  html += '<div class="ht-name" style="font-size:.6rem;color:#707088;">Ïù¥Î¶Ñ</div>';
  html += '<div class="ht-bar" style="background:transparent;display:flex;align-items:center;">';
  for(let h=6;h<=27;h++){
    const rh = h>=24?h-24:h;
    if(h%2===0) html+='<span style="flex:1;font-size:.55rem;color:#707088;text-align:center;">'+pad(rh)+'</span>';
    else html+='<span style="flex:1;"></span>';
  }
  html += '</div></div>';

  // Ïó≠Ìï†Î≥Ñ ÏÑπÏÖò Î†åÎçî
  const roleEntries = [
    {key:'Ï£ºÎ∞©', label:'Ï£ºÎ∞©', color:'#E67E22'},
    {key:'Ï∞®Î∞∞Îã¨', label:'Ï∞®Î∞∞Îã¨', color:'#4ECDC4'},
    {key:'Ïò§ÌÜ†Î∞îÏù¥', label:'Î∞îÏù¥ÌÅ¨', color:'#FFD700'},
  ];

  roleEntries.forEach(role => {
    const members = groups[role.key];
    if(members.length === 0) return;
    // Ïó≠Ìï† Ìó§Îçî
    html += '<div style="display:flex;align-items:center;gap:6px;padding:2px 8px;background:#242444;border-left:3px solid '+role.color+';">';
    html += '<span style="font-size:.6rem;font-weight:700;color:'+role.color+';">'+role.label+'</span>';
    html += '<span style="font-size:.5rem;color:#9090A8;">'+members.length+'Î™Ö</span>';
    html += '</div>';

    members.forEach(m => {
      const shift = m.shift;
      const hasConflict = shift && shift.start ? !!detectConflicts(empKeys, dk)[m.id] : false;
      html += '<div class="ht-row" data-empid="'+m.id+'">';
      const htSt = m.shift && m.shift.start ? getShiftType(m.shift.start, m.shift.end) : SHIFT_TYPES['ÎØ∏ÏûÖÎ†•'];
      html += '<div class="ht-name" style="color:'+htSt.color+';">'+m.emp.name+'</div>';
      html += '<div class="ht-bar">';
      html += '<div class="ht-hours">';
      for(let h=6;h<=27;h++) html+='<span></span>';
      html += '</div>';
      if(shift && shift.start && shift.end){
        const left = timeToPercent(shift.start);
        const right = timeToPercent(shift.end);
        let width = right - left;
        if(width<=0) width+=100;
        const roles = shift.role ? shift.role.split(',').filter(Boolean) : [];
        const roleHtml = roles.map(r => '<span style="color:'+(ROLE_COLORS[r]||'#fff')+';">'+(ROLE_LABELS[r]||r)+'</span>').join(' ');
        const stBar = getShiftType(shift.start, shift.end);
        const barBg = hasConflict ? '#E74C3C66' : stBar.color+'44';
        const barBorder = hasConflict ? 'border:1px solid #E74C3C;' : '';
        html += '<div class="ht-fill" style="left:'+left+'%;width:'+Math.min(width,100-left)+'%;background:'+barBg+';'+barBorder+'">';
        html += '<span style="font-size:.55rem;">'+shift.start.replace(/^0/,'')+'-'+shift.end.replace(/^0/,'')+'</span>';
        html += ' <span style="font-size:.5rem;">'+roleHtml+'</span>';
        html += '</div>';
      } else {
        html += '<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#707088;font-size:.6rem;">ÎØ∏ÏûÖÎ†•</div>';
      }
      html += '</div></div>';
    });
  });

  // Ìú¥Î¨¥Ïûê ÏÑπÏÖò
  if(offList.length > 0){
    html += '<div style="display:flex;align-items:center;gap:6px;padding:2px 8px;background:#242444;border-left:3px solid #E74C3C;">';
    html += '<span style="font-size:.6rem;font-weight:700;color:#E74C3C;">Ìú¥Î¨¥</span>';
    html += '<span style="font-size:.5rem;color:#9090A8;">'+offList.length+'Î™Ö</span>';
    html += '</div>';
    offList.forEach(o => {
      html += '<div class="ht-row" style="opacity:.4;">';
      html += '<div class="ht-name" style="color:'+(o.emp.color||'#FFFFFF')+';">'+o.emp.name+'</div>';
      html += '<div class="ht-bar">';
      html += '<div class="ht-hours">';
      for(let h=6;h<=27;h++) html+='<span></span>';
      html += '</div>';
      html += '<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#E74C3C;font-size:.65rem;font-weight:600;">Ìú¥Î¨¥</div>';
      html += '</div></div>';
    });
  }

  con.innerHTML = html;

  // tap row to edit
  con.querySelectorAll('.ht-row[data-empid]').forEach(row => {
    row.addEventListener('click', ()=> openShiftModal(row.dataset.empid));
  });
}

// ============================================================
// Refresh Button
// ============================================================
$('refreshBtn').addEventListener('click', ()=>{
  showToast('ÏÉàÎ°úÍ≥†Ïπ®...');
  location.reload();
});

// ============================================================
// Contact Import (NativeBridge or Contact Picker API)
// ============================================================
$('contactImportBtn').addEventListener('click', async()=>{
  let contacts = null;

  // 1) Try NativeBridge (Ïï± ÎÇ¥)
  if(window.NativeBridge && window.NativeBridge.getContacts){
    try{
      const raw = window.NativeBridge.getContacts();
      contacts = JSON.parse(raw);
    }catch(e){ console.error('NativeBridge contacts error',e); }
  }

  // 2) Fallback: Contact Picker API (Chrome/Ïõπ)
  if(!contacts && 'contacts' in navigator && 'ContactsManager' in window){
    try{
      const props = ['name','tel'];
      const opts = {multiple:true};
      const picked = await navigator.contacts.select(props, opts);
      contacts = picked.map(c => ({
        name: (c.name && c.name[0]) || '',
        phone: (c.tel && c.tel[0]) || ''
      }));
    }catch(e){
      if(e.name !== 'TypeError') console.error('Contact Picker error',e);
    }
  }

  if(!contacts || contacts.length === 0){
    showToast('Ïó∞ÎùΩÏ≤òÎ•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§');
    return;
  }

  // Show selection UI
  openContactPicker(contacts);
});

function openContactPicker(contacts){
  // Reuse empModal body for contact selection
  const $list = $('empList');
  $list.innerHTML = '<div style="padding:8px 0;font-size:.85rem;color:#FFD700;font-weight:600;">Ïó∞ÎùΩÏ≤ò ÏÑ†ÌÉù (ÌÉ≠ÌïòÏó¨ Ï∂îÍ∞Ä)</div>';

  const existingNames = new Set(Object.values(employees).map(e => e.name));

  contacts.forEach(c => {
    if(!c.name) return;
    const item = document.createElement('div');
    item.className = 'emp-list-item';
    const alreadyExists = existingNames.has(c.name);
    item.innerHTML =
      '<div class="emp-dot" style="background:'+(alreadyExists?'#2ECC71':'#9090A8')+'"></div>'+
      '<div class="emp-info">'+
        '<div class="name">'+c.name+'</div>'+
        '<div class="detail">'+(c.phone||'Ï†ÑÌôîÏóÜÏùå')+(alreadyExists?' (Îì±Î°ùÎê®)':'')+'</div>'+
      '</div>'+
      (alreadyExists ? '' : '<button class="btn btn-sm btn-accent" data-cname="'+c.name.replace(/"/g,'&quot;')+'" data-cphone="'+(c.phone||'').replace(/"/g,'&quot;')+'">Ï∂îÍ∞Ä</button>');
    $list.appendChild(item);
  });

  // Back button
  const backBtn = document.createElement('button');
  backBtn.className = 'btn';
  backBtn.style.cssText = 'width:100%;margin-top:8px;';
  backBtn.textContent = 'ÎèåÏïÑÍ∞ÄÍ∏∞';
  backBtn.addEventListener('click', ()=> renderEmpList());
  $list.appendChild(backBtn);

  // Add button handlers
  $list.querySelectorAll('[data-cname]').forEach(btn => {
    btn.addEventListener('click', async()=>{
      const name = btn.dataset.cname;
      const phone = btn.dataset.cphone;
      const colorIdx = Object.keys(employees).length % PRESET_COLORS.length;
      const data = {
        name: name,
        phone: phone,
        color: PRESET_COLORS[colorIdx],
        role: '',
        hourlyRate: 0,
        maxHours: 40
      };
      const id = 'emp' + Date.now();
      employees[id] = data;
      lsSaveEmployees(employees);
      const ok = await fbPut(FB_EMPLOYEES+'/'+id, data);
      if(ok){
        btn.textContent = 'ÏôÑÎ£å';
        btn.disabled = true;
        btn.style.opacity = '.5';
        showToast(name+' Ï∂îÍ∞ÄÎê®');
        renderAll();
      }
    });
  });
}

// ============================================================
// Collapsible sections (localStorage persistence)
// ============================================================
function setupCollapsible(toggleId, arrowId, bodyId, storageKey, defaultOpen){
  const body = $(bodyId);
  const arrow = $(arrowId);
  const stored = localStorage.getItem(storageKey);
  const isOpen = stored !== null ? stored === 'true' : defaultOpen;
  if(isOpen){
    body.classList.add('open');
    arrow.classList.add('open');
  }
  $(toggleId).addEventListener('click', ()=>{
    const open = body.classList.toggle('open');
    arrow.classList.toggle('open', open);
    localStorage.setItem(storageKey, open);
  });
}

setupCollapsible('weekToggle','weekArrow','weekBody','ws_week_open', false);
setupCollapsible('infoToggle','infoArrow','infoBody','ws_info_open', false);
setupCollapsible('aiToggle','aiArrow','aiBody','ws_ai_open', false);
setupCollapsible('shareToggle','shareArrow','shareBody','ws_share_open', false);

// ============================================================
// Share / Image
// ============================================================
$('shareImageBtn').addEventListener('click', async()=>{
  showToast('Ï∫°Ï≤ò Ï§ë...');
  try{
    const canvas = await html2canvas($('timelineSection'),{
      backgroundColor:'#1A1A30',
      scale:2,
      useCORS:true,
      logging:false
    });
    const base64 = canvas.toDataURL('image/png');
    if(window.NativeBridge && window.NativeBridge.shareImage){
      window.NativeBridge.shareImage(base64);
    } else {
      const link = document.createElement('a');
      const m = currentDate.getMonth()+1;
      const d = currentDate.getDate();
      link.download = 'Í∑ºÎ¨¥Ìëú_'+m+'Ïõî'+d+'Ïùº.png';
      link.href = base64;
      link.click();
      showToast('Ïù¥ÎØ∏ÏßÄ Îã§Ïö¥Î°úÎìú ÏôÑÎ£å');
    }
  }catch(e){
    console.error('html2canvas error',e);
    showToast('Ï∫°Ï≤ò Ïã§Ìå®');
  }
});

$('shareTextBtn').addEventListener('click', ()=>{
  const empKeys = Object.keys(employees);
  const m = currentDate.getMonth()+1;
  const d = currentDate.getDate();
  const dow = DOW_KR[currentDate.getDay()];
  let text = 'Í∑ºÎ¨¥Ìëú '+m+'/'+d+' ('+dow+')\n';
  text += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
  let hasShift = false;
  empKeys.forEach(empId => {
    const emp = employees[empId];
    const shift = daySchedule[empId];
    if(shift && shift.start){
      text += emp.name+': '+shift.start+'~'+shift.end;
      if(shift.role) text += ' ('+shift.role+')';
      text += ' ['+calcHours(shift.start,shift.end)+'h]\n';
      hasShift = true;
    }
  });
  if(!hasShift) text += '(Í∑ºÎ¨¥ ÏóÜÏùå)\n';

  if(window.NativeBridge && window.NativeBridge.shareText){
    window.NativeBridge.shareText(text);
  } else if(navigator.clipboard){
    navigator.clipboard.writeText(text).then(()=> showToast('ÌÖçÏä§Ìä∏ Î≥µÏÇ¨Îê®'));
  } else {
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('ÌÖçÏä§Ìä∏ Î≥µÏÇ¨Îê®');
  }
});

$('copyUrlBtn').addEventListener('click', ()=>{
  const url = window.location.href;
  if(navigator.clipboard){
    navigator.clipboard.writeText(url).then(()=> showToast('URL Î≥µÏÇ¨Îê®'));
  } else {
    const ta = document.createElement('textarea');
    ta.value = url;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('URL Î≥µÏÇ¨Îê®');
  }
});

// ============================================================
// Gemini AI Integration
// ============================================================
const GEMINI_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
let geminiKey = '';

function loadAiKey(){
  // Priority 1: localStorage
  let k = localStorage.getItem('ws_gemini_key') || '';
  // Priority 2: Firebase (BankTotal shared key)
  if(!k){
    fetch(FB_BASE+'/banktotal/settings/gemini_key.json')
      .then(r=>r.json())
      .then(d=>{
        if(d && typeof d === 'string'){
          geminiKey = d;
          localStorage.setItem('ws_gemini_key', d);
        }
      }).catch(()=>{});
  } else {
    geminiKey = k;
  }
  // Also refresh from Firebase in background
  if(k){
    fetch(FB_BASE+'/banktotal/settings/gemini_key.json')
      .then(r=>r.json())
      .then(d=>{
        if(d && typeof d === 'string' && d !== k){
          geminiKey = d;
          localStorage.setItem('ws_gemini_key', d);
        }
      }).catch(()=>{});
  }
}

async function callGemini(prompt){
  if(!geminiKey) loadAiKey();
  if(!geminiKey) throw new Error('Gemini API ÌÇ§ ÏóÜÏùå');
  const r = await fetch(GEMINI_URL+'?key='+geminiKey,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})
  });
  if(!r.ok){
    const err = await r.json().catch(()=>({}));
    throw new Error(err.error?.message || 'Gemini API Ïò§Î•ò '+r.status);
  }
  const d = await r.json();
  return d.candidates?.[0]?.content?.parts?.[0]?.text || '';
}

// ============================================================
// Weather & Sports (Gemini)
// ============================================================
let weatherCache = {date:'', data:''};
let sportsCache = {date:'', data:''};

async function loadWeatherAndSports(){
  const today = new Date();
  const todayStr = dateStr(today);
  const $weather = $('weatherInfo');
  const $sports = $('sportsInfo');

  // Weather
  if(weatherCache.date === todayStr && weatherCache.data){
    $weather.innerHTML = weatherCache.data;
  } else {
    try{
      const wPrompt = 'Ïò§Îäò ÎÇ†Ïßú: '+todayStr+'. Í≤ΩÍ∏∞ÎèÑ Ïù¥Ï≤úÏãú Ïò§Îäò ÎÇ†Ïî®Î•º ÌïúÏ§ÑÎ°ú ÏïåÎ†§Ï§ò. Í∏∞Ïò®, Í∞ïÏàòÌôïÎ•†, ÎπÑ/Îàà/Í≤∞Îπô Ïó¨Î∂ÄÎßå. Î∞∞Îã¨Ïóê ÏòÅÌñ• ÏûàÏúºÎ©¥ "Î∞∞Îã¨Ï£ºÏùò" Ï∂îÍ∞Ä. 50Ïûê Ïù¥ÎÇ¥. ÏàúÏàò ÌÖçÏä§Ìä∏Îßå (ÎßàÌÅ¨Îã§Ïö¥ Í∏àÏßÄ).';
      const wResult = await callGemini(wPrompt);
      const wClean = wResult.replace(/\*/g,'').replace(/\n/g,' ').trim().substring(0,80);
      weatherCache = {date:todayStr, data:wClean};
      localStorage.setItem('ws_weather_cache', JSON.stringify(weatherCache));
      $weather.innerHTML = wClean;
    }catch(e){
      const cached = localStorage.getItem('ws_weather_cache');
      if(cached){
        try{
          const c = JSON.parse(cached);
          $weather.innerHTML = c.data || '<span class="info-placeholder">ÎÇ†Ïî® Î°úÎî© Ïã§Ìå®</span>';
        }catch(x){ $weather.innerHTML = '<span class="info-placeholder">ÎÇ†Ïî® Î°úÎî© Ïã§Ìå®</span>'; }
      } else {
        $weather.innerHTML = '<span class="info-placeholder">ÎÇ†Ïî® Î°úÎî© Ïã§Ìå®</span>';
      }
    }
  }

  // Sports (Í≤ΩÍ∏∞ ÏóÜÎäî ÎÇ†Ïóî ÌëúÍ∏∞ X)
  const $sportsRow = $sports.closest('.info-row');
  if(sportsCache.date === todayStr && sportsCache.data){
    if(sportsCache.data.includes('Í≤ΩÍ∏∞ÏóÜÏùå') || sportsCache.data.includes('ÏóÜÏùå')){
      if($sportsRow) $sportsRow.style.display = 'none';
    } else {
      if($sportsRow) $sportsRow.style.display = '';
      $sports.innerHTML = sportsCache.data;
    }
  } else {
    try{
      const sPrompt = 'Ïò§Îäò ÎÇ†Ïßú: '+todayStr+'. Ïò§Îäò/ÎÇ¥Ïùº Ï§ë ÌïúÍµ≠ Ïä§Ìè¨Ï∏† Í≤ΩÍ∏∞ ÏùºÏ†ï ÏïåÎ†§Ï§ò. KBO(ÌîÑÎ°úÏïºÍµ¨), ÌïúÍµ≠ Íµ≠Í∞ÄÎåÄÌëú Ï∂ïÍµ¨, Ï±îÌîºÏñ∏Ïä§Î¶¨Í∑∏Îßå. Í≤ΩÍ∏∞ ÏóÜÏúºÎ©¥ "Í≤ΩÍ∏∞ÏóÜÏùå". Í∞Å Í≤ΩÍ∏∞ ÌåÄ+ÏãúÍ∞ÑÎßå ÌïúÏ§ÑÏî©. 80Ïûê Ïù¥ÎÇ¥. ÏàúÏàò ÌÖçÏä§Ìä∏Îßå (ÎßàÌÅ¨Îã§Ïö¥ Í∏àÏßÄ).';
      const sResult = await callGemini(sPrompt);
      const sClean = sResult.replace(/\*/g,'').replace(/\n/g,' | ').trim().substring(0,120);
      sportsCache = {date:todayStr, data:sClean};
      localStorage.setItem('ws_sports_cache', JSON.stringify(sportsCache));
      if(sClean.includes('Í≤ΩÍ∏∞ÏóÜÏùå') || sClean.includes('ÏóÜÏùå')){
        if($sportsRow) $sportsRow.style.display = 'none';
      } else {
        if($sportsRow) $sportsRow.style.display = '';
        $sports.innerHTML = sClean;
      }
    }catch(e){
      if($sportsRow) $sportsRow.style.display = 'none';
    }
  }
}

// ============================================================
// Logistics Check (min 2 people, 3 after 16:30)
// ============================================================
function checkLogistics(){
  // Î¨ºÎ•ò Ï≤¥ÌÅ¨ ‚Üí Ïó≠Ìï†Î≥Ñ Ïª§Î≤ÑÎ¶¨ÏßÄ Î∑∞Ïóê ÌÜµÌï©Îê®
}

// ============================================================
// AI Scheduling Chat
// ============================================================
let aiProcessing = false;

function buildScheduleContext(targetDates){
  const empKeys = Object.keys(employees);
  let ctx = '## ÏßÅÏõê Î™©Î°ù\n';
  empKeys.forEach(id => {
    const e = employees[id];
    ctx += '- '+e.name+' (ID:'+id+', Ïó≠Ìï†:'+( e.role||'ÎØ∏ÏßÄÏ†ï')+', Ï£ºÍ∞ÑÏµúÎåÄ:'+(e.maxHours||40)+'h)\n';
  });
  ctx += '\n## ÌòÑÏû¨ Ïä§ÏºÄÏ§Ñ\n';
  if(targetDates && targetDates.length > 0){
    targetDates.forEach(dk => {
      const sched = weekSchedules[dk] || daySchedule;
      ctx += dk+': ';
      const parts = [];
      empKeys.forEach(id => {
        const s = (dk === dateKey(currentDate)) ? daySchedule[id] : (weekSchedules[dk]||{})[id];
        if(s && s.start) parts.push(employees[id].name+' '+s.start+'~'+s.end+(s.role?' ('+s.role+')':''));
      });
      ctx += parts.length > 0 ? parts.join(', ') : '(ÏóÜÏùå)';
      ctx += '\n';
    });
  }
  ctx += '\n## Í∑úÏπô\n';
  ctx += '- ÏòÅÏóÖÏãúÍ∞Ñ: 10:00~03:00 (ÏÉàÎ≤Ω)\n';
  ctx += '- ÏµúÏÜå Ïù∏Ïõê: 10:00~16:00 2Î™Ö, 16:00~03:00 3Î™Ö\n';
  ctx += '- Î∞∞Îã¨ Ïó≠Ìï† ÌïÑÏöî (16:30 Ïù¥ÌõÑ Î¨ºÎ•ò)\n';
  ctx += '- Í∑ºÎ¨¥ÏãúÍ∞Ñ: 06:00~03:00 Î≤îÏúÑ, 30Î∂Ñ Îã®ÏúÑ\n';
  ctx += '- ÏãúÍ∞Ñ ÌòïÏãù: HH:MM (24ÏãúÍ∞Ñ)\n';
  if(weatherCache.data) ctx += '\n## ÎÇ†Ïî®: '+weatherCache.data+'\n';
  if(sportsCache.data) ctx += '\n## Í≤ΩÍ∏∞ÏùºÏ†ï: '+sportsCache.data+'\n';
  return ctx;
}

function getTargetDates(userMsg){
  const today = new Date();
  const todayDk = dateStr(today);
  if(/Ïù¥Î≤à\s*Ï£º|Ïù¥Î≤àÏ£º/.test(userMsg)){
    const mon = getMonday(today);
    const dates = [];
    for(let i=0;i<7;i++){
      const d = new Date(mon);
      d.setDate(d.getDate()+i);
      dates.push(dateStr(d));
    }
    return dates;
  }
  if(/ÎÇ¥Ïùº/.test(userMsg)){
    const tm = new Date(today);
    tm.setDate(tm.getDate()+1);
    return [dateStr(tm)];
  }
  if(/Î™®Î†à|Î™®Îûò/.test(userMsg)){
    const tm = new Date(today);
    tm.setDate(tm.getDate()+2);
    return [dateStr(tm)];
  }
  // Default: current displayed date
  return [dateKey(currentDate)];
}

async function sendAiMessage(userMsg){
  if(aiProcessing) return;
  if(!userMsg.trim()) return;
  if(!geminiKey){ showToast('Gemini API ÌÇ§ Î°úÎî©Ï§ë...'); loadAiKey(); return; }
  aiProcessing = true;

  const $chat = $('aiChatList');
  // User message
  const userDiv = document.createElement('div');
  userDiv.className = 'ai-msg user';
  userDiv.textContent = userMsg;
  $chat.appendChild(userDiv);

  // Loading
  const loadDiv = document.createElement('div');
  loadDiv.className = 'ai-msg ai loading';
  loadDiv.textContent = 'ÏÉùÍ∞ÅÏ§ë...';
  $chat.appendChild(loadDiv);
  $chat.scrollTop = $chat.scrollHeight;

  try{
    const targetDates = getTargetDates(userMsg);
    const ctx = buildScheduleContext(targetDates);

    const prompt = `ÎÑàÎäî Îß§Ïû• Í∑ºÎ¨¥ Ïä§ÏºÄÏ§Ñ Í¥ÄÎ¶¨ AIÏïº. ÌïúÍµ≠Ïñ¥Î°ú ÎãµÎ≥ÄÌï¥.

${ctx}

## ÏöîÏ≤≠
${userMsg}

## ÏùëÎãµ ÌòïÏãù
Ïä§ÏºÄÏ§Ñ Î∞∞Ïπò ÏöîÏ≤≠Ïù¥Î©¥ Î∞òÎìúÏãú ÏïÑÎûò JSON Î∞∞Ïó¥ÏùÑ Ìè¨Ìï®Ìï¥:
\`\`\`json
[{"date":"YYYY-MM-DD","empId":"emp1","start":"HH:MM","end":"HH:MM","role":"Ï£ºÎ∞©|Î∞∞Îã¨|Ïò§Ï†Ñ"}]
\`\`\`
Ïä§ÏºÄÏ§Ñ Î∞∞ÏπòÍ∞Ä ÏïÑÎãå ÏßàÎ¨∏Ïù¥Î©¥ ÌÖçÏä§Ìä∏Î°ú ÎãµÎ≥ÄÌï¥.
ÎãµÎ≥ÄÏùÄ Í∞ÑÍ≤∞ÌïòÍ≤å (200Ïûê Ïù¥ÎÇ¥ ÏÑ§Î™Ö + JSON).`;

    const result = await callGemini(prompt);
    $chat.removeChild(loadDiv);

    // Parse response
    const aiDiv = document.createElement('div');
    aiDiv.className = 'ai-msg ai';

    // Extract JSON if present
    const jsonMatch = result.match(/```json\s*([\s\S]*?)```/);
    let scheduleData = null;
    if(jsonMatch){
      try{
        scheduleData = JSON.parse(jsonMatch[1].trim());
      }catch(e){ /* not valid JSON */ }
    }

    // Clean text (remove json block)
    let textPart = result.replace(/```json[\s\S]*?```/g, '').replace(/\*/g,'').trim();
    if(textPart.length > 300) textPart = textPart.substring(0,300)+'...';

    let html = textPart.replace(/\n/g,'<br>');
    if(scheduleData && Array.isArray(scheduleData) && scheduleData.length > 0){
      html += '<br><br>';
      scheduleData.forEach(s => {
        const emp = employees[s.empId];
        const name = emp ? emp.name : s.empId;
        html += '<span style="color:#FFD700">'+s.date+'</span> '+name+' '+s.start+'~'+s.end+(s.role?' ('+s.role+')':'')+' <br>';
      });
      html += '<button class="ai-apply-btn" id="aiApplyBtn_'+(+new Date())+'">Ï†ÅÏö©ÌïòÍ∏∞</button>';
    }
    aiDiv.innerHTML = html;
    $chat.appendChild(aiDiv);
    // Attach apply handler via JS (not onclick attribute ‚Äî safer)
    if(scheduleData){
      const applyBtn = aiDiv.querySelector('.ai-apply-btn');
      if(applyBtn){
        const capturedData = scheduleData;
        applyBtn.addEventListener('click', ()=> window.applyAiSchedule(capturedData));
      }
    }
  }catch(e){
    $chat.removeChild(loadDiv);
    const errDiv = document.createElement('div');
    errDiv.className = 'ai-msg ai';
    errDiv.style.color = '#E74C3C';
    errDiv.textContent = 'AI Ïò§Î•ò: '+e.message;
    $chat.appendChild(errDiv);
  }
  $chat.scrollTop = $chat.scrollHeight;
  aiProcessing = false;
}

// Global: apply AI schedule
window.applyAiSchedule = async function(data){
  if(!Array.isArray(data)) return;
  let applied = 0;
  for(const s of data){
    if(!s.date || !s.empId || !s.start || !s.end) continue;
    const shiftData = {start:s.start, end:s.end, role:s.role||''};
    // localStorage first
    const lsData = lsLoadSchedule(s.date) || {};
    lsData[s.empId] = shiftData;
    lsSaveSchedule(s.date, lsData);
    if(s.date === dateKey(currentDate)){
      daySchedule[s.empId] = shiftData;
    }
    const ok = await fbPut(FB_SCHEDULES+'/'+s.date+'/'+s.empId, shiftData);
    if(ok) applied++;
  }
  renderAll();
  loadWeekSchedules();
  showToast(applied+'Í±¥ Ï†ÅÏö© ÏôÑÎ£å');
};

// AI event listeners
$('aiSendBtn').addEventListener('click', ()=>{
  const input = $('aiInput');
  sendAiMessage(input.value);
  input.value = '';
});
$('aiInput').addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){
    e.preventDefault();
    const input = $('aiInput');
    sendAiMessage(input.value);
    input.value = '';
  }
});
document.querySelectorAll('.ai-quick').forEach(btn => {
  btn.addEventListener('click', ()=> sendAiMessage(btn.dataset.prompt));
});

// ============================================================
// .ics Calendar Generation (iPhone + Galaxy compatible)
// ============================================================
function generateICS(events, filename){
  let ics = 'BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//WorkSchedule//KR\r\nCALSCALE:GREGORIAN\r\nMETHOD:PUBLISH\r\n';
  events.forEach(ev => {
    const [y,mo,d] = ev.date.split('-');
    const [sh,sm] = ev.start.split(':').map(Number);
    const [eh,em] = ev.end.split(':').map(Number);
    // Handle overnight shifts (end hour < start hour means next day)
    let endDate = ev.date;
    if(eh < sh || (eh === sh && em < sm)){
      const nd = new Date(parseInt(y), parseInt(mo)-1, parseInt(d));
      nd.setDate(nd.getDate()+1);
      endDate = dateStr(nd);
    }
    const [ey,emo,ed] = endDate.split('-');
    const dtStart = y+mo+d+'T'+pad(sh)+pad(sm)+'00';
    const dtEnd = ey+emo+ed+'T'+pad(eh)+pad(em)+'00';
    const uid = ev.date+'-'+ev.empId+'-'+(+new Date())+'@workschedule';
    ics += 'BEGIN:VEVENT\r\n';
    ics += 'UID:'+uid+'\r\n';
    ics += 'DTSTART;TZID=Asia/Seoul:'+dtStart+'\r\n';
    ics += 'DTEND;TZID=Asia/Seoul:'+dtEnd+'\r\n';
    ics += 'SUMMARY:'+ev.summary+'\r\n';
    if(ev.description) ics += 'DESCRIPTION:'+ev.description+'\r\n';
    ics += 'END:VEVENT\r\n';
  });
  ics += 'END:VCALENDAR\r\n';
  downloadBlob(ics, filename, 'text/calendar;charset=utf-8');
}

function downloadBlob(content, filename, mime){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(()=> URL.revokeObjectURL(url), 1000);
}

function buildCalButtons(){
  const $btns = $('calBtns');
  if(!$btns) return;
  $btns.innerHTML = '';
  const empKeys = Object.keys(employees);
  empKeys.forEach(empId => {
    const emp = employees[empId];
    const shift = daySchedule[empId];
    if(!shift || !shift.start) return;
    const btn = document.createElement('button');
    btn.className = 'cal-btn';
    btn.innerHTML = '<div class="cdot" style="background:'+(emp.color||'#9090A8')+'"></div>'+emp.name;
    btn.addEventListener('click', ()=>{
      const dk = dateKey(currentDate);
      const events = [{
        date:dk, empId:empId,
        start:shift.start, end:shift.end,
        summary:'Í∑ºÎ¨¥ - '+emp.name,
        description:'Ïó≠Ìï†: '+(shift.role||'ÎØ∏ÏßÄÏ†ï')+', '+shift.start+'~'+shift.end
      }];
      const m = currentDate.getMonth()+1;
      const d = currentDate.getDate();
      generateICS(events, emp.name+'_'+m+'Ïõî'+d+'Ïùº.ics');
      showToast(emp.name+' Ï∫òÎ¶∞Îçî Îã§Ïö¥Î°úÎìú');
    });
    $btns.appendChild(btn);
  });
}

$('calAllBtn').addEventListener('click', ()=>{
  const empKeys = Object.keys(employees);
  const events = [];
  const dk = dateKey(currentDate);
  empKeys.forEach(empId => {
    const emp = employees[empId];
    const shift = daySchedule[empId];
    if(!shift || !shift.start) return;
    events.push({
      date:dk, empId:empId,
      start:shift.start, end:shift.end,
      summary:'Í∑ºÎ¨¥ - '+emp.name,
      description:'Ïó≠Ìï†: '+(shift.role||'ÎØ∏ÏßÄÏ†ï')+', '+shift.start+'~'+shift.end
    });
  });
  if(events.length === 0){ showToast('Ïò§Îäò Í∑ºÎ¨¥ ÏóÜÏùå'); return; }
  const m = currentDate.getMonth()+1;
  const d = currentDate.getDate();
  generateICS(events, 'Í∑ºÎ¨¥Ìëú_'+m+'Ïõî'+d+'Ïùº.ics');
  showToast('Ï†ÑÏ≤¥ Ï∫òÎ¶∞Îçî Îã§Ïö¥Î°úÎìú');
});

// ============================================================
// Visibility change handler (foreground return)
// ============================================================
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState === 'visible'){
    connectSSE();
    loadData();
    loadWeatherAndSports();
  }
});

// ============================================================
// Close modals on overlay click
// ============================================================
[$shiftModal, $monthModal, $empModal, $empEditModal].forEach(modal => {
  modal.addEventListener('click', (e)=>{
    if(e.target === modal) closeModal(modal);
  });
});

// ============================================================
// Init
// ============================================================
function init(){
  currentDate = new Date();
  updateDateDisplay();
  buildTimeSelects();
  loadAiKey();
  loadDayoffs();
  loadData().then(()=>{
    // Load weather after data + key ready
    setTimeout(()=>{
      loadHourlyWeather().then(()=> renderAll());
      loadWeatherAndSports();
    }, 1500);
  });
  connectSSE();
}

init();

})();
</script>
</body>
</html>
